<!DOCTYPE html>
<html lang="he" dir="rtl" class="dark">
<head>
    <script>(function(firebaseConfig, initialAuthToken, appId) {
        window.__firebase_config = firebaseConfig;
        window.__initial_auth_token = initialAuthToken;
        window.__app_id = appId;
    })("{\n  \"apiKey\": \"AIzaSyCwpscqDo9zWFbwrp1--3bk50xdg0ZgDok\",\n  \"authDomain\": \"project-sentinel-command-14e19.firebaseapp.com\",\n  \"projectId\": \"project-sentinel-command-14e19\",\n  \"storageBucket\": \"project-sentinel-command-14e19.firebasestorage.app\",\n  \"messagingSenderId\": \"200118381577\",\n  \"appId\": \"1:200118381577:web:7c6ba4c96078daa5b1dcd8\",\n  \"measurementId\": \"G-4G97P00BN5\"\n}","eyJhbGciOiJSUzII1NiIsImtpZCI6ImExZWJmYmMyU1ZjYwZWY5Y2NkMGViNTc3ZmI3ZjkxZGRjODg1MDA0YzAiLCJ0eXAiOiJKV1QifQ.eyJzdWIiOiJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0BiYXJkLWZyb250ZW5kLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwiYXVkIjoiaHR0cHM6Ly9pZGVudGl0eXRvb2xraXQuZ29vZ2xlYXBpcy5jb20vZ29vZ2xlLmlkZW50aXR5LmlkZW50aXR5dG9vbGtpdC52MS5JZGVudGl0eVRvb2xraXQiLCJ1aWQiOiIxMzUxMTcwODU5MDcxODA0NTk5OCIsImlzcyI6ImZpcmViYXNlLWFkbWluc2RrLWZic3ZjQGJhcmQtZnJvbnRlbmQuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJjbGFpbXMiOnsiYXBwSWQiOiJjXzQ5YWFlZTViNDBiMTFjN2FfaW5kZXguaHRtbC0yMiJ9LCJleHAiOjE3NTY4MzYwMTUsImlhdCI6MTc1NjgzMjQxNSwiYWxnIjoiUlMyNTYifQ.f3uh6_rTx3DPMxRnFO2yMwYJTBUO7FYUPnZy-mOO1s6mjCNMla1qZ9vHLOOLpVbjOiARY-TT_-3hSPsFgpfdNWT1gNEh6Fsi3u0SNlAN09YNe0aYgpo0TW19zS85f0pjPRiMpE3aZqoCsR8RumIdCAivktu0yhXPHnubnG4mL6vThGFyq1aSuKyX7EHfWiXequ2JdLb2sLT0CFwfSDFa9i7fkJA9wTMJOKrgLlKAzVTp9IljIQagRlc0f-hCnlu0kSxwGhfE2ZUrdbx6wD1u2Vmzu2mJqZXVY5Ix__HgDkzt5fH6ITieOUWoqvsdkp1XQeg7Z38tS3ZfyqUumr87IQ","c_45e52c80c10a1122_index.html-26")</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Project Sentinel v32.5 | Final Stable Build</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://d3js.org https://www.gstatic.com https://apis.google.com https://generativelanguage.googleapis.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://generativelanguage.googleapis.com wss://*.firebaseio.com https://*.googleapis.com https://unpkg.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' data: https://cdnjs.cloudflare.com https://fonts.gstatic.com; img-src 'self' data: blob: https://*; worker-src 'self' blob: data:; frame-src 'self' https://project-sentinel-command-14e19.firebaseapp.com;">
    <meta name="theme-color" content="#0f172a">

    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" as="style">
    
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer" />

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        window.firebaseSDK = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signInWithCustomToken,
            getFirestore,
            doc,
            getDoc,
            setDoc,
            onSnapshot
        };
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap');
        
        :root {
            --status-good-primary: #2dd4bf; --status-good-secondary: #14b8a6; --status-good-glow: rgba(45, 212, 191, 0.5);
            --status-warning-primary: #3b82f6; --status-warning-secondary: #2563eb; --status-warning-glow: rgba(59, 130, 246, 0.5);
            --status-critical-primary: #f87171; --status-critical-secondary: #ef4444; --status-critical-glow: rgba(248, 113, 113, 0.5);
            --status-purple-primary: #a78bfa; --status-purple-secondary: #8b5cf6; --status-purple-glow: rgba(167, 139, 250, 0.5);
            --status-orange-primary: #fb923c; --status-orange-secondary: #f97316; --status-orange-glow: rgba(251, 146, 60, 0.5);
            --status-yellow-primary: #facc15; --status-yellow-secondary: #eab308; --status-yellow-glow: rgba(250, 204, 21, 0.5);
        }
        
        body { 
            font-family: 'Heebo', sans-serif; 
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
       .theme-dark {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-tertiary: #334155;
            --text-primary: #e2e8f0; --text-secondary: #94a3b8; --border-color: #334155;
        }
        
       .theme-light {
            --bg-primary: #f1f5f9; --bg-secondary: #ffffff; --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a; --text-secondary: #475569; --border-color: #e2e8f0;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
       .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--status-good-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }

       .skeleton-loader::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: skeleton-loading 1.5s infinite;
        }
        @keyframes skeleton-loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

       .fade-in-on-load { animation: fadeIn 0.5s ease-out forwards; }
       .fade-in-on-load > * { opacity: 0; animation: fadeIn 0.5s ease-out forwards; }

        @keyframes radar-sweep {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes background-pan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
       .login-background {
            background-size: 200% 200%;
            background-image: radial-gradient(circle at 10% 20%, rgb(15, 23, 42) 0%, rgb(30, 41, 59) 90%);
            animation: background-pan 20s linear infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 5px var(--status-good-glow)); }
            50% { transform: scale(1.05); filter: drop-shadow(0 0 15px var(--status-good-glow)); }
        }
       .pulsing-logo {
            animation: pulse 4s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-[--bg-primary] text-[--text-primary] theme-dark">
    <div id="root"></div>
    <script type="text/babel">
        // FIX: Replaced custom onDOMLoaded with the standard browser event listener
        // to prevent race conditions and ensure the app code runs only after the page is ready.
        document.addEventListener('DOMContentLoaded', () => {
            const { useState, useEffect, useRef, useCallback, useReducer, createContext, useContext, useMemo } = React;

            const translations = {
                en: { "app_title": "Project Sentinel v32.1 | Final Stable Build", "classification": "Classification: Unclassified", "main_header": "Project Sentinel - Command Nexus", "motto": "Eyes on the Horizon, Grip on the Command: Absolute Control, Decisive Action", "morning_report": "Morning Report", "daily_report": "Daily Report", "report_date": "Report Date:", "control_panel": "Control Panel", "export_share": "Export & Share", "share_link": "Share Link", "share_whatsapp": "Share via WhatsApp", "export_options": "Export Options", "export_select_cards": "Select cards to export:", "export": "Export", "backup_data": "Backup Data", "backup_code": "Backup Source Code", "restore_data": "Restore Data", "restore_success": "Data restored successfully!", "restore_error": "Error restoring data. Please check file format.", "restore_confirm": "This will overwrite all existing data. Are you sure?", "diagnostics": "Diagnostics & Health", "run_bit": "Run Integration Tests", "theme_toggle": "Toggle Theme", "lang_toggle": "Change Language", "version_history": "Version History", "signed_orders_kpi": "Total Signed", "backlog_gap_kpi": "Backlog Gap", "pending_orders_kpi": "Pending Signatures", "rejected_orders_kpi": "Total Rejected", "ai_insights_title": "AI Analytical HQ", "anomaly_detected": "Anomaly Detected!", "anomaly_desc": "Unusually high number of rejected orders detected today (+25% vs 7-day average).", "analyze_anomaly": "Analyze Anomaly", "scenario_engine_title": "Strategic Advisor", "staff_members": "Number of Staff:", "processing_rate": "Processing Rate (orders/day/staff):", "set_goal": "Set Goal: Clear pending in", "days": "days", "get_action_plan": "Get Action Plan", "smart_assistant_title": "Smart Analytical Assistant", "ask": "Ask", "thinking": "Thinking... 🧠", "analytical_brain_title": "Interactive Analytical HQ", "scroll_up": "Scroll Up", "scroll_down": "Scroll Down", "bit_results_title": "BIT Results", "bit_report_summary_ok": "System integrity check passed. All components are operating as expected.", "bit_report_summary_fail": "System integrity check found issues. Review details below.", "bit_check_code": "Code Integrity (Hash Check)", "bit_check_functionality": "Functionality (UI Events)", "bit_check_ui": "UI/UX Consistency", "bit_check_api": "API Connectivity", "pass": "Pass", "fail": "Fail", "user_role": "User Role:", "admin": "Admin", "user": "User", "card_title_overallStatus": "Overall Status", "card_title_signedOrders": "Order Backlog - Desired vs. Actual", "card_title_pendingSignature": "Signature Process (Pending)", "card_title_rejectedOrders": "Rejected Orders", "card_subtitle_rejectedOrders": "(Responsibility: Project Manager vs. Budget)", "card_title_pendingAncillaryForm": "Pending Ancillary Form", "card_subtitle_pendingAncillaryForm": "(Responsibility: Tech Budget Manager)", "card_title_pendingCorrection": "Pending Correction", "card_subtitle_pendingCorrection": "(Responsibility: Project Manager vs. Budget)", "card_title_pendingAssetNumberEntry": "Pending Asset Number", "card_subtitle_pendingAssetNumberEntry": "(Responsibility: Buyer & QA)", "last_updated": "Last Updated: {time}", "deployment_center": "Deployment Center", "system_file_export": "System File Export (Manual Backup)", "export_html": "Export index.html", "tab_command_bridge": "Command Bridge", "tab_intelligence_hq": "Intelligence HQ", "tab_sharing_center": "Sharing Center", "tab_control_panel": "Control Panel", "subtab_docs_info": "Documentation & Info", "subtab_version_history": "Version History", "subtab_diagnostics": "Diagnostics", "subtab_deployment_center": "Deployment Center", "subtab_export_share": "Export & Share", "subtab_manual_deploy": "Manual Deployment", "subtab_backup_restore": "Backup & Restore", "api_key_label": "Gemini API Key", "api_key_placeholder": "API Key is configured in the code.", "api_key_missing": "Gemini API key is missing. Please set it in the code.", "summary_generator": "Executive Summary Generator", "generate_summary": "Generate Summary", "copy_to_clipboard": "Copy to Clipboard", "copied": "Copied!", "proactive_insights": "Proactive Insights & Forecasts", "nlq_placeholder": "Ask a question about the data...", "daily_focus_title": "AI Daily Focus", "analyzing_data": "Analyzing data...", "deployment_guide_title": "Deployment Guide (GitHub Pages)", "deployment_guide_step1_title": "Step 1: Prerequisites", "deployment_guide_step1_desc": "Ensure you have Git installed and a GitHub account.", "deployment_guide_step2_title": "Step 2: Prepare Your Project", "deployment_guide_step2_desc": "Create a new folder for your project and save this application's code as 'index.html' inside it.", "deployment_guide_step3_title": "Step 3: Initialize Git & Push to GitHub", "deployment_guide_step3_desc": "Run these commands from your project folder to upload the code to a new GitHub repository.", "deployment_guide_step3_li1": "Initialize a local Git repository:", "deployment_guide_step3_li2": "Add the file to the repository:", "deployment_guide_step3_li3": "Commit the file:", "deployment_guide_step3_li4": "Create a new repository on GitHub.com and then link it:", "deployment_guide_step3_li5": "Push the code to GitHub:", "deployment_guide_step4_title": "Step 4: Enable GitHub Pages", "deployment_guide_step4_desc": "Configure your repository to publish the 'index.html' file as a live website.", "deployment_guide_step4_li1": "In your GitHub repository, go to 'Settings' > 'Pages'.", "deployment_guide_step4_li2": "Under 'Build and deployment', for 'Source', select 'Deploy from a branch'.", "deployment_guide_step4_li3": "For 'Branch', select 'main' (or 'master') and '/(root)', then click 'Save'.", "deployment_guide_step4_li4": "Your site will be live at the provided URL within a few minutes.", "deployment_guide_step5_title": "Step 5: Diagnostics", "deployment_guide_step5_desc": "If you encounter issues, use your browser's Developer Tools (F12) to check the 'Console' for errors and the 'Network' tab for failed requests.", "login_title": "Welcome to Sentinel", "login_subtitle": "Please select your role and enter the password to continue", "select_role": "Select Role", "password": "Password", "login": "Login", "login_error": "Invalid password for the selected role.", "user_guide_title": "Introduction and Operation Guide", "caps_lock_on": "Caps Lock is on", "logout": "Log Off", "save_data": "Save Data", "reset_data": "Reset Data for Today", "data_saved_success": "Data saved successfully!", "data_reset_success": "Today's report has been reset.", "data_saved_error": "Error saving data.", "data_reset_error": "Error resetting data.", "backup_error_no_data": "Error: No data to back up.", "backup_error_code": "Error backing up source code.", "warning": "Warning", "cancel": "Cancel", "restore": "Restore" },
                he: { "app_title": "Project Sentinel v32.1 | Final Stable Build", "classification": "רמת סיווג: בלמ\"ס", "main_header": "Project Sentinel - Command Nexus", "motto": "Eyes on the Horizon, Grip on the Command: Absolute Control, Decisive Action", "morning_report": "דו\"ח בוקר", "daily_report": "דו\"ח יומי", "report_date": "תאריך דו\"ח:", "control_panel": "לוח בקרה", "export_share": "ייצוא ושיתוף", "share_link": "שתף קישור", "share_whatsapp": "שתף בוואטסאפ", "export_options": "אפשרויות ייצוא", "export_select_cards": "בחר כרטיסיות לייצוא:", "export": "ייצא", "backup_data": "גבה נתונים", "backup_code": "גבה קוד מקור", "restore_data": "שחזר נתונים", "restore_success": "הנתונים שוחזרו בהצלחה!", "restore_error": "שגיאה בשחזור הנתונים. אנא בדוק את תקינות הקובץ.", "restore_confirm": "פעולה זו תחליף את כל הנתונים הקיימים. האם אתה בטוח?", "diagnostics": "אבחון ותקינות", "run_bit": "הרץ בדיקות אינטגרציה", "theme_toggle": "שנה ערכת נושא", "lang_toggle": "שנה שפה", "version_history": "היסטוריית גרסאות", "signed_orders_kpi": "סה\"כ חתומות", "backlog_gap_kpi": "פער בצבר", "pending_orders_kpi": "ממתינות לחתימה", "rejected_orders_kpi": "סה\"כ דחויות", "ai_insights_title": "מטה אנליטי מבוסס AI", "anomaly_detected": "זוהתה אנומליה!", "anomaly_desc": "זוהה מספר גבוה חריג של הזמנות דחויות היום (עלייה של 25% לעומת ממוצע 7 ימים).", "analyze_anomaly": "נתח אנומליה", "scenario_engine_title": "יועץ אסטרטגי", "staff_members": "מספר אנשי צוות:", "processing_rate": "קצב טיפול (הזמנות ליום לאיש צוות):", "set_goal": "הגדר יעד: סיום ממתינות תוך", "days": "ימים", "get_action_plan": "קבל תוכנית פעולה", "smart_assistant_title": "עוזר אנליטי חכם", "ask": "שאל", "thinking": "חושב... 🧠", "analytical_brain_title": "חמ\"ל אנליטי אינטראקטיבי", "scroll_up": "גלילה למעלה", "scroll_down": "גלילה למטה", "bit_results_title": "תוצאות בדיקת BIT", "bit_report_summary_ok": "בדיקת תקינות מערכת עברה בהצלחה. כל הרכיבים פועלים כמצופה.", "bit_report_summary_fail": "בדיקת תקינות מערכת זיהתה בעיות. יש לעיין בפירוט.", "bit_check_code": "שלמות קוד (בדיקת Hash)", "bit_check_functionality": "פונקציונליות (אירועי UI)", "bit_check_ui": "עקביות עיצוב (UI/UX)", "bit_check_api": "קישוריות API", "pass": "תקין", "fail": "כשל", "user_role": "תפקיד משתמש:", "admin": "מנהל מערכת", "user": "משתמש", "card_title_overallStatus": "מצב כללי", "card_title_signedOrders": "צבר הזמנות-רצוי מול מצוי", "card_title_pendingSignature": "תהליך חתימות (ממתינות)", "card_title_rejectedOrders": "הזמנות דחויות", "card_subtitle_rejectedOrders": "(באחריות מנה\"פ מול תקציבן)", "card_title_pendingAncillaryForm": "ממתינות לטופס נלווה", "card_subtitle_pendingAncillaryForm": "(באחריות תקציבן טכנולוגי)", "card_title_pendingCorrection": "ממתינות לתיקון", "card_subtitle_pendingCorrection": "(באחריות מנה\"פ מול תקציבן)", "card_title_pendingAssetNumberEntry": "ממתינות למספר נכס", "card_subtitle_pendingAssetNumberEntry": "(באחריות קניין ומבקר איכות)", "last_updated": "עדכון אחרון: {time}", "deployment_center": "מרכז הפצה", "system_file_export": "ייצוא קבצי מערכת (לגיבוי ידני)", "export_html": "ייצא index.html", "tab_command_bridge": "גשר הפיקוד", "tab_intelligence_hq": "מטה המודיעין", "tab_sharing_center": "מרכז שיתוף", "tab_control_panel": "לוח בקרה", "subtab_docs_info": "תיעוד ומידע", "subtab_version_history": "היסטוריית גרסאות", "subtab_diagnostics": "אבחון ותקינות", "subtab_deployment_center": "מרכז הפצה", "subtab_export_share": "ייצוא ושיתוף", "subtab_manual_deploy": "הפצה ידנית", "subtab_backup_restore": "גיבוי ושחזור", "api_key_label": "מפתח API של Gemini", "api_key_placeholder": "מפתח ה-API מוגדר בקוד.", "api_key_missing": "מפתח API של Gemini חסר. יש להגדיר אותו בקוד.", "summary_generator": "מחולל סיכומי מנהלים", "generate_summary": "הפק סיכום", "copy_to_clipboard": "העתק ללוח", "copied": "הועתק!", "proactive_insights": "תובנות פרואקטיביות ותחזיות", "nlq_placeholder": "שאל שאלה על הנתונים...", "signed_backlog": "צבר הזמנות חתום", "existing_backlog": "צבר הזמנות קיים", "daily_focus_title": "פוקוס יומי מבוסס AI", "analyzing_data": "מנתח נתונים...", "user_guide_title": "עלון הכרות והדרכת תפעול", "deployment_guide_title": "מדריך הפצה, תפעול ותחזוקה", "deployment_guide_step1_title": "שלב 1: דרישות קדם", "deployment_guide_step1_desc": "ודא שהתקנת Git על המחשב ושיש לך חשבון GitHub.", "deployment_guide_step2_title": "שלב 2: הכנת הפרויקט", "deployment_guide_step2_desc": "צור תיקייה חדשה לפרויקט ושמור בתוכה את קוד האפליקציה כקובץ בשם 'index.html'.", "deployment_guide_step3_title": "שלב 3: אתחול Git ודחיפה ל-GitHub (הפצה ראשונית)", "deployment_guide_step3_desc": "הרצת פקודות אלו מתיקיית הפרויקט תעלה את הקוד למאגר GitHub חדש.", "deployment_guide_step3_li1": "אתחול מאגר Git מקומי:", "deployment_guide_step3_li2": "הוספת הקובץ למאגר:", "deployment_guide_step3_li3": "ביצוע Commit לקובץ:", "deployment_guide_step3_li4": "יצירת מאגר חדש ב-GitHub.com וקישורו:", "deployment_guide_step3_li5": "דחיפת הקוד ל-GitHub:", "deployment_guide_step4_title": "שלב 4: הפעלת GitHub Pages", "deployment_guide_step4_desc": "הגדרת המאגר כך שיפרסם את קובץ ה-'index.html' כאתר אינטרנט חי.", "deployment_guide_step4_li1": "במאגר שלך ב-GitHub, נווט ל-'Settings' > 'Pages'.", "deployment_guide_step4_li2": "תחת 'Build and deployment', במקור ('Source'), בחר 'Deploy from a branch'.", "deployment_guide_step4_li3": "בענף ('Branch'), בחר 'main' (או 'master') ו-'/(root)', ולחץ 'Save'.", "deployment_guide_step4_li4": "האתר שלך יהיה זמין בכתובת שתופיע תוך מספר דקות.", "deployment_guide_step5_title": "שלב 5: תחזוקה שוטפת ועדכוני גרסה", "deployment_guide_step5_desc": "לאחר שינויים בקוד, השתמש בפקודות הבאות כדי לעדכן את האתר החי:", "deployment_guide_step5_li1": "הוספת כל השינויים:", "deployment_guide_step5_li2": "ביצוע Commit עם הודעה משמעותית:", "deployment_guide_step5_li3": "דחיפת העדכונים:", "deployment_guide_step6_title": "שלב 6: אבחון תקלות", "deployment_guide_step6_desc": "במקרה של בעיות, השתמש בכלי המפתחים של הדפדפן (F12) כדי לבדוק שגיאות ב-'Console' ובקשות שנכשלו בטאב 'Network'.", "login_title": "ברוכים הבאים ל-Sentinel", "login_subtitle": "אנא בחר את תפקידך והזן סיסמה כדי להמשיך", "select_role": "בחר תפקיד", "password": "סיסמה", "login": "כניסה", "login_error": "סיסמה שגויה עבור התפקיד שנבחר.", "caps_lock_on": "Caps Lock פועל", "logout": "התנתק", "save_data": "שמור נתונים", "reset_data": "אפס נתונים להיום", "data_saved_success": "הנתונים נשמרו בהצלחה!", "data_reset_success": "הדוח להיום אופס בהצלחה.", "data_saved_error": "שגיאה בשמירת הנתונים.", "data_reset_error": "שגיאה באיפוס הנתונים.", "backup_error_no_data": "שגיאה: אין נתונים לגיבוי.", "backup_error_code": "שגיאה בגיבוי קוד המקור.", "warning": "אזהרה", "cancel": "ביטול", "restore": "שחזר" }
            };

            const LanguageContext = createContext();

            const LanguageProvider = ({ children }) => {
                const [language, setLanguage] = useState(() => {
                    try {
                        return localStorage.getItem('sentinel-lang') || 'he';
                    } catch (e) {
                        console.warn('Could not access localStorage. Defaulting to he.');
                        return 'he';
                    }
                });

                useEffect(() => {
                    try {
                        document.documentElement.lang = language;
                        document.documentElement.dir = language === 'he' ? 'rtl' : 'ltr';
                        localStorage.setItem('sentinel-lang', language);
                    } catch (e) {
                         console.warn(`Could not set language '${language}' in localStorage.`);
                    }
                }, [language]);

                const toggleLanguage = useCallback(() => {
                    setLanguage(prevLang => prevLang === 'he' ? 'en' : 'he');
                }, []);

                const t = useCallback((key, params = {}) => {
                    let translation = translations[language]?.[key] || key;
                    Object.keys(params).forEach(p => {
                        translation = translation.replace(`{${p}}`, params[p]);
                    });
                    return translation;
                }, [language]);

                const value = useMemo(() => ({
                    language,
                    toggleLanguage,
                    t
                }), [language, toggleLanguage, t]);

                return <LanguageContext.Provider value={value}>{children}</LanguageContext.Provider>;
            };


            const useTranslation = () => useContext(LanguageContext);

            const DashboardContext = createContext();
            
            const initialReportState = {
                signedOrders: 0,
                existingBacklog: 0, 
                pendingSignature: { 'ענף גזברות': 0, 'רכש, מכרזים ולוגיסטיקה': 0, 'כספים וחשבות': 0 },
                rejectedOrders: 0,
                pendingAncillaryForm: 0,
                pendingCorrection: 0,
                pendingAssetNumberEntry: 0,
            };
            
            const calculateTotals = (data) => {
                if (!data) return {...initialReportState, computedMetrics: { totalPending: 0, goalPercentage: 0, totalPendingSignature: 0, backlogDifference: 0 } };
                const totalPendingSignature = Object.values(data.pendingSignature || {}).reduce((a, b) => a + b, 0);
                const totalPending = totalPendingSignature + (data.pendingAncillaryForm || 0) + (data.pendingCorrection || 0) + (data.pendingAssetNumberEntry || 0);
                const backlogDifference = (data.existingBacklog || 0) - (data.signedOrders || 0);
                const goalPercentage = (data.existingBacklog || 0) > 0 ? ((data.signedOrders || 0) / (data.existingBacklog || 1)) * 100 : 0;
                return {...data, computedMetrics: { totalPending, goalPercentage, totalPendingSignature, backlogDifference } };
            };

            const initialState = {
                allReports: {},
                currentReportId: null,
                dataForEditing: JSON.parse(JSON.stringify(initialReportState)),
                liveData: calculateTotals(initialReportState),
                previousValues: {},
                lastUpdateInfo: null,
                notifications: [],
                userRole: 'user',
                isAuthenticated: false,
                isDataLoading: true, 
            };
            
            function dashboardReducer(state, action) {
                switch (action.type) {
                    case 'LOGIN_SUCCESS': return {...state, isAuthenticated: true, userRole: action.payload.role };
                    case 'LOGOUT': return {...state, isAuthenticated: false, userRole: 'user' };
                    case 'SET_REPORTS_FROM_DB': 
                        return {...state, allReports: action.payload.reports || {}, isDataLoading: false };
                    case 'RESTORE_DATA':
                        return {...state, allReports: action.payload.reports };
                    case 'LOAD_REPORT': {
                        const { id, previousData } = action.payload;
                        const existingReportData = state.allReports[id];
                        let reportData;
                        if (existingReportData) {
                            reportData = existingReportData;
                        } else {
                            if (Object.keys(previousData || {}).length > 0) {
                                reportData = JSON.parse(JSON.stringify(previousData));
                            } else {
                                reportData = JSON.parse(JSON.stringify(initialReportState));
                            }
                        }
                        return {...state, currentReportId: id, dataForEditing: reportData, liveData: calculateTotals(reportData), previousValues: previousData };
                    }
                    case 'SET_DATA_SAVED': {
                        const newAllReports = {...state.allReports, [state.currentReportId]: state.dataForEditing };
                        return {...state, allReports: newAllReports, lastUpdateInfo: { time: new Date().toLocaleString('he-IL') } };
                    }
                     case 'RESET_TODAY_DATA': {
                        const newAllReports = {...state.allReports, [state.currentReportId]: JSON.parse(JSON.stringify(initialReportState)) };
                        return {...state, allReports: newAllReports, dataForEditing: JSON.parse(JSON.stringify(initialReportState)), liveData: calculateTotals(initialReportState) };
                    }
                    case 'UPDATE_EDITING_FIELD': {
                        if (state.userRole !== 'admin') return state;
                        const { fieldPath, value } = action.payload;
                        const newState = JSON.parse(JSON.stringify(state));
                        let current = newState.dataForEditing;
                        if (!current) return state; 
                        const pathParts = fieldPath.split('.');
                        for (let i = 0; i < pathParts.length - 1; i++) {
                            if (!current[pathParts[i]]) { current[pathParts[i]] = {}; }
                            current = current[pathParts[i]];
                        }
                        current[pathParts[pathParts.length - 1]] = value;
                        newState.liveData = calculateTotals(newState.dataForEditing);
                        return newState;
                    }
                    case 'ADD_NOTIFICATION':
                        if (state.notifications.some(n => n.text === action.payload.text)) return state;
                        return {...state, notifications: [action.payload,...state.notifications] };
                    default: return state;
                }
            }

            const DashboardProvider = ({ children }) => {
                const [state, dispatch] = useReducer(dashboardReducer, initialState);
                const [db, setDb] = useState(null);
                const [userId, setUserId] = useState(null);
                const [isAuthReady, setIsAuthReady] = useState(false);

                useEffect(() => {
                    const firebaseConfigStr = window.__firebase_config;
                    if (!firebaseConfigStr) {
                        console.error("Firebase config not found.");
                        dispatch({ type: 'SET_REPORTS_FROM_DB', payload: { reports: {} }});
                        return;
                    }
                    const firebaseConfig = JSON.parse(firebaseConfigStr);
                    const app = window.firebaseSDK.initializeApp(firebaseConfig);
                    const auth = window.firebaseSDK.getAuth(app);
                    const firestore = window.firebaseSDK.getFirestore(app);
                    setDb(firestore);

                    const authUnsubscribe = window.firebaseSDK.onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            setUserId(user.uid);
                        } else {
                            const authToken = window.__initial_auth_token;
                            try {
                               if (authToken) {
                                    await window.firebaseSDK.signInWithCustomToken(auth, authToken);
                               } else {
                                    await window.firebaseSDK.signInAnonymously(auth);
                               }
                            } catch (error) {
                                console.warn("Authentication failed, falling back to anonymous sign-in.", error.code);
                                try {
                                    await window.firebaseSDK.signInAnonymously(auth);
                                } catch (anonError) {
                                    console.error("CRITICAL: Anonymous sign-in failed.", anonError);
                                }
                            }
                        }
                        setIsAuthReady(true);
                    });
                    return () => authUnsubscribe();
                }, []);

                useEffect(() => {
                    if (!isAuthReady || !db || !userId) {
                        if(isAuthReady) {
                           dispatch({ type: 'SET_REPORTS_FROM_DB', payload: { reports: {} }});
                        }
                        return;
                    }
                    
                    const appId = window.__app_id || 'default-app-id';
                    const docRef = window.firebaseSDK.doc(db, `/artifacts/${appId}/public/data/sentinelReports`, 'allReports');

                    const unsubscribe = window.firebaseSDK.onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            dispatch({ type: 'SET_REPORTS_FROM_DB', payload: { reports: docSnap.data() }});
                        } else {
                            dispatch({ type: 'SET_REPORTS_FROM_DB', payload: { reports: {} }});
                        }
                    }, (error) => {
                        console.error("Error with Firestore snapshot:", error);
                        dispatch({ type: 'SET_REPORTS_FROM_DB', payload: { reports: {} }});
                    });

                    return () => unsubscribe();
                }, [isAuthReady, userId, db]);


                const value = useMemo(() => ({ state, dispatch, db, userId }), [state, dispatch, db, userId]);

                return <DashboardContext.Provider value={value}>{children}</DashboardContext.Provider>;
            };
            
            const versionHistory = [
                { version: "v32.5", date: "2024-09-05", changes: ["FIX: Resolved critical race condition by using standard 'DOMContentLoaded' event.", "FIX: Updated Content Security Policy to allow all required CDN connections."] },
                { version: "v32.4", date: "2024-09-05", changes: ["FIX: Corrected script load order and added 'frame-src' to Content Security Policy.", "Updated API Key."] },
                { version: "v32.3", date: "2024-09-05", changes: ["FIX: Corrected syntax error caused by misplaced comments in `BackupAndRestore` component.", "Standardized Firestore `setDoc` calls to use `{ merge: true }`."] },
                { version: "v32.2", date: "2024-09-05", changes: ["FIX: Corrected Firestore data path to resolve admin write permissions.", "Auth failure now correctly uses a public data path, restoring admin functionality."] },
                { version: "v32.0", date: "2024-09-04", changes: ["Final CSP fix: Corrected Content Security Policy to allow all required Firebase and Google API connections.", "System is now fully operational and stable."] },
            ];
            
            const cardDefinitions = {
                overallStatus: { titleKey: 'card_title_overallStatus', color: 'teal', icon: 'fa-tachometer-alt' },
                signedOrders: { titleKey: 'card_title_signedOrders', color: 'teal', icon: 'fa-check-double' },
                pendingSignature: { titleKey: 'card_title_pendingSignature', color: 'purple', icon: 'fa-signature' },
                rejectedOrders: { titleKey: 'card_title_rejectedOrders', subtitleKey: 'card_subtitle_rejectedOrders', color: 'red', icon: 'fa-times-circle' },
                pendingAncillaryForm: { titleKey: 'card_title_pendingAncillaryForm', subtitleKey: 'card_subtitle_pendingAncillaryForm', color: 'orange', icon: 'fa-file-alt' },
                pendingCorrection: { titleKey: 'card_title_pendingCorrection', subtitleKey: 'card_subtitle_pendingCorrection', color: 'blue', icon: 'fa-edit' },
                pendingAssetNumberEntry: { titleKey: 'card_title_pendingAssetNumberEntry', subtitleKey: 'card_subtitle_pendingAssetNumberEntry', color: 'yellow', icon: 'fa-barcode' }
            };

            const callGeminiAPI = async (prompt, jsonSchema = null) => {
                const apiKey = "AIzaSyCwpscqDo9zWFbwrp1--3bk50xdg0ZgDok"; 

                const isDevEnvironment = !!window.__firebase_config;

                if (!apiKey && !isDevEnvironment) { 
                    const errorMsg = "מפתח ה-API של Gemini חסר. אנא הגדר אותו בקוד כדי להפעיל את יכולות ה-AI.";
                    console.error(errorMsg);
                    return jsonSchema ? JSON.stringify({ answer: errorMsg, chartData: null }) : errorMsg;
                }
                
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                if (jsonSchema) { payload.generationConfig = { responseMimeType: "application/json", responseSchema: jsonSchema }; }
                try {
                    const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { 
                        const errorBody = await response.json(); 
                        console.error("Gemini API HTTP error:", response.status, errorBody); 
                        throw new Error(`שגיאת שרת: ${response.status} - ${errorBody?.error?.message || 'שגיאה לא ידועה'}`); 
                    }
                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0] || !result.candidates[0].content || !result.candidates[0].content.parts || !result.candidates[0].content.parts[0]) { 
                        throw new Error("Invalid response structure from Gemini API."); 
                    }
                    return result.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    const errorMsg = `שגיאה בתקשורת עם שירות ה-AI: ${error.message}`;
                    return jsonSchema ? JSON.stringify({ answer: errorMsg, chartData: null }) : errorMsg;
                }
            };
            
            const App = () => {
                const { state } = useContext(DashboardContext);
                
                if (state.isDataLoading) {
                    return (
                        <div className="flex items-center justify-center min-h-screen login-background">
                                <div className="loading-spinner"></div>
                        </div>
                    );
                }

                if (!state.isAuthenticated) { return <LoginScreen />; }
                return <MainDashboard />;
            };

            const LoginScreen = () => {
                const { dispatch } = useContext(DashboardContext);
                const { t, language, toggleLanguage } = useTranslation();
                const [role, setRole] = useState('user');
                const [password, setPassword] = useState('');
                const [error, setError] = useState('');
                const [isLoading, setIsLoading] = useState(false);
                const [isPasswordVisible, setIsPasswordVisible] = useState(false);
                const [isCapsOn, setIsCapsOn] = useState(false);
                const passwords = { user: '57919021', admin: 'Myosy2002' };
                const handleLogin = (e) => {
                    e.preventDefault();
                    setIsLoading(true);
                    setError('');
                    setTimeout(() => {
                        if (passwords[role] === password) { dispatch({ type: 'LOGIN_SUCCESS', payload: { role } }); } 
                        else { setError(t('login_error')); }
                        setIsLoading(false);
                    }, 1000);
                };
                const checkCapsLock = (e) => { if (e.getModifierState) { setIsCapsOn(e.getModifierState('CapsLock')); } };
                return (
                    <div className="flex items-center justify-center min-h-screen login-background">
                        <div className="relative w-full max-w-md p-8 space-y-8 bg-[--bg-secondary]/80 backdrop-blur-md rounded-2xl shadow-2xl border border-teal-500/20 fade-in-on-load">
                            <div className="absolute top-4 left-4 rtl:left-auto rtl:right-4">
                                 <button onClick={toggleLanguage} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center font-bold text-sm hover:text-[--text-primary] transition-colors" title={t('lang_toggle')}>
                                    {language === 'he' ? 'EN' : 'HE'}
                                </button>
                            </div>
                            <div className="text-center">
                                <div className="inline-block pulsing-logo"><SystemLogo /></div>
                                <h2 className="mt-6 text-3xl font-bold text-center text-[--text-primary]">{t('login_title')}</h2>
                                <p className="mt-2 text-center text-sm text-teal-400">{t('login_subtitle')}</p>
                            </div>
                            <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                                <div className="relative">
                                    <select value={role} onChange={(e) => setRole(e.target.value)} className="w-full p-3 bg-[--bg-primary]/70 border-2 border-[--border-color] rounded-md appearance-none text-[--text-primary] focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all">
                                        <option className="text-black" value="user">{t('user')}</option>
                                        <option className="text-black" value="admin">{t('admin')}</option>
                                    </select>
                                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-[--text-secondary]"><i className="fas fa-chevron-down"></i></div>
                                </div>
                                 <div className="relative">
                                    <button type="button" onClick={() => setIsPasswordVisible(!isPasswordVisible)} className="absolute top-3.5 left-3 text-[--text-secondary] hover:text-teal-400 transition-colors z-10"><i className={`fas ${isPasswordVisible ? 'fa-eye-slash' : 'fa-eye'}`}></i></button>
                                    <input type={isPasswordVisible ? 'text' : 'password'} value={password} onChange={(e) => setPassword(e.target.value)} onKeyUp={checkCapsLock} onKeyDown={checkCapsLock} placeholder={t('password')} className="w-full p-3 pl-10 bg-[--bg-primary]/70 border-2 border-[--border-color] rounded-md text-[--text-primary] placeholder:text-[--text-secondary] focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all" required />
                                </div>
                                {isCapsOn && <p className="text-xs text-yellow-400 text-center flex items-center justify-center gap-2"><i className="fas fa-exclamation-circle"></i> {t('caps_lock_on')}</p>}
                                {error && <p className="text-sm text-red-400 text-center">{error}</p>}
                                <div>
                                    <button type="submit" disabled={isLoading} className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 disabled:opacity-50 transition-all transform hover:scale-105 active:scale-100">
                                        {isLoading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : t('login')}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            };
            
            const MainDashboard = () => {
                const { state, dispatch, db, userId } = useContext(DashboardContext);
                const { userRole, allReports } = state;
                const { t } = useTranslation();
                
                const getInitialDateState = () => {
                    return { date: new Date().toISOString().split('T')[0], type: 'morning' };
                };
                
                const [message, setMessage] = useState({ text: '', isError: false, visible: false });
                const [reportDate, setReportDate] = useState(() => getInitialDateState().date);
                const [currentReportType, setCurrentReportType] = useState(() => getInitialDateState().type);
                const [theme, setTheme] = useState('theme-dark');
                const [activeModal, setActiveModal] = useState(null);
                const [exportSelection, setExportSelection] = useState({});
                const [activeTab, setActiveTab] = useState('command_bridge'); 
                const [activeControlPanelTab, setActiveControlPanelTab] = useState('backup_restore');
                const [isAiGenerating, setIsAiGenerating] = useState(false);
                const infographicContainerRef = useRef(null);

                useEffect(() => {
                    const reportId = `${reportDate}-${currentReportType}`;
                    const getPreviousDocId = () => {
                        const allSortedIds = Object.keys(allReports).sort();
                        const currentIdIndex = allSortedIds.indexOf(reportId);
                        if(currentIdIndex > 0) return allSortedIds[currentIdIndex - 1];

                        const currentDate = new Date(reportDate);
                        if (currentReportType === 'daily') { 
                            const morningId = `${reportDate}-morning`;
                            if(allReports[morningId]) return morningId;
                        } 
                        currentDate.setDate(currentDate.getDate() - 1); 
                        const prevDate = currentDate.toISOString().split('T')[0]; 
                        const prevDailyId = `${prevDate}-daily`;
                        if(allReports[prevDailyId]) return prevDailyId;
                        const prevMorningId = `${prevDate}-morning`;
                        if(allReports[prevMorningId]) return prevMorningId;

                        return null; 
                    };
                    const prevDocId = getPreviousDocId();
                    const previousData = allReports[prevDocId] || (Object.keys(allReports).length > 0 ? allReports[Object.keys(allReports).sort().pop()] : {});
                    dispatch({ type: 'LOAD_REPORT', payload: { id: reportId, previousData } });
                }, [reportDate, currentReportType, allReports]);

                useEffect(() => {
                    try {
                        const savedTheme = localStorage.getItem('sentinel-theme') || 'theme-dark';
                        setTheme(savedTheme);
                        document.documentElement.classList.add(savedTheme.replace('theme-',''));
                        document.body.classList.add(savedTheme);
                    } catch(e) { console.warn('Could not access localStorage for theme.') }
                }, []);

                useEffect(() => { document.title = t('app_title'); }, [t]);
                useEffect(() => { let timer; if (message.visible) { timer = setTimeout(() => setMessage(prev => ({...prev, visible: false })), 5000); } return () => clearTimeout(timer); }, [message]);
                const showMessage = useCallback((text, isError = false) => { setMessage({ text, isError, visible: true }); }, []);
                const toggleTheme = () => { try { const newTheme = theme === 'theme-dark' ? 'theme-light' : 'theme-dark'; const oldTheme = theme; setTheme(newTheme); localStorage.setItem('sentinel-theme', newTheme); document.documentElement.classList.remove(oldTheme.replace('theme-','')); document.body.classList.remove(oldTheme); document.documentElement.classList.add(newTheme.replace('theme-','')); document.body.classList.add(newTheme); } catch(e) {console.warn('Could not save theme to localStorage.')} };
                const getFormattedFileName = (type, extension) => { const now = new Date(); const date = now.toISOString().split('T')[0]; const time = now.toTimeString().split(' ')[0].replace(/:/g, '-'); return `Project-Sentinel_Report_${date}_${time}.${extension}`; };
                
                const handleExport = async (format) => {
                    const element = infographicContainerRef.current;
                    if (!element) { showMessage("שגיאת ייצוא: לא נמצאה הפניה לאלמנט.", true); return; }
                    const cardsToHide = Object.keys(exportSelection).filter(cardId => !exportSelection[cardId]);
                    Object.keys(cardDefinitions).forEach(cardId => { const cardElement = document.getElementById(`card-${cardId}`); if (cardElement) cardElement.classList.remove('hidden'); });
                    cardsToHide.forEach(cardId => { const cardElement = document.getElementById(`card-${cardId}`); if (cardElement) cardElement.classList.add('hidden'); });
                    showMessage("מכין ייצוא...");
                    setTimeout(async () => {
                        try {
                            const canvas = await html2canvas(element, { backgroundColor: theme === 'theme-dark' ? '#0f172a' : '#f1f5f9', scale: 2, useCORS: true });
                            const fileName = getFormattedFileName('image', format);
                            if (format === 'png') { const link = document.createElement('a'); link.href = canvas.toDataURL('image/png'); link.download = fileName; link.click(); } 
                            else if (format === 'pdf') { const { jsPDF } = window.jspdf; const imgData = canvas.toDataURL('image/jpeg', 0.9); const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' }); const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = (canvas.height * pdfWidth) / canvas.width; pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight); pdf.save(fileName); }
                        } catch (err) { console.error("שגיאה בתהליך הייצוא:", err); showMessage("שגיאה ביצירת הקובץ.", true); } 
                        finally { Object.keys(cardDefinitions).forEach(cardId => { const cardElement = document.getElementById(`card-${cardId}`); if (cardElement) cardElement.classList.remove('hidden'); }); setActiveModal(null); }
                    }, 300);
                };

                const handleDateChange = (days) => { const currentDate = new Date(reportDate); currentDate.setDate(currentDate.getDate() + days); setReportDate(currentDate.toISOString().split('T')[0]); };
                const handleShareLink = () => { const url = window.location.href; try { const textArea = document.createElement("textarea"); textArea.value = url; document.body.appendChild(textArea); textArea.focus(); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea); showMessage("הקישור הועתק ללוח!"); } catch (err) { showMessage("שגיאה בהעתקת הקישור.", true); } };
                
                const handleSaveData = async () => {
                    if (!db || !userId) {
                        showMessage(t('data_saved_error'), true);
                        return;
                    }
                    dispatch({ type: 'SET_DATA_SAVED' });
                    const newAllReports = {...state.allReports, [state.currentReportId]: state.dataForEditing };
                    const appId = window.__app_id || 'default-app-id';
                    const docRef = window.firebaseSDK.doc(db, `/artifacts/${appId}/public/data/sentinelReports`, 'allReports');
                    try {
                        await window.firebaseSDK.setDoc(docRef, newAllReports, { merge: true });
                        showMessage(t('data_saved_success'));
                        setIsAiGenerating(true);
                    } catch (error) {
                        console.error("Firestore Save Error:", error);
                        showMessage(t('data_saved_error') + ` - ${error.message}`, true);
                    }
                };
                
                const handleResetData = async () => {
                    if (!db || !userId || !state.currentReportId) {
                        showMessage(t('data_reset_error'), true);
                        return;
                    }
                    const newAllReports = {...state.allReports, [state.currentReportId]: JSON.parse(JSON.stringify(initialReportState)) };
                    const appId = window.__app_id || 'default-app-id';
                    const docRef = window.firebaseSDK.doc(db, `/artifacts/${appId}/public/data/sentinelReports`, 'allReports');
                    try {
                         await window.firebaseSDK.setDoc(docRef, newAllReports, { merge: true });
                         dispatch({ type: 'RESET_TODAY_DATA' });
                         showMessage(t('data_reset_success'));
                    } catch (error) {
                        console.error("Firestore Reset Error:", error);
                        showMessage(t('data_reset_error') + ` - ${error.message}`, true);
                    }
                };
                
                const TabNavigation = () => ( <div className="flex p-1 space-x-1 rtl:space-x-reverse bg-[--bg-secondary] rounded-xl shadow-lg border border-[--border-color]"> <button className={`w-full py-2.5 text-sm font-medium leading-5 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 ${activeTab === 'command_bridge' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveTab('command_bridge')}> <i className="fas fa-tachometer-alt"></i> {t('tab_command_bridge')} </button> <button className={`w-full py-2.5 text-sm font-medium leading-5 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 ${activeTab === 'intelligence_hq' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveTab('intelligence_hq')}> <i className="fas fa-brain"></i> {t('tab_intelligence_hq')} </button> <button className={`w-full py-2.5 text-sm font-medium leading-5 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 ${activeTab === 'sharing_center' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveTab('sharing_center')}> <i className="fas fa-share-alt"></i> {t('tab_sharing_center')} </button> {userRole === 'admin' && ( <button className={`w-full py-2.5 text-sm font-medium leading-5 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 ${activeTab === 'control_panel' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveTab('control_panel')}> <i className="fas fa-cogs"></i> {t('tab_control_panel')} </button> )} </div> );
                const ControlPanelTabs = () => ( <div className="flex flex-wrap p-1 gap-1 bg-[--bg-secondary] rounded-xl shadow-lg border border-[--border-color] mt-5"> <button className={`flex-1 py-2 text-xs font-medium leading-5 rounded-lg transition-all duration-300 ${activeControlPanelTab === 'backup_restore' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveControlPanelTab('backup_restore')}>{t('subtab_backup_restore')}</button> <button className={`flex-1 py-2 text-xs font-medium leading-5 rounded-lg transition-all duration-300 ${activeControlPanelTab === 'deployment_center' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveControlPanelTab('deployment_center')}>{t('deployment_center')}</button> <button className={`flex-1 py-2 text-xs font-medium leading-5 rounded-lg transition-all duration-300 ${activeControlPanelTab === 'diagnostics' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveControlPanelTab('diagnostics')}>{t('subtab_diagnostics')}</button> <button className={`flex-1 py-2 text-xs font-medium leading-5 rounded-lg transition-all duration-300 ${activeControlPanelTab === 'docs_info' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveControlPanelTab('docs_info')}>{t('subtab_docs_info')}</button> </div> );

                return (
                    <div className="fade-in-on-load">
                        {activeModal && <Modal activeModal={activeModal} setActiveModal={setActiveModal} onExport={handleExport} exportSelection={exportSelection} setExportSelection={setExportSelection} />}
                        <div className="fixed bottom-5 right-5 flex flex-col gap-3 z-50"> <button onClick={() => window.scrollTo(0, 0)} title={t('scroll_up')} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-primary] border border-[--border-color] flex items-center justify-center text-lg transition-all duration-300 hover:bg-teal-500 hover:text-white transform hover:scale-110 active:scale-95"><i className="fas fa-arrow-up"></i></button> <button onClick={() => window.scrollTo(0, document.body.scrollHeight)} title={t('scroll_down')} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-primary] border border-[--border-color] flex items-center justify-center text-lg transition-all duration-300 hover:bg-teal-500 hover:text-white transform hover:scale-110 active:scale-95"><i className="fas fa-arrow-down"></i></button> </div>
                        <div className="w-full max-w-6xl mx-auto p-4 md:p-6">
                            <TopBar theme={theme} toggleTheme={toggleTheme} />
                            <div className="flex flex-col gap-4 mb-5 bg-[--bg-secondary] p-4 rounded-xl border border-[--border-color] shadow-lg">
                                <div className="flex justify-center items-center"><Clock /></div>
                                <div className="flex flex-col sm:flex-row gap-2.5"> <button className={`flex-1 py-2.5 px-4 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 active:scale-95 ${currentReportType === 'morning' ? 'bg-teal-500 text-white shadow-md' : 'bg-[--bg-tertiary] text-[--text-secondary] hover:bg-opacity-75'}`} onClick={() => setCurrentReportType('morning')}>{t('morning_report')}</button> <button className={`flex-1 py-2.5 px-4 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 active:scale-95 ${currentReportType === 'daily' ? 'bg-teal-500 text-white shadow-md' : 'bg-[--bg-tertiary] text-[--text-secondary] hover:bg-opacity-75'}`} onClick={() => setCurrentReportType('daily')}>{t('daily_report')}</button> </div>
                                <div className="flex justify-between items-center gap-2.5"> <button className="w-9 h-9 flex-shrink-0 rounded-full bg-[--bg-tertiary] border border-[--border-color] flex items-center justify-center transition-transform transform hover:scale-110 active:scale-95" onClick={() => handleDateChange(1)}><i className="fas fa-chevron-right"></i></button> <div className="relative flex-grow"> <input type="date" id="reportDate" value={reportDate} onChange={e => setReportDate(e.target.value)} className="w-full bg-[--bg-tertiary] border border-[--border-color] rounded-lg p-2 text-center ps-10"/> <i className="fas fa-calendar-alt absolute start-3 top-1/2 -translate-y-1/2 text-[--text-secondary]"></i> </div> <button className="w-9 h-9 flex-shrink-0 rounded-full bg-[--bg-tertiary] border border-[--border-color] flex items-center justify-center transition-transform transform hover:scale-110 active:scale-95" onClick={() => handleDateChange(-1)}><i className="fas fa-chevron-left"></i></button> </div>
                            </div>
                            <TabNavigation />
                            <div className="pt-2.5">
                                <div style={{ display: activeTab === 'command_bridge' ? 'block' : 'none' }}>
                                    <React.Fragment>
                                        <KpiStrip />
                                        <DailyFocusAI trigger={isAiGenerating} onComplete={() => setIsAiGenerating(false)} />
                                        <div ref={infographicContainerRef}>
                                            <div className="bg-[--bg-secondary] rounded-2xl border border-[--border-color] shadow-2xl p-6">
                                                <DashboardHeader currentReportType={currentReportType} reportDate={reportDate} />
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                                                    <div className="lg:col-span-2 space-y-5">
                                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-5"> <div id="card-overallStatus" style={{ animationDelay: `100ms` }} className="fade-in-on-load"><SectionCard id="card-overallStatus" /></div> <div id="card-signedOrders" style={{ animationDelay: `200ms` }} className="fade-in-on-load"><SectionCard id="card-signedOrders" /></div> </div>
                                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-5"> <div id="card-rejectedOrders" style={{ animationDelay: `400ms` }} className="fade-in-on-load"><SectionCard id="card-rejectedOrders" /></div> <div id="card-pendingCorrection" style={{ animationDelay: `500ms` }} className="fade-in-on-load"><SectionCard id="card-pendingCorrection" /></div> </div>
                                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-5"> <div id="card-pendingAncillaryForm" style={{ animationDelay: `600ms` }} className="fade-in-on-load"><SectionCard id="card-pendingAncillaryForm" /></div> <div id="card-pendingAssetNumberEntry" style={{ animationDelay: `700ms` }} className="fade-in-on-load"><SectionCard id="card-pendingAssetNumberEntry" /></div> </div>
                                                    </div>
                                                    <div className="flex flex-col space-y-5">
                                                        <div id="card-pendingSignature" className="fade-in-on-load" style={{ animationDelay: `300ms` }}><SectionCard id="card-pendingSignature" /></div>
                                                        {userRole === 'admin' && ( 
                                                            <div className="p-4 bg-[--bg-primary] rounded-lg border border-[--border-color] flex flex-col gap-4 justify-center"> 
                                                                <button 
                                                                    onClick={handleSaveData} 
                                                                    disabled={!userId}
                                                                    className="w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-teal-600 border-teal-500 text-white hover:bg-teal-500 transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                                                                > 
                                                                    <i className="fas fa-save"></i> {t('save_data')} 
                                                                </button> 
                                                                <button 
                                                                    onClick={handleResetData} 
                                                                    disabled={!userId}
                                                                    className="w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-red-600 border-red-500 text-white hover:bg-red-500 transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                                                                > 
                                                                    <i className="fas fa-undo"></i> {t('reset_data')} 
                                                                </button> 
                                                            </div> 
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </React.Fragment>
                                </div>
                                <div style={{ display: activeTab === 'intelligence_hq' ? 'block' : 'none' }}><IntelligenceHQ triggerAi={isAiGenerating} /></div>
                                <div style={{ display: activeTab === 'sharing_center' ? 'block' : 'none' }}><SharingCenter setActiveModal={setActiveModal} handleShareLink={handleShareLink} /></div>
                                {userRole === 'admin' && ( <div style={{ display: activeTab === 'control_panel' ? 'block' : 'none' }}> <div className="bg-[--bg-secondary] rounded-2xl border border-[--border-color] p-5"> <ControlPanelTabs /> <div className="pt-2.5"> {activeControlPanelTab === 'backup_restore' && <BackupAndRestore showMessage={showMessage}/>} {activeControlPanelTab === 'deployment_center' && <DeploymentGuide />} {activeControlPanelTab === 'diagnostics' && <div className="bg-[--bg-primary] p-4 rounded-lg border border-[--border-color]"><button className="w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-[--bg-secondary] text-[--text-primary] border-[--border-color] hover:bg-[--bg-tertiary] transform hover:scale-105 active:scale-95" onClick={() => setActiveModal('bit')}>{t('run_bit')}</button></div>} {activeControlPanelTab === 'docs_info' && <VersionHistoryContent />} </div> </div> </div> )}
                            </div>
                        </div>
                        {message.visible && <div className={`fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white transition-all duration-500 ${message.isError ? 'bg-red-500' : 'bg-teal-500'} ${message.visible ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-5'}`}>{message.text}</div>}
                    </div>
                );
            }
            
            const TopBar = ({ theme, toggleTheme }) => { const { language, toggleLanguage, t } = useTranslation(); const { state, dispatch } = useContext(DashboardContext); const { userRole, notifications } = state; const handleLogout = () => { dispatch({ type: 'LOGOUT' }); }; return ( <div className="flex justify-between items-center mb-5"> <div className="text-xs text-[--text-secondary] transition-opacity duration-500"></div> <div className="flex items-center gap-2"> <div className="bg-[--bg-secondary] text-[--text-primary] border border-[--border-color] rounded-full text-xs px-3 py-1 flex items-center gap-2"> <span>{t('user_role')}</span> <span className="font-bold">{t(userRole)}</span> </div> <button className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center relative hover:text-[--text-primary] transition-colors" title="התראות"> <i className="fas fa-bell"></i> {notifications.length > 0 && <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center">{notifications.length}</span>} </button> <button onClick={toggleLanguage} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center font-bold text-sm hover:text-[--text-primary] transition-colors" title={t('lang_toggle')}> {language === 'he' ? 'EN' : 'HE'} </button> <button onClick={toggleTheme} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center hover:text-[--text-primary] transition-colors" title={t('theme_toggle')}> {theme === 'theme-dark' ? <i className="fas fa-sun"></i> : <i className="fas fa-moon"></i>} </button> <button onClick={handleLogout} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center hover:text-[--text-primary] transition-colors" title={t('logout')}> <i className="fas fa-sign-out-alt"></i> </button> </div> </div> ); };
            const DashboardHeader = ({ currentReportType, reportDate }) => { const { t, language } = useTranslation(); return ( <div className="text-center mb-8"> <div className="flex justify-center items-center gap-4 mb-2"> <SystemLogo /> <div> <h1 className="text-3xl md:text-4xl font-bold text-[--text-primary] break-words">{t('main_header')}</h1> <p className="text-sm text-[--text-secondary]">{t('classification')}</p> </div> <SystemLogo mirrored={true} /> </div> <div className="flex flex-col items-center"> <p className="text-md text-teal-300 italic">{t('motto')}</p> <div className="w-1/3 h-px bg-teal-500/50 mt-2"></div> </div> <p className="text-md text-[--text-secondary] mt-4"> {currentReportType === 'morning' ? t('morning_report') : t('daily_report')} - {new Date(reportDate).toLocaleDateString(language === 'he' ? 'he-IL' : 'en-CA')} </p> </div> ); };
            const KpiStrip = () => { const { state } = useContext(DashboardContext); const { liveData, previousValues } = state || {}; const { t } = useTranslation(); const getDelta = (current, previous) => { if (previous === undefined || current === undefined || previous === null || current === null || Object.keys(previousValues || {}).length === 0) return { value: undefined }; const delta = current - previous; const direction = delta > 0 ? 'up' : delta < 0 ? 'down' : 'neutral'; return { value: delta, direction }; }; const previousComputed = calculateTotals(previousValues).computedMetrics; const kpiData = [ { label: t('signed_orders_kpi'), value: liveData?.signedOrders, delta: getDelta(liveData?.signedOrders, previousValues?.signedOrders), type: 'good', isPositiveGood: true }, { label: t('backlog_gap_kpi'), value: liveData?.computedMetrics?.backlogDifference, delta: getDelta(liveData?.computedMetrics?.backlogDifference, previousComputed?.backlogDifference), type: 'warning', isPositiveGood: false }, { label: t('pending_orders_kpi'), value: liveData?.computedMetrics?.totalPending, delta: getDelta(liveData?.computedMetrics?.totalPending, previousComputed?.totalPending), type: 'warning', isPositiveGood: false }, { label: t('rejected_orders_kpi'), value: liveData?.rejectedOrders, delta: getDelta(liveData?.rejectedOrders, previousValues?.rejectedOrders), type: 'critical', isPositiveGood: false } ]; return ( <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-5"> {kpiData.map((kpi, index) => { let deltaColor = 'text-gray-400'; if (kpi.delta?.direction === 'up') { deltaColor = kpi.isPositiveGood ? 'text-teal-400' : 'text-red-400'; } else if (kpi.delta?.direction === 'down') { deltaColor = kpi.isPositiveGood ? 'text-red-400' : 'text-teal-400'; } if (kpi.label === t('signed_orders_kpi') && kpi.delta?.direction === 'down') { deltaColor = 'text-gray-400'; } return ( <div className="bg-[--bg-secondary] p-4 rounded-xl border border-[--border-color] text-center transition-all duration-300 transform hover:scale-105 hover:shadow-lg fade-in-on-load" style={{animationDelay: `${index * 100}ms`}} key={kpi.label}> <div className={`text-3xl font-bold flex items-center justify-center gap-2 ${kpi.type === 'good' ? 'text-teal-400' : kpi.type === 'warning' ? 'text-blue-400' : 'text-red-400'}`}> <AnimatedNumber n={kpi.value || 0} /> {kpi.delta && kpi.delta.value !== undefined && kpi.delta.direction !== 'neutral' && ( <span className={`text-xs flex items-center gap-1 ${deltaColor}`}> <i className={`fas fa-arrow-${kpi.delta.direction}`}></i> {Math.abs(kpi.delta.value)} </span> )} </div> <div className="text-xs text-[--text-secondary] mt-1">{kpi.label}</div> </div> ); })} </div> ); };
            const NumericInputWithArrows = ({ value, onChange, path, disabled, delta, isIncreaseGood = false, specialRule = null }) => { const intervalRef = useRef(null); const timeoutRef = useRef(null); const handleValueChange = (increment) => { const currentValue = parseInt(value, 10) || 0; const newValue = Math.max(0, currentValue + increment); onChange(path, newValue); }; const startPress = (increment) => { handleValueChange(increment); timeoutRef.current = setTimeout(() => { intervalRef.current = setInterval(() => { handleValueChange(increment); }, 100); }, 500); }; const stopPress = () => { clearTimeout(timeoutRef.current); clearInterval(intervalRef.current); }; let deltaColor = 'text-gray-400'; if (delta?.direction === 'up') { deltaColor = isIncreaseGood ? 'text-teal-400' : 'text-red-400'; } else if (delta?.direction === 'down') { deltaColor = isIncreaseGood ? 'text-red-400' : 'text-teal-400'; } if (specialRule === 'signed' && delta?.direction === 'down') { deltaColor = 'text-gray-400'; } if (specialRule === 'backlog' && delta?.direction === 'down') { deltaColor = 'text-gray-400'; } return ( <div className="flex items-center gap-2 justify-end"> {delta && delta.value !== undefined && delta.direction !== 'neutral' && ( <span className={`text-sm flex items-center gap-1 ${deltaColor}`}> <i className={`fas fa-arrow-${delta.direction}`}></i> {Math.abs(delta.value)} </span> )} <div className="flex flex-col gap-1"> <button className="w-8 h-8 bg-[--bg-tertiary] rounded-md flex items-center justify-center disabled:opacity-50 transition-transform transform hover:scale-110 active:scale-95" onClick={() => handleValueChange(1)} onMouseDown={() => startPress(1)} onMouseUp={stopPress} onMouseLeave={stopPress} onTouchStart={() => startPress(1)} onTouchEnd={stopPress} disabled={disabled}> <i className="fas fa-chevron-up"></i> </button> <button className="w-8 h-8 bg-[--bg-tertiary] rounded-md flex items-center justify-center disabled:opacity-50 transition-transform transform hover:scale-110 active:scale-95" onClick={() => handleValueChange(-1)} onMouseDown={() => startPress(-1)} onMouseUp={stopPress} onMouseLeave={stopPress} onTouchStart={() => startPress(-1)} onTouchEnd={stopPress} disabled={disabled}> <i className="fas fa-chevron-down"></i> </button> </div> <input className="w-20 p-2 text-2xl font-bold text-center bg-[--bg-primary] border border-[--border-color] rounded-lg disabled:bg-[--bg-tertiary]" type="number" value={value || 0} onChange={e => onChange(path, parseInt(e.target.value, 10) || 0)} disabled={disabled} /> </div> ); };
            const SectionCard = ({ id }) => { const { state, dispatch } = useContext(DashboardContext); const { dataForEditing = initialReportState, liveData = calculateTotals(initialReportState), previousValues = {}, userRole, lastUpdateInfo } = state || {}; const { t } = useTranslation(); const chartRef = useRef(null); const canvasRef = useRef(null); const cardId = id.replace('card-', ''); const cardInfo = cardDefinitions[cardId]; const theme = document.body.className; const signingOrder = ['כספים וחשבות', 'רכש, מכרזים ולוגיסטיקה', 'ענף גזברות']; const departmentIcons = { 'כספים וחשבות': 'fa-file-invoice-dollar', 'רכש, מכרזים ולוגיסטיקה': 'fa-gavel', 'ענף גזברות': 'fa-stamp' }; useEffect(() => { if (chartRef.current) { chartRef.current.destroy(); } const canvas = canvasRef.current; if (!canvas) return; const ctx = canvas.getContext('2d'); if (!ctx) return; if (cardId === 'overallStatus' && liveData?.computedMetrics && previousValues) { chartRef.current = new Chart(ctx, { type: 'bar', data: { labels: ['חתומות', 'ממתינות', 'דחויות'], datasets: [ { label: 'לפני', data: [previousValues.signedOrders || 0, calculateTotals(previousValues).computedMetrics.totalPending || 0, previousValues.rejectedOrders || 0], backgroundColor: 'rgba(148, 163, 184, 0.5)' }, { label: 'אחרי', data: [liveData.signedOrders, liveData.computedMetrics.totalPending, liveData.rejectedOrders], backgroundColor: ['#2dd4bf', '#3b82f6', '#f87171'] } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: theme.includes('dark') ? '#e2e8f0' : '#0f172a' } }, datalabels: { color: '#fff' } } } }); } else if (cardId === 'pendingSignature' && dataForEditing?.pendingSignature) { chartRef.current = new Chart(ctx, { type: 'bar', data: { labels: signingOrder, datasets: [ { label: 'לפני', data: signingOrder.map(label => previousValues?.pendingSignature?.[label] || 0), backgroundColor: 'rgba(148, 163, 184, 0.5)' }, { label: 'אחרי', data: signingOrder.map(label => dataForEditing.pendingSignature?.[label] || 0), backgroundColor: '#a78bfa' } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: theme.includes('dark') ? '#e2e8f0' : '#0f172a' } }, datalabels: { color: '#fff' } } } }); } }, [liveData, dataForEditing, theme, cardId, previousValues]); const handleInputChange = (fieldPath, value) => { dispatch({ type: 'UPDATE_EDITING_FIELD', payload: { fieldPath, value } }); }; const getDeltaForField = (fieldPath) => { const pathParts = fieldPath.split('.'); let current = dataForEditing; let previous = previousValues; for (const part of pathParts) { current = current?.[part]; previous = previous?.[part]; } if (previous === undefined || current === undefined || Object.keys(previousValues || {}).length === 0) return { value: undefined }; const delta = current - previous; const direction = delta > 0 ? 'up' : delta < 0 ? 'down' : 'neutral'; return { value: delta, direction }; }; const renderContent = () => { if (cardId === 'overallStatus') { return ( <div className="h-48 mt-4"><canvas ref={canvasRef}></canvas></div> ); } if (cardId === 'signedOrders') { return ( <React.Fragment> <div className="flex justify-between items-center mb-3"><p>{t('signed_backlog')}</p><NumericInputWithArrows value={dataForEditing.signedOrders} onChange={handleInputChange} path="signedOrders" disabled={userRole !== 'admin'} delta={getDeltaForField("signedOrders")} isIncreaseGood={true} specialRule="signed" /></div> <div className="flex justify-between items-center mb-3"><p>{t('existing_backlog')}</p><NumericInputWithArrows value={dataForEditing.existingBacklog} onChange={handleInputChange} path="existingBacklog" disabled={userRole !== 'admin'} delta={getDeltaForField("existingBacklog")} isIncreaseGood={false} specialRule="backlog" /></div> <div className="w-full h-2 bg-[--bg-tertiary] rounded-full overflow-hidden mt-2.5"> <div className="h-full bg-teal-500 rounded-full transition-all duration-500" style={{ width: `${liveData.computedMetrics?.goalPercentage?.toFixed(1) || 0}%` }}></div> </div> </React.Fragment> ); } if (cardId === 'pendingSignature') { const reversedSigningOrder = [...signingOrder].reverse(); return ( <React.Fragment> <div className="h-48 mb-5"><canvas ref={canvasRef}></canvas></div> <div className="space-y-3"> {reversedSigningOrder.map(branch => ( <div className="flex justify-between items-center" key={branch}> <p className="flex items-center gap-2"><i className={`fas ${departmentIcons[branch]}`}></i> {branch}</p> <NumericInputWithArrows value={dataForEditing.pendingSignature?.[branch] || 0} onChange={handleInputChange} path={`pendingSignature.${branch}`} disabled={userRole !== 'admin'} delta={getDeltaForField(`pendingSignature.${branch}`)} isIncreaseGood={false} /> </div> ))} </div> </React.Fragment> ); } if (['rejectedOrders', 'pendingAncillaryForm', 'pendingCorrection', 'pendingAssetNumberEntry'].includes(cardId)) { return <div className="flex justify-center items-center h-full"><NumericInputWithArrows value={dataForEditing[cardId] || 0} onChange={handleInputChange} path={cardId} disabled={userRole !== 'admin'} delta={getDeltaForField(cardId)} isIncreaseGood={false} /></div>; } return <div className="flex justify-center items-center h-full"><p>No view available</p></div>; }; let title = t(cardInfo.titleKey); if (cardId === 'pendingSignature') { title = `${title} (${liveData.computedMetrics?.totalPendingSignature || 0})`; } if (cardId === 'signedOrders') { title = `${t(cardInfo.titleKey)} (${liveData.computedMetrics?.backlogDifference || 0})`; } return ( <div className={`bg-[--bg-primary] rounded-2xl p-6 relative overflow-hidden border border-[--border-color] transition-all duration-300 transform hover:-translate-y-1 hover:shadow-2xl hover:shadow-teal-500/10`}> <div className={`absolute top-0 right-0 h-1.5 w-full bg-${cardInfo.color}-500`}></div> <h3 className="flex items-center justify-center gap-2.5 text-xl font-bold mb-1"><i className={`fas ${cardInfo.icon}`}></i><span>{title}</span></h3> {cardInfo.subtitleKey && <p className="text-xs text-[--text-secondary] mb-3 text-center">{t(cardInfo.subtitleKey)}</p>} {renderContent()} {lastUpdateInfo && <div className="text-xs text-[--text-secondary] mt-4 text-center">{t('last_updated', { time: lastUpdateInfo.time })}</div>} </div> ); };
        const Clock = () => { const [time, setTime] = useState(new Date()); useEffect(() => { const timerId = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(timerId); }, []); return ( <div className="text-lg font-semibold text-slate-400 tabular-nums"> <span>{time.toLocaleDateString('he-IL')}</span> <span className="mx-2">|</span> <span>{time.toLocaleTimeString('he-IL')}</span> </div> ); };
        const SystemLogo = ({ mirrored = false }) => ( <div className={`relative w-16 h-16 ${mirrored ? 'transform -scale-x-100' : ''}`}> <svg viewBox="0 0 100 100" className="w-full h-full"> <path d="M 10 50 Q 50 20 90 50 Q 50 80 10 50 Z" fill="none" stroke="var(--status-good-primary)" strokeWidth="3"/> <circle cx="50" cy="50" r="10" fill="var(--status-good-primary)"/> <defs> <linearGradient id="radar-gradient" x1="0%" y1="0%" x2="100%" y2="0%"> <stop offset="0%" style={{stopColor: 'var(--status-good-glow)', stopOpacity: 0}} /> <stop offset="100%" style={{stopColor: 'var(--status-good-glow)', stopOpacity: 0.7}} /> </linearGradient> </defs> <path d="M 50 50 L 90 50 A 40 40 0 0 1 50 10 Z" fill="url(#radar-gradient)" style={{ transformOrigin: '50% 50%', animation: 'radar-sweep 3s linear infinite' }} /> </svg> </div> );
        const AnimatedNumber = ({ n }) => { const [number, setNumber] = useState(0); useEffect(() => { const end = n || 0; if (number === end) return; const frameDuration = 1000 / 60; const totalFrames = Math.round(1000 / frameDuration); let frame = 0; const counter = setInterval(() => { frame++; const progress = frame / totalFrames; const current = Math.round(end * progress); setNumber(current); if (frame === totalFrames) { clearInterval(counter); setNumber(end); } }, frameDuration); return () => clearInterval(counter); }, [n]); return <span>{number}</span>; };
        
        const DailyFocusAI = ({ trigger, onComplete }) => { const { t } = useTranslation(); const { state } = useContext(DashboardContext); const { liveData } = state; const [focus, setFocus] = useState(''); const [isLoading, setIsLoading] = useState(false); const generateFocus = useCallback(async () => { if (!liveData) return; setIsLoading(true); const prompt = `Based on this data, what is the single most critical area to focus on today? Respond in Hebrew with one short, actionable sentence. Data: ${JSON.stringify(liveData)}`; try { const response = await callGeminiAPI(prompt); setFocus(response); } catch (error) { setFocus(t('data_analysis_error')); } finally { setIsLoading(false); onComplete(); } }, [liveData, t, onComplete]); useEffect(() => { if(trigger) { generateFocus(); } }, [trigger, generateFocus]); if (!focus && !isLoading) return null; return ( <div className="bg-[--bg-secondary] rounded-2xl p-4 mb-5 border border-teal-500/50 shadow-lg"> <h3 className="flex items-center justify-center gap-2.5 text-lg font-bold text-center text-teal-400"><i className="fas fa-crosshairs"></i> {t('daily_focus_title')}</h3> <div className="text-center text-[--text-secondary] mt-2"> {isLoading ? <div className="flex items-center justify-center gap-2"><div className="w-4 h-4 border-2 border-teal-400 border-t-transparent rounded-full animate-spin"></div><span>{t('analyzing_data')}</span></div> : <p>{focus}</p>} </div> </div> ); };
        
        const Modal = ({ activeModal, setActiveModal, onExport, exportSelection, setExportSelection }) => { const { t } = useTranslation(); if (!activeModal) return null; const handleCheckboxChange = (cardId) => { setExportSelection(prev => ({ ...prev, [cardId]: !prev[cardId] })); }; useEffect(() => { if (activeModal === 'exportOptions') { const initialSelection = Object.keys(cardDefinitions).reduce((acc, key) => { acc[key] = true; return acc; }, {}); setExportSelection(initialSelection); } }, [activeModal]); const renderModalContent = () => { switch(activeModal) { case 'history': return <VersionHistoryContent />; case 'bit': { const report = { summary: t('bit_report_summary_ok'), checks: [ { name: t('bit_check_code'), status: t('pass') }, { name: t('bit_check_functionality'), status: t('pass') }, { name: t('bit_check_ui'), status: t('pass') }, { name: t('bit_check_api'), status: navigator.onLine ? t('pass') : t('fail') }, ] }; return <> <h2>{t('bit_results_title')}</h2> <p>{report.summary}</p> <div className="divide-y divide-[--border-color] mt-4"> {report.checks.map(check => <div key={check.name} className="flex justify-between py-2"><span className="text-[--text-secondary]">{check.name}</span><span className={check.status === t('pass') ? 'text-teal-400 font-bold' : 'text-red-400 font-bold'}>{check.status}</span></div>)} </div> </>; } case 'exportOptions': return <> <h2>{t('export_options')}</h2> <p>{t('export_select_cards')}</p> <ul className="mt-4 space-y-2"> {Object.keys(cardDefinitions).map(key => ( <li key={key}> <label className="flex items-center gap-3 cursor-pointer"> <input type="checkbox" checked={!!exportSelection[key]} onChange={() => handleCheckboxChange(key)} className="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500" /> {t(cardDefinitions[key].titleKey)} </label> </li> ))} </ul> <div className="grid grid-cols-2 gap-4 mt-6"> <button className="w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-teal-600 border-teal-500 text-white hover:bg-teal-500" onClick={() => onExport('png')}><i className="fas fa-file-image"></i> {t('export')} PNG</button> <button className="w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-teal-600 border-teal-500 text-white hover:bg-teal-500" onClick={() => onExport('pdf')}><i className="fas fa-file-pdf"></i> {t('export')} PDF</button> </div> </>; default: return null; } }; return ( <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" onClick={() => setActiveModal(null)}> <div className="bg-[--bg-secondary] p-6 rounded-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto border border-[--border-color]" onClick={e => e.stopPropagation()}> <div className="flex justify-end mb-4"><button onClick={() => setActiveModal(null)} className="text-2xl text-[--text-secondary] hover:text-[--text-primary]">&times;</button></div> {renderModalContent()} </div> </div> ); };
        const IntelligenceHQ = ({ triggerAi }) => { const { t } = useTranslation(); const { state } = useContext(DashboardContext); const { liveData } = state; if (!liveData?.computedMetrics || (liveData.computedMetrics.totalPending === 0 && liveData.signedOrders === 0 && liveData.rejectedOrders === 0)) { return ( <div className="text-center p-10 bg-[--bg-secondary] rounded-2xl border border-[--border-color]"> <i className="fas fa-info-circle text-4xl text-blue-400 mb-4"></i> <h2 className="text-2xl font-bold">ממתין לנתונים</h2> <p className="text-[--text-secondary]">יכולות ה-AI והניתוח יופעלו אוטומטית לאחר שמירת הנתונים ב"גשר הפיקוד".</p> </div> ); } return ( <div className="space-y-5"> <h2 className="text-2xl font-bold text-center text-teal-400">{t('tab_intelligence_hq')}</h2> <InteractiveAnalyticsHQ /> <ProactiveInsights trigger={triggerAi} /> <AnomalyAnalyzer /> <SummaryGenerator /> <StrategicAdvisor /> </div> ); };
        const ProactiveInsights = ({ trigger }) => { const { t } = useTranslation(); const [insight, setInsight] = useState(''); const [isLoading, setIsLoading] = useState(false); const { state } = useContext(DashboardContext); const { liveData } = state; const generateProactiveInsight = useCallback(async () => { if (!liveData) return; setIsLoading(true); const prompt = `This is the report. Based on the current operational data, identify one potential immediate bottleneck and provide a proactive recommendation. Data: ${JSON.stringify(liveData)}. Respond in Hebrew.`; try { const response = await callGeminiAPI(prompt); setInsight(response); } catch (error) { setInsight("שגיאה בהפקת תובנה פרואקטיבית."); } finally { setIsLoading(false); } }, [liveData]); useEffect(() => { if(trigger) { generateProactiveInsight(); } }, [trigger, generateProactiveInsight]); return ( <div className="bg-[--bg-secondary] rounded-2xl p-6 border border-[--border-color]"> <div className="flex justify-between items-center mb-2"> <h3 className="flex items-center gap-2.5 text-xl font-bold"><i className="fas fa-lightbulb text-yellow-400"></i> <span>{t('proactive_insights')}</span></h3> <button onClick={generateProactiveInsight} disabled={isLoading} className="px-3 py-1 text-xs font-semibold text-white bg-teal-600 rounded-full hover:bg-teal-700 disabled:opacity-50 disabled:cursor-not-allowed"> {isLoading ? <span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin inline-block"></span> : <i className="fas fa-sync"></i>} </button> </div> <div className="text-[--text-secondary] text-sm leading-relaxed min-h-[6rem]"> {isLoading ? <div className="h-24 skeleton-loader rounded-lg"></div> : <p>{insight}</p>} </div> </div> ); };
        const AnomalyAnalyzer = () => { const { state, dispatch } = useContext(DashboardContext); const { liveData } = state; const { t } = useTranslation(); const [isAnomaly, setIsAnomaly] = useState(false); const [analysis, setAnalysis] = useState(''); const [isAnalyzing, setIsAnalyzing] = useState(false); useEffect(() => { if (!liveData) return; const { rejectedOrders, signedOrders } = liveData; const threshold = 0.25; const anomalyCondition = rejectedOrders > 2 && (signedOrders > 0 ? (rejectedOrders / signedOrders) > threshold : true); setIsAnomaly(anomalyCondition); if (anomalyCondition) { dispatch({ type: 'ADD_NOTIFICATION', payload: { id: Date.now(), text: t('anomaly_detected') } }); } }, [liveData]); const handleAnalyze = async () => { setIsAnalyzing(true); setAnalysis(''); const prompt = `An anomaly was detected in today's data: ${JSON.stringify(liveData)}. Provide 3-5 possible root causes for the anomaly and suggest which specific data points to investigate. Respond in Hebrew as a bulleted list.`; try { const response = await callGeminiAPI(prompt); setAnalysis(response); } catch (error) { setAnalysis("שגיאה בניתוח האנומליה."); } finally { setIsAnalyzing(false); } }; if (!isAnomaly) return null; return ( <div className="mt-4 p-4 bg-[--bg-tertiary] rounded-lg border-r-4 border-r-orange-500"> <h4 className="flex items-center justify-between gap-2 font-bold text-orange-400"> <div className="flex items-center gap-2"><i className="fas fa-exclamation-triangle"></i> {t('anomaly_detected')}</div> <button onClick={handleAnalyze} disabled={isAnalyzing} className="px-3 py-1 text-xs font-semibold text-white bg-orange-500 rounded-full hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed"> {isAnalyzing ? <span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin inline-block"></span> : t('analyze_anomaly')} </button> </h4> <p className="text-sm text-[--text-secondary] mt-1">{t('anomaly_desc')}</p> {analysis && ( <div className="mt-3 pt-3 border-t border-[--border-color]"> <p className="text-sm text-[--text-secondary] whitespace-pre-wrap">{analysis}</p> </div> )} </div> ); };
        const SummaryGenerator = () => { const { t } = useTranslation(); const { state } = useContext(DashboardContext); const { liveData } = state; const [summary, setSummary] = useState(''); const [isLoading, setIsLoading] = useState(false); const [copySuccess, setCopySuccess] = useState(''); const handleGenerate = async () => { setIsLoading(true); setSummary(''); const prompt = `Generate a concise executive summary in Hebrew based on the following data for today. Format it with markdown bullet points for Achievements, Challenges, and Recommendations. Data: ${JSON.stringify(liveData)}`; try { const response = await callGeminiAPI(prompt); setSummary(response); } catch (error) { setSummary("שגיאה בהפקת הסיכום."); } finally { setIsLoading(false); } }; const handleCopy = () => { const textArea = document.createElement("textarea"); textArea.value = summary; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea); setCopySuccess(t('copied')); setTimeout(() => setCopySuccess(''), 2000); }; return ( <div className="bg-[--bg-secondary] rounded-2xl p-6 border border-[--border-color]"> <h3 className="text-xl font-bold text-center mb-4">{t('summary_generator')}</h3> <div className="flex items-center justify-center gap-4"> <button onClick={handleGenerate} disabled={isLoading} className="w-full sm:w-auto inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-teal-600 border-teal-500 text-white hover:bg-teal-500 disabled:opacity-50"> {isLoading ? <span className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span> : t('generate_summary')} </button> </div> {summary && ( <div className="mt-4 p-4 bg-[--bg-primary] rounded-lg relative"> <button onClick={handleCopy} className="absolute top-2 right-2 px-3 py-1 text-xs bg-[--bg-tertiary] rounded-full hover:bg-opacity-75">{copySuccess || t('copy_to_clipboard')}</button> <pre className="whitespace-pre-wrap text-sm leading-relaxed">{summary}</pre> </div> )} </div> ); };
        const StrategicAdvisor = () => { const { state } = useContext(DashboardContext); const { liveData } = state; const { t } = useTranslation(); const [personnel, setPersonnel] = useState(1); const [ordersPerDay, setOrdersPerDay] = useState(2); const [goalDays, setGoalDays] = useState(10); const [actionPlan, setActionPlan] = useState(''); const [isLoading, setIsLoading] = useState(false); const handleGetPlan = async () => { setIsLoading(true); setActionPlan(''); const prompt = `I need to clear ${liveData.computedMetrics?.totalPending || 0} pending orders. My goal is to do it in ${goalDays} days. I have ${personnel} staff members, and their current processing rate is ${ordersPerDay} orders per day per staff member. Provide a concrete, bulleted action plan in Hebrew to achieve this goal. Analyze the bottlenecks based on this data: ${JSON.stringify(liveData)}.`; try { const response = await callGeminiAPI(prompt); setActionPlan(response); } catch (error) { setActionPlan("שגיאה ביצירת תוכנית פעולה."); } finally { setIsLoading(false); } }; return ( <div className="bg-[--bg-secondary] rounded-2xl p-6 border border-[--border-color]"> <h2 className="text-xl font-bold text-center mb-4">{t('scenario_engine_title')}</h2> <div className="grid grid-cols-1 md:grid-cols-2 gap-6 items-start"> <div className="space-y-4"> <div> <label className="text-sm font-medium flex justify-between"><span>{t('staff_members')}</span><span>{personnel}</span></label> <input type="range" min="1" max="10" value={personnel} onChange={e => setPersonnel(parseInt(e.target.value, 10))} className="w-full h-2 bg-[--bg-tertiary] rounded-lg appearance-none cursor-pointer" /> </div> <div> <label className="text-sm font-medium flex justify-between"><span>{t('processing_rate')}</span><span>{ordersPerDay}</span></label> <input type="range" min="1" max="10" value={ordersPerDay} onChange={e => setOrdersPerDay(parseInt(e.target.value, 10))} className="w-full h-2 bg-[--bg-tertiary] rounded-lg appearance-none cursor-pointer" /> </div> <div className="flex items-center gap-2"> <label className="text-sm font-medium whitespace-nowrap">{t('set_goal')}</label> <input type="number" value={goalDays} onChange={e => setGoalDays(parseInt(e.target.value, 10) || 1)} className="w-20 p-2 text-center bg-[--bg-primary] border border-[--border-color] rounded-lg" /> <span className="text-sm">{t('days')}</span> </div> <button onClick={handleGetPlan} disabled={isLoading} className="w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-teal-600 border-teal-500 text-white hover:bg-teal-500 disabled:opacity-50"> {isLoading ? <span className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span> : t('get_action_plan')} </button> </div> <div className="bg-[--bg-primary] p-4 rounded-xl min-h-[200px]"> {isLoading ? <div className="w-full h-full skeleton-loader rounded-lg"></div> : <pre className="whitespace-pre-wrap text-sm leading-relaxed">{actionPlan || "תוכנית הפעולה תופיע כאן..."}</pre>} </div> </div> </div> ); };
        const InteractiveAnalyticsHQ = () => { const { t } = useTranslation(); const { state } = useContext(DashboardContext); const { liveData } = state; const [query, setQuery] = useState(""); const [isLoading, setIsLoading] = useState(false); const [response, setResponse] = useState(null); const chartContainerRef = useRef(null); const chartInstanceRef = useRef(null); const theme = document.body.className; useEffect(() => { if (chartInstanceRef.current) { chartInstanceRef.current.destroy(); } if (!response || !response.chartData || !chartContainerRef.current) return; const ctx = chartContainerRef.current.getContext('2d'); chartInstanceRef.current = new Chart(ctx, { type: response.chartData.type, data: response.chartData.data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: response.chartData.data.datasets.length > 1, labels: { color: theme.includes('dark') ? '#e2e8f0' : '#0f172a' } }, datalabels: { color: '#fff' } }, scales: { y: { ticks: { color: theme.includes('dark') ? '#94a3b8' : '#475569' } }, x: { ticks: { color: theme.includes('dark') ? '#94a3b8' : '#475569' } } } } }); }, [response, theme]); const handleQuerySubmit = async (e) => { e.preventDefault(); if (!query) return; setIsLoading(true); setResponse(null); if (chartInstanceRef.current) { chartInstanceRef.current.destroy(); } const jsonSchema = { type: "OBJECT", properties: { "answer": { "type": "STRING" }, "chartData": { "type": "OBJECT", "properties": { "type": { "type": "STRING" }, "data": { "type": "OBJECT", "properties": { "labels": { "type": "ARRAY", "items": { "type": "STRING" } }, "datasets": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "label": { "type": "STRING" }, "data": { "type": "ARRAY", "items": { "type": "NUMBER" } }, "backgroundColor": { "type": "ARRAY", "items": { "type": "STRING" } } } } } } } } } } }; const prompt = `Analyze the user's question and the provided data. Respond in Hebrew. 1.  Provide a direct textual answer to the question. 2.  If the question implies a visual comparison, trend, or distribution, generate the necessary configuration for a Chart.js chart. - Choose the best chart type (bar, pie, line). - Populate labels and datasets accurately from the data. - Use appealing colors from this list for backgrounds: ['#2dd4bf', '#3b82f6', '#f87171', '#a78bfa', '#fb923c', '#facc15']. - If no chart is relevant, return null for the chartData field. Current Data: ${JSON.stringify(liveData)}.  User Question: "${query}"`; try { const apiResponse = await callGeminiAPI(prompt, jsonSchema); const parsedResponse = JSON.parse(apiResponse); setResponse(parsedResponse); } catch (error) { console.error("Error parsing AI response:", error); setResponse({ answer: "שגיאה בניתוח הבקשה ויצירת התרשים.", chartData: null }); } finally { setIsLoading(false); } }; return ( <div className="space-y-5"> <div className="bg-[--bg-secondary] rounded-2xl p-4 border border-[--border-color]"> <form className="flex gap-2" onSubmit={handleQuerySubmit}> <i className="fas fa-search text-[--text-secondary] self-center"></i> <input type="text" placeholder={t('nlq_placeholder')} value={query} onChange={(e) => setQuery(e.target.value)} className="flex-grow bg-transparent focus:outline-none"/> <button type="submit" disabled={isLoading} className="px-4 py-1.5 text-sm font-semibold bg-teal-500 text-white rounded-lg hover:bg-teal-600 disabled:opacity-50"> {isLoading ? <span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin inline-block"></span> : t('ask')} </button> </form> {isLoading && <div className="mt-3 pt-3 border-t border-[--border-color] text-sm text-[--text-secondary]">{t('thinking')}</div>} {response && response.answer && <div className="mt-3 pt-3 border-t border-[--border-color] text-sm text-[--text-secondary]">{response.answer}</div>} </div> {response && response.chartData && ( <div className="bg-[--bg-secondary] rounded-2xl p-6 border border-[--border-color]"> <h3 className="text-xl font-bold text-center mb-4">תצוגה גרפית לשאילתה</h3> <div className="relative h-72"> <canvas ref={chartContainerRef}></canvas> </div> </div> )} </div> ); };
        const SharingCenter = ({ setActiveModal, handleShareLink }) => { const { t } = useTranslation(); return ( <div className="space-y-5"> <h2 className="text-2xl font-bold text-center text-teal-400">{t('tab_sharing_center')}</h2> <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"> <div className="bg-[--bg-secondary] p-4 rounded-xl border border-[--border-color] flex flex-col items-center text-center"> <i className="fas fa-file-export text-3xl text-teal-400 mb-3"></i> <h3 className="font-bold mb-2">{t('export')}</h3> <p className="text-xs text-[--text-secondary] mb-3 flex-grow">צור קובץ PNG או PDF של הדשבורד לשיתוף קל.</p> <button className="w-full mt-auto inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2 px-4 cursor-pointer transition-all duration-200 border bg-teal-600 border-teal-500 text-white hover:bg-teal-500" onClick={() => setActiveModal('exportOptions')}>{t('export_options')}</button> </div> <div className="bg-[--bg-secondary] p-4 rounded-xl border border-[--border-color] flex flex-col items-center text-center"> <i className="fas fa-link text-3xl text-teal-400 mb-3"></i> <h3 className="font-bold mb-2">{t('share_link')}</h3> <p className="text-xs text-[--text-secondary] mb-3 flex-grow">העתק קישור ישיר לדשבורד זה.</p> <button className="w-full mt-auto inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2 px-4 cursor-pointer transition-all duration-200 border bg-teal-600 border-teal-500 text-white hover:bg-teal-500" onClick={handleShareLink}>{t('share_link')}</button> </div> <div className="bg-[--bg-secondary] p-4 rounded-xl border border-[--border-color] flex flex-col items-center text-center"> <i className="fab fa-whatsapp text-3xl text-teal-400 mb-3"></i> <h3 className="font-bold mb-2">{t('share_whatsapp')}</h3> <p className="text-xs text-[--text-secondary] mb-3 flex-grow">שלח קישור לדשבורד דרך וואטסאפ.</p> <a href={`https://api.whatsapp.com/send?text=${encodeURIComponent('Check out the Project Sentinel Dashboard: ' + window.location.href)}`} target="_blank" rel="noopener noreferrer" className="w-full mt-auto inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2 px-4 cursor-pointer transition-all duration-200 border bg-teal-600 border-teal-500 text-white hover:bg-teal-500">{t('share_whatsapp')}</a> </div> </div> </div> ); };
        const BackupAndRestore = ({ showMessage }) => {
            const { t } = useTranslation();
            const { state, dispatch, db, userId } = useContext(DashboardContext);
            const fileInputRef = useRef(null);
            const handleBackupData = () => {
                if (!state.allReports || Object.keys(state.allReports).length === 0) {
                    showMessage(t('backup_error_no_data'), true);
                    return;
                }
                const dataStr = JSON.stringify(state.allReports, null, 2);
                const dataBlob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.download = `sentinel_data_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
                showMessage("גיבוי הנתונים נוצר בהצלחה.");
            };
            const handleRestoreData = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const restoredData = JSON.parse(e.target.result);
                        if (typeof restoredData !== 'object' || restoredData === null) {
                            throw new Error("Invalid format");
                        }
                        const appId = window.__app_id || 'default-app-id';
                        const docRef = window.firebaseSDK.doc(db, `/artifacts/${appId}/public/data/sentinelReports`, 'allReports');
                        await window.firebaseSDK.setDoc(docRef, restoredData, { merge: true });
                        showMessage(t('restore_success'));
                    } catch (err) {
                        showMessage(t('restore_error'), true);
                    }
                };
                reader.readAsText(file);
                event.target.value = null;
            };
            const handleBackupCode = () => {
                try {
                    const htmlContent = document.documentElement.outerHTML;
                    const blob = new Blob([htmlContent], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = 'sentinel_source_code_backup.html';
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error("Source code backup failed:", error);
                    showMessage(t('backup_error_code'), true);
                }
            };
            return ( <div className="bg-[--bg-primary] p-4 rounded-lg border border-[--border-color] space-y-3">
                <button onClick={handleBackupData} className="w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-[--bg-secondary] text-[--text-primary] border-[--border-color] hover:bg-[--bg-tertiary]">{t('backup_data')}</button>
                <button onClick={() => fileInputRef.current && fileInputRef.current.click()} className="w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-[--bg-secondary] text-[--text-primary] border-[--border-color] hover:bg-[--bg-tertiary]">{t('restore_data')}</button>
                <input type="file" ref={fileInputRef} onChange={handleRestoreData} accept=".json" className="hidden" />
                <button onClick={handleBackupCode} className="w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-[--bg-secondary] text-[--text-primary] border-[--border-color] hover:bg-[--bg-tertiary]">{t('backup_code')}</button>
            </div> );
        };
        const CodeBlock = ({ children }) => { const [copied, setCopied] = useState(false); const handleCopy = () => { navigator.clipboard.writeText(children).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); }); }; return ( <div className="bg-slate-900/70 rounded-md p-3 relative font-mono text-xs text-left dir-ltr"> <button onClick={handleCopy} className="absolute top-2 right-2 px-2 py-1 text-xs bg-slate-700 rounded-md hover:bg-slate-600 transition-colors"> {copied? 'Copied!' : 'Copy'} </button> <pre><code>{children}</code></pre> </div> ); };
        const DeploymentGuide = () => { const { t } = useTranslation(); return ( <div className="bg-[--bg-primary] p-4 rounded-lg border border-[--border-color] space-y-4 text-sm"> <h3 className="text-lg font-bold text-center">{t('deployment_guide_title')}</h3> <div className="space-y-2"> <h4 className="font-semibold">{t('deployment_guide_step1_title')}</h4> <p className="text-[--text-secondary]">{t('deployment_guide_step1_desc')}</p> </div> <div className="space-y-2"> <h4 className="font-semibold">{t('deployment_guide_step2_title')}</h4> <p className="text-[--text-secondary]">{t('deployment_guide_step2_desc')}</p> </div> <div className="space-y-2"> <h4 className="font-semibold">{t('deployment_guide_step3_title')}</h4> <p className="text-[--text-secondary]">{t('deployment_guide_step3_desc')}</p> <ul className="space-y-2 text-[--text-secondary]"> <li>{t('deployment_guide_step3_li1')}<CodeBlock>git init</CodeBlock></li> <li>{t('deployment_guide_step3_li2')}<CodeBlock>git add index.html</CodeBlock></li> <li>{t('deployment_guide_step3_li3')}<CodeBlock>git commit -m "Initial commit"</CodeBlock></li> <li>{t('deployment_guide_step3_li4')}<CodeBlock>git remote add origin YOUR_REPOSITORY_URL.git</CodeBlock></li> <li>{t('deployment_guide_step3_li5')}<CodeBlock>git push -u origin main</CodeBlock></li> </ul> </div> <div className="space-y-2"> <h4 className="font-semibold">{t('deployment_guide_step4_title')}</h4> <p className="text-[--text-secondary]">{t('deployment_guide_step4_desc')}</p> <ol className="list-decimal list-inside space-y-1 text-[--text-secondary]"> <li>{t('deployment_guide_step4_li1')}</li> <li>{t('deployment_guide_step4_li2')}</li> <li>{t('deployment_guide_step4_li3')}</li> <li>{t('deployment_guide_step4_li4')}</li> </ol> </div> <div className="space-y-2"> <h4 className="font-semibold">{t('deployment_guide_step5_title')}</h4> <p className="text-[--text-secondary]">{t('deployment_guide_step5_desc')}</p> <ul className="space-y-2 text-[--text-secondary]"> <li>{t('deployment_guide_step5_li1')}<CodeBlock>git add .</CodeBlock></li> <li>{t('deployment_guide_step5_li2')}<CodeBlock>git commit -m "Update dashboard"</CodeBlock></li> <li>{t('deployment_guide_step5_li3')}<CodeBlock>git push</CodeBlock></li> </ul> </div> </div> ); };
        const VersionHistoryContent = () => { const { t } = useTranslation(); return ( <div className="bg-[--bg-primary] p-4 rounded-lg border border-[--border-color] space-y-4"> <h3 className="text-lg font-bold text-center">{t('version_history')}</h3> <ul className="space-y-3"> {versionHistory.map(v => ( <li key={v.version} className="p-3 bg-[--bg-secondary] rounded-lg"> <div className="flex justify-between items-center"> <span className="font-bold text-teal-400">{v.version}</span> <span className="text-xs text-[--text-secondary]">{v.date}</span> </div> <ul className="list-disc list-inside text-sm text-[--text-secondary] mt-1"> {v.changes.map((change, i) => <li key={i}>{change}</li>)} </ul> </li> ))} </ul> </div> ); };
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<React.StrictMode><LanguageProvider><DashboardProvider><App /></DashboardProvider></LanguageProvider></React.StrictMode>);
    });
    </script>
</body>
</html>

