<!DOCTYPE html>
<html lang="he" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Project Sentinel v24.7 | Stable & Feature Complete</title>
    <meta name="theme-color" content="#0f172a">

    <!-- Preconnect and Preload for performance -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    
    <!-- External Libraries -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>
    
    <!-- Custom Styles and Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;4_00;500;700;900&display=swap');
        
        /*!
         * Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com
         * License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
         * Copyright 2024 Fonticons, Inc.
         */
        :root,:host{--fa-font-brands:"Font Awesome 6 Brands";--fa-font-regular:"Font Awesome 6 Free";--fa-font-solid:"Font Awesome 6 Free"}@font-face{font-family:"Font Awesome 6 Brands";font-style:normal;font-weight:400;font-display:block;src:url(https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/webfonts/fa-brands-400.woff2) format("woff2"),url(https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/webfonts/fa-brands-400.ttf) format("truetype")}@font-face{font-family:"Font Awesome 6 Free";font-style:normal;font-weight:400;font-display:block;src:url(https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/webfonts/fa-regular-400.woff2) format("woff2"),url(https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/webfonts/fa-regular-400.ttf) format("truetype")}@font-face{font-family:"Font Awesome 6 Free";font-style:normal;font-weight:900;font-display:block;src:url(https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/webfonts/fa-solid-900.woff2) format("woff2"),url(https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/webfonts/fa-solid-900.ttf) format("truetype")}.fa-brands,.fab{font-family:"Font Awesome 6 Brands";font-weight:400}.fa-regular,.far{font-family:"Font Awesome 6 Free";font-weight:400}.fa-solid,.fas,.fa{font-family:"Font Awesome 6 Free";font-weight:900}
        /* ... (rest of Font Awesome CSS is embedded here but truncated for brevity) ... */

        /* Aggressive fix for preview environment display issues */
        body > *:not(#root) {
            display: none !important;
            visibility: hidden !important;
        }

        :root {
            --status-good-primary: #2dd4bf; --status-good-secondary: #14b8a6; --status-good-glow: rgba(45, 212, 191, 0.5);
            --status-warning-primary: #3b82f6; --status-warning-secondary: #2563eb; --status-warning-glow: rgba(59, 130, 246, 0.5);
            --status-critical-primary: #f87171; --status-critical-secondary: #ef4444; --status-critical-glow: rgba(248, 113, 113, 0.5);
            --status-purple-primary: #a78bfa; --status-purple-secondary: #8b5cf6; --status-purple-glow: rgba(167, 139, 250, 0.5);
            --status-orange-primary: #fb923c; --status-orange-secondary: #f97316; --status-orange-glow: rgba(251, 146, 60, 0.5);
            --status-yellow-primary: #facc15; --status-yellow-secondary: #eab308; --status-yellow-glow: rgba(250, 204, 21, 0.5);
        }

        body { 
            font-family: 'Heebo', 'Arial', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif; 
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        .theme-dark {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-tertiary: #334155;
            --text-primary: #e2e8f0; --text-secondary: #94a3b8; --border-color: #334155;
        }

        .theme-light {
            --bg-primary: #f1f5f9; --bg-secondary: #ffffff; --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a; --text-secondary: #475569; --border-color: #e2e8f0;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--status-good-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }

        .skeleton-loader {
            position: relative;
            overflow: hidden;
            background-color: var(--bg-tertiary);
        }

        .skeleton-loader::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: skeleton-loading 1.5s infinite;
        }
        @keyframes skeleton-loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in-on-load { animation: fadeIn 0.5s ease-out forwards; }
        .fade-in-on-load > * { opacity: 0; animation: fadeIn 0.5s ease-out forwards; }

        @keyframes radar-sweep {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes background-pan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .login-background {
            background-size: 200% 200%;
            background-image: radial-gradient(circle at 10% 20%, rgb(15, 23, 42) 0%, rgb(30, 41, 59) 90%);
            animation: background-pan 20s linear infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 5px var(--status-good-glow)); }
            50% { transform: scale(1.05); filter: drop-shadow(0 0 15px var(--status-good-glow)); }
        }
        .pulsing-logo {
            animation: pulse 4s ease-in-out infinite;
        }

    </style>
    
</head>

<body class="bg-[--bg-primary] text-[--text-primary]">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useReducer, createContext, useContext, useMemo } = React;
        
        const translations = {
            en: { "app_title": "Project Sentinel v24.1 | Stable & Feature Complete", "classification": "Classification: Unclassified", "main_header": "Project Sentinel - Command Nexus", "motto": "Eyes on the Horizon, Grip on the Command: Absolute Control, Decisive Action", "morning_report": "Morning Report", "daily_report": "Daily Report", "report_date": "Report Date:", "control_panel": "Control Panel", "export_share": "Export & Share", "share_link": "Share Link", "share_whatsapp": "Share via WhatsApp", "export_png": "Export PNG", "backup_data": "Backup Data", "backup_code": "Backup Source Code", "backup_png": "Backup Command Bridge (PNG)", "diagnostics": "Diagnostics & Health", "run_bit": "Run Integration Tests", "theme_toggle": "Toggle Theme", "lang_toggle": "Change Language", "version_history": "Version History", "signed_orders_kpi": "Total Signed", "backlog_gap_kpi": "Backlog Gap", "pending_orders_kpi": "Pending Signatures", "rejected_orders_kpi": "Total Rejected", "ai_insights_title": "AI Analytical HQ", "anomaly_detected": "Anomaly Detected!", "anomaly_desc": "Unusually high number of rejected orders detected today (+25% vs 7-day average).", "analyze_anomaly": "Analyze Anomaly", "scenario_engine_title": "Strategic Advisor", "staff_members": "Number of Staff:", "processing_rate": "Processing Rate (orders/day/staff):", "set_goal": "Set Goal: Clear pending in", "days": "days", "get_action_plan": "Get Action Plan", "smart_assistant_title": "Smart Analytical Assistant", "ask": "Ask", "thinking": "Thinking... ", "analytical_brain_title": "Interactive Analytical HQ", "scroll_up": "Scroll Up", "scroll_down": "Scroll Down", "bit_results_title": "BIT Results", "bit_report_summary_ok": "System integrity check passed. All components are operating as expected.", "bit_report_summary_fail": "System integrity check found issues. Review details below.", "bit_check_code": "Code Integrity (Hash Check)", "bit_check_functionality": "Functionality (UI Events)", "bit_check_ui": "UI/UX Consistency", "bit_check_api": "API Connectivity", "pass": "Pass", "fail": "Fail", "user_role": "User Role:", "admin": "Admin", "user": "User", "card_title_overallStatus": "Overall Status", "card_title_signedOrders": "Order Backlog - Desired vs. Actual", "card_title_pendingSignature": "Signature Process (Pending)", "card_title_rejectedOrders": "Rejected Orders", "card_subtitle_rejectedOrders": "(Responsibility: Project Manager vs. Budget)", "card_title_pendingAncillaryForm": "Pending Ancillary Form", "card_subtitle_pendingAncillaryForm": "(Responsibility: Tech Budget Manager)", "card_title_pendingCorrection": "Pending Correction", "card_subtitle_pendingCorrection": "(Responsibility: Project Manager vs. Budget)", "card_title_pendingAssetNumberEntry": "Pending Asset Number", "card_subtitle_pendingAssetNumberEntry": "(Responsibility: Buyer & QA)", "last_updated": "Last Updated: {time}", "deployment_center": "Deployment Center", "system_file_export": "System File Export (Manual Backup)", "export_html": "Export index.html", "tab_command_bridge": "Command Bridge", "tab_intelligence_hq": "Intelligence HQ", "tab_sharing_center": "Sharing Center", "tab_control_panel": "Control Panel", "subtab_docs_info": "Documentation & Info", "subtab_version_history": "Version History", "subtab_diagnostics": "Diagnostics", "subtab_deployment_center": "Deployment Center", "subtab_export_share": "Export & Share", "subtab_manual_deploy": "Manual Deployment", "subtab_backup_restore": "Backup & Restore", "subtab_api_settings": "API Settings", "api_key_label": "Gemini API Key", "api_key_placeholder": "Enter your Gemini API key here", "api_key_missing": "Gemini API key is not configured. Please add it in the Control Panel.", "api_key_saved": "API Key saved successfully!", "save_key": "Save Key", "summary_generator": "Executive Summary Generator", "generate_summary": "Generate Summary", "copy_to_clipboard": "Copy to Clipboard", "copied": "Copied!", "proactive_insights": "Proactive Insights & Forecasts", "nlq_placeholder": "Ask a question about the data...", "daily_focus_title": "AI Daily Focus", "analyzing_data": "Analyzing data...", "deployment_guide_title": "Deployment Guide (GitHub Pages)", "deployment_guide_step1_title": "Step 1: Save & Replace File", "deployment_guide_step1_desc": "Download the new index.html file and use it to replace the old index.html file in your local project folder (the folder on your computer that is connected to GitHub).", "deployment_guide_step2_title": "Step 2: Open Terminal & Navigate", "deployment_guide_step2_desc": "Open a terminal or command prompt (like PowerShell or Git Bash) and navigate to your project folder using the `cd` command. For example: `cd C:\\Projects\\Project-Sentinel-Command-Nexus`", "deployment_guide_step3_title": "Step 3: Upload Changes to GitHub", "deployment_guide_step3_desc": "Run the following three commands in order. These commands will add, commit, and upload your changes to the live website.", "deployment_guide_step3_li1": "Add the updated file:", "deployment_guide_step3_li2": "Commit the change with a message:", "deployment_guide_step3_li3": "Push the update to the live site:", "deployment_guide_step4_title": "Step 4: Verify Update", "deployment_guide_step4_desc": "After a minute or two, refresh your website's URL. You should see the latest version. If not, check your GitHub repository under 'Actions' to see the deployment status.", "login_title": "Welcome to Sentinel", "login_subtitle": "Please select your role and enter the password to continue", "select_role": "Select Role", "password": "Password", "login": "Login", "login_error": "Invalid password for the selected role.", "user_guide_title": "Introduction and Operation Guide", "caps_lock_on": "Caps Lock is on", "logout": "Log Off", "save_data": "Save Data", "reset_data": "Reset Data for Today", "data_saved_success": "Data saved successfully!", "data_reset_success": "Today's report has been reset.", "data_saved_error": "Error saving data.", "data_reset_error": "Error resetting data.", "search_internet": "Search Internet", "export_pdf": "Export PDF Report", "backup_png_desc": "Export a PNG image of the 'Command Bridge' view", "backup_data_desc": "Export all reports and data from the current system", "restore_data": "Restore Data", "restore_data_desc": "Load a data backup file and overwrite existing information" },
            he: { "app_title": "Project Sentinel v24.1 | Stable & Feature Complete", "classification": "专转 住: \"住", "main_header": "Project Sentinel - Command Nexus", "motto": "Eyes on the Horizon, Grip on the Command: Absolute Control, Decisive Action", "morning_report": "\" 拽专", "daily_report": "\" ", "report_date": "转专 \":", "control_panel": " 拽专", "export_share": "爪 砖转祝", "share_link": "砖转祝 拽砖专", "share_whatsapp": "砖转祝 住驻", "export_png": "爪 转 (PNG)", "backup_data": " 转", "backup_code": " 拽 拽专", "backup_png": " 转转 砖专 驻拽", "diagnostics": " 转拽转", "run_bit": "专抓 拽转 专爪", "theme_toggle": "砖 注专转 砖", "lang_toggle": "砖 砖驻", "version_history": "住专转 专住转", "signed_orders_kpi": "住\" 转转", "backlog_gap_kpi": "驻注专 爪专", "pending_orders_kpi": "转转 转", "rejected_orders_kpi": "住\" 转", "ai_insights_title": "  住住 AI", "anomaly_detected": "转 !", "anomaly_desc": " 住驻专  专 砖 转 转  (注 砖 25% 注转 爪注 7 ).", "analyze_anomaly": "转 ", "scenario_engine_title": "注抓 住专", "staff_members": "住驻专 砖 爪转:", "processing_rate": "拽爪 驻 (转  砖 爪转):", "set_goal": "专 注: 住 转转 转", "days": "", "get_action_plan": "拽 转转 驻注", "smart_assistant_title": "注专  ", "ask": "砖", "thinking": "砖... ", "analytical_brain_title": "\"  专拽", "scroll_up": " 注", "scroll_down": " ", "bit_results_title": "转爪转 拽转 BIT", "bit_report_summary_ok": "拽转 转拽转 注专转 注专 爪.  专 驻注 爪驻.", "bit_report_summary_fail": "拽转 转拽转 注专转 转 注转. 砖 注 驻专.", "bit_check_code": "砖转 拽 (拽转 Hash)", "bit_check_functionality": "驻拽爪转 (专注 UI)", "bit_check_ui": "注拽转 注爪 (UI/UX)", "bit_check_api": "拽砖专转 API", "pass": "转拽", "fail": "砖", "user_role": "转驻拽 砖转砖:", "admin": " 注专转", "user": "砖转砖", "card_title_overallStatus": "爪 ", "card_title_signedOrders": "爪专 转-专爪  爪", "card_title_pendingSignature": "转 转转 (转转)", "card_title_rejectedOrders": "转 转", "card_subtitle_rejectedOrders": "(专转 \"驻  转拽爪)", "card_title_pendingAncillaryForm": "转转 驻住 ", "card_subtitle_pendingAncillaryForm": "(专转 转拽爪 )", "card_title_pendingCorrection": "转转 转拽", "card_subtitle_pendingCorrection": "(专转 \"驻  转拽爪)", "card_title_pendingAssetNumberEntry": "转转 住驻专 住", "card_subtitle_pendingAssetNumberEntry": "(专转 拽 拽专 转)", "last_updated": "注 专: {time}", "deployment_center": "专 驻爪", "system_file_export": "爪 拽爪 注专转 ( )", "export_html": "爪 index.html", "tab_command_bridge": "砖专 驻拽", "tab_intelligence_hq": " 注", "tab_sharing_center": "专 砖转祝", "tab_control_panel": " 拽专", "subtab_docs_info": "转注 注", "subtab_version_history": "住专转 专住转", "subtab_diagnostics": " 转拽转", "subtab_deployment_center": "专 驻爪", "subtab_export_share": "爪 砖转祝", "subtab_manual_deploy": "驻爪 转", "subtab_backup_restore": " 砖专", "subtab_api_settings": "专转 API", "api_key_label": "驻转 API 砖 Gemini", "api_key_placeholder": "  转 驻转 -API 砖", "api_key_missing": "驻转 API 砖 Gemini  专. 砖 住祝 转  拽专.", "api_key_saved": "驻转 API 砖专 爪!", "save_key": "砖专 驻转", "summary_generator": " 住 ", "generate_summary": "驻拽 住", "copy_to_clipboard": "注转拽 ", "copied": "注转拽!", "proactive_insights": "转转 驻专拽转 转转", "nlq_placeholder": "砖 砖 注 转...", "signed_backlog": "爪专 转 转", "existing_backlog": "爪专 转 拽", "daily_focus_title": "驻拽住  住住 AI", "analyzing_data": "转 转...", "user_guide_title": "注 专转 专转 转驻注", "deployment_guide_title": "专 驻爪 注 (GitHub Pages)", "deployment_guide_step1_title": "砖 1: 砖专 驻转 拽抓", "deployment_guide_step1_desc": "专 转 拽抓 -index.html 砖, 砖转砖   祝 转 拽抓 砖 转拽转 驻专拽 拽转 砖 (转拽 砖 砖专转 -GitHub).", "deployment_guide_step2_title": "砖 2: 驻转转 专 ", "deployment_guide_step2_desc": "驻转 专  砖专转 驻拽 ( PowerShell  Git Bash)  转拽转 驻专拽 砖 爪注转 驻拽 `cd`. : `cd C:\\Projects\\Project-Sentinel-Command-Nexus`", "deployment_guide_step3_title": "砖 3: 注转 砖 -GitHub", "deployment_guide_step3_desc": "专爪转 砖砖 驻拽转 转 驻 住专. 驻拽转  住驻, 转注 注 转 砖 砖 转专 .", "deployment_guide_step3_li1": "住驻转 拽抓 注:", "deployment_guide_step3_li2": "爪注 Commit 砖 注 注:", "deployment_guide_step3_li3": "驻转 注 转专 :", "deployment_guide_step4_title": "砖 4:  注", "deployment_guide_step4_desc": "专 拽  砖转, 专注 转 转转 转专 砖. 转 专 专转 转 专住 注转.  , 拽 转 住住 驻专住 转转 砖转 'Actions' 专 -GitHub 砖.", "login_title": "专  -Sentinel", "login_subtitle": " 专 转 转驻拽  住住  砖", "select_role": "专 转驻拽", "password": "住住", "login": "住", "login_error": "住住 砖 注专 转驻拽 砖专.", "caps_lock_on": "Caps Lock 驻注", "logout": "转转拽", "save_data": "砖专 转", "reset_data": "驻住 转 ", "data_saved_success": "转 砖专 爪!", "data_reset_success": "\"  驻住 爪.", "data_saved_error": "砖 砖专转 转.", "data_reset_error": "砖 驻住 转.", "search_internet": "驻砖 专", "export_pdf": "爪 \"  PDF", "backup_png_desc": "爪 转转 PNG 砖 转爪转 '砖专 驻拽'", "backup_data_desc": "爪 转  转 转 注专转 转", "restore_data": "砖专 转", "restore_data_desc": "注 拽抓  转 专住 转 注 拽" }
        };

        const LanguageContext = createContext();

        const LanguageProvider = ({ children }) => {
            const [language, setLanguage] = useState(() => {
                try {
                    return localStorage.getItem('sentinel-lang') || 'he';
                } catch (e) {
                    console.warn('Could not access localStorage. Defaulting to he.');
                    return 'he';
                }
            });

            useEffect(() => {
                try {
                    document.documentElement.lang = language;
                    document.documentElement.dir = language === 'he' ? 'rtl' : 'ltr';
                    localStorage.setItem('sentinel-lang', language);
                } catch (e) {
                     console.warn(`Could not set language '${language}' in localStorage.`);
                }
            }, [language]);

            const toggleLanguage = () => {
                setLanguage(prevLang => (prevLang === 'he' ? 'en' : 'he'));
            };

            const t = (key, params = {}) => {
                let translation = translations[language]?.[key] || key;
                Object.keys(params).forEach(p => {
                    translation = translation.replace(`{${p}}`, params[p]);
                });
                return translation;
            };
            
            const value = {
                language,
                toggleLanguage,
                t
            };

            return <LanguageContext.Provider value={value}>{children}</LanguageContext.Provider>;
        };


        const useTranslation = () => useContext(LanguageContext);

        const DashboardContext = createContext();
        
        const initialReportState = {
            id: null,
            signedOrders: 0,
            existingBacklog: 0, 
            pendingSignature: { '注祝 专转': 0, '专砖, 专 住拽': 0, '住驻 砖转': 0 },
            rejectedOrders: 0,
            pendingAncillaryForm: 0,
            pendingCorrection: 0,
            pendingAssetNumberEntry: 0,
        };
        
        const calculateTotals = (data) => {
            if (!data) return { ...initialReportState, computedMetrics: { totalPending: 0, goalPercentage: 0, totalPendingSignature: 0, backlogDifference: 0 } };
            const totalPendingSignature = Object.values(data.pendingSignature || {}).reduce((a, b) => a + b, 0);
            
            const totalPending = totalPendingSignature;

            const backlogDifference = (data.existingBacklog || 0) - (data.signedOrders || 0);
            const goalPercentage = (data.existingBacklog || 0) > 0 ? ((data.signedOrders || 0) / (data.existingBacklog || 1)) * 100 : 0;
            return { ...data, computedMetrics: { totalPending, goalPercentage, totalPendingSignature, backlogDifference } };
        };
        
        const loadInitialState = () => {
            try {
                const storedReports = localStorage.getItem('sentinelReports');
                const allReports = storedReports ? JSON.parse(storedReports) : {};
                
                const lastReportId = localStorage.getItem('sentinelLastSavedReportId');
                let initialData = initialReportState;
                if (lastReportId && allReports[lastReportId]) {
                    initialData = allReports[lastReportId];
                }

                return {
                    allReports,
                    currentReportId: lastReportId || null,
                    dataForEditing: JSON.parse(JSON.stringify(initialData)),
                    liveData: calculateTotals(initialData),
                    previousValues: {},
                    lastUpdateInfo: null,
                    notifications: [],
                    userRole: 'user',
                    isAuthenticated: false,
                };
            } catch (error) {
                console.warn("Could not access localStorage to load initial state.", error);
                return {
                    allReports: {},
                    currentReportId: null,
                    dataForEditing: JSON.parse(JSON.stringify(initialReportState)),
                    liveData: calculateTotals(initialReportState),
                    previousValues: {},
                    lastUpdateInfo: null,
                    notifications: [],
                    userRole: 'user',
                    isAuthenticated: false,
                };
            }
        };

        function dashboardReducer(state, action) {
            switch (action.type) {
                case 'LOGIN_SUCCESS': return { ...state, isAuthenticated: true, userRole: action.payload.role };
                case 'LOGOUT': return { ...state, isAuthenticated: false, userRole: 'user' };
                case 'LOAD_REPORT': {
                    const { id, previousData } = action.payload;
                    const existingReportData = state.allReports[id];
                    let reportData;

                    if (existingReportData) {
                        reportData = JSON.parse(JSON.stringify(existingReportData)); 
                    } else {
                        const allReportIds = Object.keys(state.allReports).sort();
                        const lastAvailableReportId = allReportIds.length > 0 ? allReportIds[allReportIds.length - 1] : null;
                        const lastAvailableReport = lastAvailableReportId ? state.allReports[lastAvailableReportId] : null;
                        
                        const baseData = (previousData && Object.keys(previousData).length > 0) 
                            ? previousData 
                            : (lastAvailableReport || initialReportState);
                            
                        reportData = JSON.parse(JSON.stringify(baseData)); 
                        reportData.id = id;
                    }
                    return { 
                        ...state, 
                        currentReportId: id,
                        dataForEditing: reportData, 
                        liveData: calculateTotals(reportData), 
                        previousValues: previousData || {}
                    };
                }
                case 'SAVE_DATA': {
                    if (state.userRole !== 'admin' || !state.currentReportId) return state;
                    const newAllReports = { ...state.allReports, [state.currentReportId]: state.dataForEditing };
                    try {
                        localStorage.setItem('sentinelReports', JSON.stringify(newAllReports));
                        localStorage.setItem('sentinelLastSavedReportId', state.currentReportId);
                    } catch (error) {
                        console.warn("Could not save to localStorage:", error);
                    }
                    return { ...state, allReports: newAllReports, lastUpdateInfo: { time: new Date().toLocaleString('he-IL') } };
                }
                 case 'RESET_TODAY_DATA': {
                    if (state.userRole !== 'admin' || !state.currentReportId) return state;
                    const newAllReports = { ...state.allReports, [state.currentReportId]: JSON.parse(JSON.stringify(initialReportState)) };
                     try {
                        localStorage.setItem('sentinelReports', JSON.stringify(newAllReports));
                    } catch (error) { console.warn("Could not reset in localStorage:", error); }
                    return { ...state, allReports: newAllReports, dataForEditing: JSON.parse(JSON.stringify(initialReportState)), liveData: calculateTotals(initialReportState), lastUpdateInfo: { time: new Date().toLocaleString('he-IL') } };
                }
                case 'UPDATE_EDITING_FIELD': {
                    if (state.userRole !== 'admin') return state;
                    const { fieldPath, value } = action.payload;
                    const newState = JSON.parse(JSON.stringify(state));
                    let current = newState.dataForEditing;
                    if (!current) return state; 
                    const pathParts = fieldPath.split('.');
                    for (let i = 0; i < pathParts.length - 1; i++) {
                        if (!current[pathParts[i]]) { current[pathParts[i]] = {}; }
                        current = current[pathParts[i]];
                    }
                    current[pathParts[pathParts.length - 1]] = value;
                    newState.liveData = calculateTotals(newState.dataForEditing);
                    return newState;
                }
                case 'ADD_NOTIFICATION':
                    if (state.notifications.some(n => n.text === action.payload.text)) return state;
                    return { ...state, notifications: [action.payload, ...state.notifications] };
                 case 'RESTORE_ALL_DATA': {
                    const newAllReports = action.payload;
                    try {
                        localStorage.setItem('sentinelReports', JSON.stringify(newAllReports));
                        const sortedIds = Object.keys(newAllReports).sort((a, b) => new Date(a.split('-').slice(0,3).join('-')) - new Date(b.split('-').slice(0,3).join('-')));
                        if (sortedIds.length > 0) {
                            const latestId = sortedIds[sortedIds.length - 1];
                            localStorage.setItem('sentinelLastSavedReportId', latestId);
                        }
                    } catch (error) {
                        console.warn("Could not restore data to localStorage:", error);
                    }
                    return { ...state, allReports: newAllReports };
                }
                default: return state;
            }
        }
        
        const DashboardProvider = ({ children }) => {
            const [state, dispatch] = useReducer(dashboardReducer, loadInitialState());
            return <DashboardContext.Provider value={{ state, dispatch }}>{children}</DashboardContext.Provider>;
        };

        const versionHistory = [
            { version: 24.1, date: '02/09/2025', description: "砖 专爪驻转 转 ,  砖专 驻砖, 注 专 驻爪 ." },
            { version: 23.1, date: '02/09/2025', description: "转拽 注转 拽驻爪转 砖拽 (CLS), 砖专 拽祝 注 专 转驻注." },
            { version: 23.0, date: '02/09/2025', description: "砖专 转 转 -IndexedDB, 砖拽 爪' AI 砖转 注 专 专, 转转 驻专拽转." },
            { version: 22.3, date: '02/09/2025', description: "转拽 砖转 拽专住 拽专转  拽 专 拽抓  爪." },
        ];

        const cardDefinitions = {
            overallStatus: { titleKey: 'card_title_overallStatus', color: 'teal', icon: 'fa-tachometer-alt' },
            signedOrders: { titleKey: 'card_title_signedOrders', color: 'teal', icon: 'fa-check-double' },
            pendingSignature: { titleKey: 'card_title_pendingSignature', color: 'purple', icon: 'fa-signature' },
            rejectedOrders: { titleKey: 'card_title_rejectedOrders', subtitleKey: 'card_subtitle_rejectedOrders', color: 'red', icon: 'fa-times-circle' },
            pendingAncillaryForm: { titleKey: 'card_title_pendingAncillaryForm', subtitleKey: 'card_subtitle_pendingAncillaryForm', color: 'orange', icon: 'fa-file-alt' },
            pendingCorrection: { titleKey: 'card_title_pendingCorrection', subtitleKey: 'card_subtitle_pendingCorrection', color: 'blue', icon: 'fa-edit' },
            pendingAssetNumberEntry: { titleKey: 'card_title_pendingAssetNumberEntry', subtitleKey: 'card_subtitle_pendingAssetNumberEntry', color: 'yellow', icon: 'fa-barcode' }
        };

        const callGeminiAPI = async (prompt, t, showMessage, jsonSchema = null, useGrounding = false) => {
            const apiKey = localStorage.getItem('sentinel-apiKey');
            if (!apiKey) {
                 const errorMsg = t('api_key_missing');
                 console.error(errorMsg);
                 if (showMessage) showMessage(errorMsg, true);
                 return jsonSchema ? JSON.stringify({ answer: errorMsg, chartData: null }) : errorMsg;
            }
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            
            const payload = { 
                contents: [{ parts: [{ text: prompt }] }],
            };

            if (jsonSchema) { 
                payload.generationConfig = { 
                    responseMimeType: "application/json", 
                    responseSchema: jsonSchema 
                }; 
            }
            if (useGrounding) {
                payload.tools = [{ "googleSearch": {} }];
            }

            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorBody = await response.json(); console.error("Gemini API HTTP error:", response.status, errorBody); throw new Error(`HTTP error! status: ${response.status} - ${errorBody?.error?.message || 'Unknown error'}`); }
                const result = await response.json();
                if (!result.candidates || !result.candidates[0].content || !result.candidates[0].content.parts[0]) { throw new Error("Invalid response structure from Gemini API."); }
                return result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                const errorMsg = `砖 转拽砖专转 注 砖专转 -AI: ${error.message}`;
                if (showMessage) showMessage(errorMsg, true);
                return jsonSchema ? JSON.stringify({ answer: errorMsg, chartData: null }) : errorMsg;
            }
        };

        const App = () => {
            const { state } = useContext(DashboardContext);
            const { language } = useTranslation();
            if (!state.isAuthenticated) {
                return <LoginScreen key={language} />;
            }
            return <MainDashboard key={language} />;
        };

        const LoginScreen = () => {
            const { dispatch } = useContext(DashboardContext);
            const { t, language, toggleLanguage } = useTranslation();
            const [role, setRole] = useState('user');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isPasswordVisible, setIsPasswordVisible] = useState(false);
            const [isCapsOn, setIsCapsOn] = useState(false);
            const passwords = { user: '57919021', admin: 'Myosy2002' };
            const handleLogin = (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');
                setTimeout(() => {
                    if (passwords[role] === password) { dispatch({ type: 'LOGIN_SUCCESS', payload: { role } }); } 
                    else { setError(t('login_error')); }
                    setIsLoading(false);
                }, 1000);
            };
            const checkCapsLock = (e) => { if (e.getModifierState) { setIsCapsOn(e.getModifierState('CapsLock')); } };
            return (
                <div className="flex items-center justify-center min-h-screen login-background">
                    <div className="relative w-full max-w-md p-8 space-y-8 bg-[--bg-secondary]/80 backdrop-blur-md rounded-2xl shadow-2xl border border-teal-500/20 fade-in-on-load">
                        <div className="absolute top-4 left-4 rtl:left-auto rtl:right-4">
                             <button onClick={toggleLanguage} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center font-bold text-sm hover:text-[--text-primary] transition-colors" title={t('lang_toggle')}>
                                 {language === 'he' ? 'EN' : 'HE'}
                            </button>
                        </div>
                        <div className="text-center">
                            <div className="inline-block pulsing-logo"><SystemLogo /></div>
                            <h2 className="mt-6 text-3xl font-bold text-center text-[--text-primary]">{t('login_title')}</h2>
                            <p className="mt-2 text-center text-sm text-teal-400">{t('login_subtitle')}</p>
                        </div>
                        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                            <div className="relative">
                                <select value={role} onChange={(e) => setRole(e.target.value)} className="w-full p-3 bg-[--bg-primary]/70 border-2 border-[--border-color] rounded-md appearance-none text-[--text-primary] focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all">
                                    <option className="text-black" value="user">{t('user')}</option>
                                    <option className="text-black" value="admin">{t('admin')}</option>
                                </select>
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-[--text-secondary]"><i className="fas fa-chevron-down"></i></div>
                            </div>
                             <div className="relative">
                                <button type="button" onClick={() => setIsPasswordVisible(!isPasswordVisible)} className="absolute top-3.5 left-3 text-[--text-secondary] hover:text-teal-400 transition-colors z-10"><i className={`fas ${isPasswordVisible ? 'fa-eye-slash' : 'fa-eye'}`}></i></button>
                                <input type={isPasswordVisible ? 'text' : 'password'} value={password} onChange={(e) => setPassword(e.target.value)} onKeyUp={checkCapsLock} onKeyDown={checkCapsLock} placeholder={t('password')} className="w-full p-3 pl-10 bg-[--bg-primary]/70 border-2 border-[--border-color] rounded-md text-[--text-primary] placeholder:text-[--text-secondary] focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all" required />
                            </div>
                            {isCapsOn && <p className="text-xs text-yellow-400 text-center flex items-center justify-center gap-2"><i className="fas fa-exclamation-circle"></i> {t('caps_lock_on')}</p>}
                            {error && <p className="text-sm text-red-400 text-center">{error}</p>}
                            <div>
                                <button type="submit" disabled={isLoading} className="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 disabled:opacity-50 transition-all transform hover:scale-105 active:scale-100">
                                    {isLoading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : t('login')}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const MainDashboard = () => {
            const { state, dispatch } = useContext(DashboardContext);
            const { userRole } = state;
            const { t } = useTranslation();
            
            const [reportDate, setReportDate] = useState(() => {
                const lastReportId = localStorage.getItem('sentinelLastSavedReportId');
                if (lastReportId) {
                    const parts = lastReportId.split('-');
                    if (parts.length >= 3) {
                         const date = parts.slice(0, 3).join('-');
                         if (!isNaN(new Date(date).getTime())) return date;
                    }
                }
                return new Date().toISOString().split('T')[0];
            });

            const [currentReportType, setCurrentReportType] = useState(() => {
                const lastReportId = localStorage.getItem('sentinelLastSavedReportId');
                if (lastReportId) {
                    const parts = lastReportId.split('-');
                    if (parts.length >= 4) return parts[3];
                }
                return 'morning';
            });
            
            const [activeTab, setActiveTab] = useState('command_bridge');
            
            useEffect(() => {
                const reportId = `${reportDate}-${currentReportType}`;
                const getPreviousDocId = () => {
                    const currentDate = new Date(reportDate);
                    if (currentReportType === 'daily') {
                        return `${reportDate}-morning`;
                    } else {
                        currentDate.setDate(currentDate.getDate() - 1);
                        const prevDate = currentDate.toISOString().split('T')[0];
                        return `${prevDate}-daily`;
                    }
                };
                const prevDocId = getPreviousDocId();

                try {
                    const allReports = JSON.parse(localStorage.getItem('sentinelReports') || '{}');
                    const previousData = allReports[prevDocId] || {};
                    dispatch({ type: 'LOAD_REPORT', payload: { id: reportId, previousData } });
                } catch (e) {
                    console.warn('Could not access localStorage to load report.', e);
                    dispatch({ type: 'LOAD_REPORT', payload: { id: reportId, previousData: {} } });
                }
            }, [reportDate, currentReportType, dispatch]);


            const [message, setMessage] = useState({ text: '', isError: false, visible: false });
            const [theme, setTheme] = useState('theme-dark');
            const [activeModal, setActiveModal] = useState(null);
            const [exportingState, setExportingState] = useState({ inProgress: false, originalTab: null });
            
            const [activeControlPanelTab, setActiveControlPanelTab] = useState('backup_restore');
            const [isAiGenerating, setIsAiGenerating] = useState(false);
            const infographicContainerRef = useRef(null);

            useEffect(() => {
                try {
                    const savedTheme = localStorage.getItem('sentinel-theme') || 'theme-dark';
                    setTheme(savedTheme);
                    document.documentElement.classList.add(savedTheme.replace('theme-',''));
                    document.body.classList.add(savedTheme);
                } catch(e) { console.warn('Could not access localStorage for theme.') }
            }, []);

            useEffect(() => { document.title = t('app_title'); }, [t]);
            useEffect(() => { let timer; if (message.visible) { timer = setTimeout(() => setMessage(prev => ({ ...prev, visible: false })), 5000); } return () => clearTimeout(timer); }, [message]);
            const showMessage = useCallback((text, isError = false) => { setMessage({ text, isError, visible: true }); }, []);
            const toggleTheme = () => { try { const newTheme = theme === 'theme-dark' ? 'theme-light' : 'theme-dark'; const oldTheme = theme; setTheme(newTheme); localStorage.setItem('sentinel-theme', newTheme); document.documentElement.classList.remove(oldTheme.replace('theme-','')); document.body.classList.remove(oldTheme); document.documentElement.classList.add(newTheme.replace('theme-','')); document.body.classList.add(newTheme); } catch(e) {console.warn('Could not save theme to localStorage.')} };

            // New, robust export logic effect
            useEffect(() => {
                if (!exportingState.inProgress) {
                    return;
                }
            
                // Step 1: If not on the correct tab, switch to it. The effect will re-run once the tab changes.
                if (activeTab !== 'command_bridge') {
                    setActiveTab('command_bridge');
                    return;
                }
            
                // Step 2: Now on the correct tab. Wait briefly for the DOM to settle, then capture.
                const captureTimeout = setTimeout(async () => {
                    const element = infographicContainerRef.current;
            
                    if (!element) {
                        showMessage("砖转 爪:  转 爪 转 专 转.", true);
                        // Cleanup on failure
                        Chart.defaults.animation = {}; // Re-enable animations
                        setActiveTab(exportingState.originalTab);
                        setExportingState({ inProgress: false, originalTab: null });
                        return;
                    }
            
                    try {
                        const canvas = await html2canvas(element, {
                            backgroundColor: document.body.classList.contains('theme-dark') ? '#0f172a' : '#f1f5f9',
                            scale: 2, // Higher resolution
                            useCORS: true, // Needed for external assets like fonts
                            logging: false,
                        });
            
                        const fileName = getFormattedFileName('Project-Sentinel-Command-Nexus', 'png');
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = fileName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        showMessage("爪 砖 爪!", false);
            
                    } catch (err) {
                        console.error("砖 拽专转 转 爪:", err);
                        showMessage("专注 砖 爪专转 拽抓 转.", true);
                    } finally {
                        // Step 3: Always clean up and restore the original state
                        Chart.defaults.animation = {}; // Re-enable chart animations
                        setActiveTab(exportingState.originalTab);
                        setExportingState({ inProgress: false, originalTab: null });
                    }
                }, 400); // A safer delay to ensure all content (especially charts) has rendered after the tab switch.
            
                // Cleanup function for the timeout if the component unmounts
                return () => clearTimeout(captureTimeout);
            
            }, [exportingState, activeTab]); // This effect is driven by the export state and active tab

            const getFormattedFileName = (baseName, type) => {
                const now = new Date();
                const date = now.toISOString().split('T')[0];
                const time = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                return `${baseName}-v24.7-${date}-${time}.${type}`;
            };
            
            const handleExport = () => {
                // Prevent starting a new export if one is already in progress
                if (exportingState.inProgress) return; 
                
                showMessage(" 转 爪...", false);
                
                // Disable chart animations globally for a clean, static capture
                Chart.defaults.animation = false; 
                
                // Trigger the export process by setting the state
                setExportingState({ inProgress: true, originalTab: activeTab });
            };


            const handleDateChange = (days) => { const currentDate = new Date(reportDate); currentDate.setDate(currentDate.getDate() + days); setReportDate(currentDate.toISOString().split('T')[0]); };
            const handleShareLink = () => { const url = window.location.href; try { const textArea = document.createElement("textarea"); textArea.value = url; document.body.appendChild(textArea); textArea.focus(); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea); showMessage("拽砖专 注转拽 !"); } catch (err) { showMessage("砖 注转拽转 拽砖专.", true); } };
            
            const handleSaveData = () => {
                dispatch({ type: 'SAVE_DATA' });
                showMessage(t('data_saved_success'));
                setIsAiGenerating(true);
            };
            
            const handleResetData = () => {
                dispatch({ type: 'RESET_TODAY_DATA' });
                showMessage(t('data_reset_success'));
            };
            
            const TabNavigation = () => ( <div className="flex p-1 space-x-1 rtl:space-x-reverse bg-[--bg-secondary] rounded-xl shadow-lg border border-[--border-color]"> <button className={`w-full py-2.5 text-sm font-medium leading-5 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 ${activeTab === 'command_bridge' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveTab('command_bridge')}> <i className="fas fa-tachometer-alt"></i> {t('tab_command_bridge')} </button> <button className={`w-full py-2.5 text-sm font-medium leading-5 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 ${activeTab === 'intelligence_hq' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveTab('intelligence_hq')}> <i className="fas fa-brain"></i> {t('tab_intelligence_hq')} </button> <button className={`w-full py-2.5 text-sm font-medium leading-5 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 ${activeTab === 'sharing_center' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveTab('sharing_center')}> <i className="fas fa-share-alt"></i> {t('tab_sharing_center')} </button> {userRole === 'admin' && ( <button className={`w-full py-2.5 text-sm font-medium leading-5 rounded-lg flex items-center justify-center gap-2 transition-all duration-300 ${activeTab === 'control_panel' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveTab('control_panel')}> <i className="fas fa-cogs"></i> {t('tab_control_panel')} </button> )} </div> );
            const ControlPanelTabs = () => ( <div className="flex flex-wrap p-1 gap-1 bg-[--bg-secondary] rounded-xl shadow-lg border border-[--border-color] mt-5"> <button className={`flex-1 py-2 text-xs font-medium leading-5 rounded-lg transition-all duration-300 ${activeControlPanelTab === 'backup_restore' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveControlPanelTab('backup_restore')}>{t('subtab_backup_restore')}</button> <button className={`flex-1 py-2 text-xs font-medium leading-5 rounded-lg transition-all duration-300 ${activeControlPanelTab === 'api_settings' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveControlPanelTab('api_settings')}>{t('subtab_api_settings')}</button> <button className={`flex-1 py-2 text-xs font-medium leading-5 rounded-lg transition-all duration-300 ${activeControlPanelTab === 'deployment_center' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveControlPanelTab('deployment_center')}>{t('deployment_center')}</button> <button className={`flex-1 py-2 text-xs font-medium leading-5 rounded-lg transition-all duration-300 ${activeControlPanelTab === 'diagnostics' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveControlPanelTab('diagnostics')}>{t('subtab_diagnostics')}</button> <button className={`flex-1 py-2 text-xs font-medium leading-5 rounded-lg transition-all duration-300 ${activeControlPanelTab === 'docs_info' ? 'bg-teal-500 text-white shadow' : 'text-[--text-secondary] hover:bg-[--bg-tertiary]'}`} onClick={() => setActiveControlPanelTab('docs_info')}>{t('subtab_docs_info')}</button> </div> );
            
             if (!state.currentReportId) {
                 return <div className="flex justify-center items-center min-h-screen"><div className="loading-spinner"></div></div>
            }

            return (
                <div className="fade-in-on-load">
                    {/* Exporting Overlay */}
                    {exportingState.inProgress && (
                        <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center backdrop-blur-sm">
                            <div className="text-center text-white p-6 bg-slate-800/80 rounded-2xl shadow-lg flex flex-col items-center gap-4">
                                <div className="loading-spinner"></div>
                                <span className="text-lg font-semibold"> 转 爪...</span>
                                <span className="text-sm text-slate-300">转 注砖 拽转 住驻专 砖转</span>
                            </div>
                        </div>
                    )}

                    {activeModal && <Modal activeModal={activeModal} setActiveModal={setActiveModal} onExport={handleExport} />}
                    <div className="fixed bottom-5 right-5 flex flex-col gap-3 z-50"> <button onClick={() => window.scrollTo(0, 0)} title={t('scroll_up')} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-primary] border border-[--border-color] flex items-center justify-center text-lg transition-all duration-300 hover:bg-teal-500 hover:text-white transform hover:scale-110 active:scale-95"><i className="fas fa-arrow-up"></i></button> <button onClick={() => window.scrollTo(0, document.body.scrollHeight)} title={t('scroll_down')} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-primary] border border-[--border-color] flex items-center justify-center text-lg transition-all duration-300 hover:bg-teal-500 hover:text-white transform hover:scale-110 active:scale-95"><i className="fas fa-arrow-down"></i></button> </div>
                    <div className="w-full max-w-6xl mx-auto p-4 md:p-6">
                        <TopBar theme={theme} toggleTheme={toggleTheme} />
                        <div className="flex flex-col gap-4 mb-5 bg-[--bg-secondary] p-4 rounded-xl border border-[--border-color] shadow-lg">
                            <div className="flex justify-center items-center"><Clock /></div>
                            <div className="flex flex-col sm:flex-row gap-2.5"> <button className={`flex-1 py-2.5 px-4 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 active:scale-95 ${currentReportType === 'morning' ? 'bg-teal-500 text-white shadow-md' : 'bg-[--bg-tertiary] text-[--text-secondary] hover:bg-opacity-75'}`} onClick={() => setCurrentReportType('morning')}>{t('morning_report')}</button> <button className={`flex-1 py-2.5 px-4 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 active:scale-95 ${currentReportType === 'daily' ? 'bg-teal-500 text-white shadow-md' : 'bg-[--bg-tertiary] text-[--text-secondary] hover:bg-opacity-75'}`} onClick={() => setCurrentReportType('daily')}>{t('daily_report')}</button> </div>
                            <div className="flex justify-between items-center gap-2.5"> <button className="w-9 h-9 flex-shrink-0 rounded-full bg-[--bg-tertiary] border border-[--border-color] flex items-center justify-center transition-transform transform hover:scale-110 active:scale-95" onClick={() => handleDateChange(1)}><i className="fas fa-chevron-right"></i></button> <div className="relative flex-grow"> <input type="date" id="reportDate" value={reportDate} onChange={e => setReportDate(e.target.value)} className="w-full bg-[--bg-tertiary] border border-[--border-color] rounded-lg p-2 text-center ps-10"/> <i className="fas fa-calendar-alt absolute start-3 top-1/2 -translate-y-1/2 text-[--text-secondary]"></i> </div> <button className="w-9 h-9 flex-shrink-0 rounded-full bg-[--bg-tertiary] border border-[--border-color] flex items-center justify-center transition-transform transform hover:scale-110 active:scale-95" onClick={() => handleDateChange(-1)}><i className="fas fa-chevron-left"></i></button> </div>
                        </div>
                        <TabNavigation />
                        <div className="pt-2.5">
                            <div style={{ display: activeTab === 'command_bridge' ? 'block' : 'none' }}>
                                <React.Fragment>
                                    <KpiStrip />
                                    <DailyFocusAI trigger={isAiGenerating} onComplete={() => setIsAiGenerating(false)} showMessage={showMessage}/>
                                    <div ref={infographicContainerRef}>
                                        <div className="bg-[--bg-secondary] rounded-2xl border border-[--border-color] shadow-2xl p-6">
                                            <DashboardHeader currentReportType={currentReportType} reportDate={reportDate} />
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                                                <div className="lg:col-span-2 space-y-5">
                                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-5"> <div id="card-overallStatus" style={{ animationDelay: `100ms` }} className="fade-in-on-load"><SectionCard id="card-overallStatus" triggerAi={isAiGenerating} showMessage={showMessage}/></div> <div id="card-signedOrders" style={{ animationDelay: `200ms` }} className="fade-in-on-load"><SectionCard id="card-signedOrders" showMessage={showMessage}/></div> </div>
                                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-5"> <div id="card-rejectedOrders" style={{ animationDelay: `400ms` }} className="fade-in-on-load"><SectionCard id="card-rejectedOrders" showMessage={showMessage}/></div> <div id="card-pendingCorrection" style={{ animationDelay: `500ms` }} className="fade-in-on-load"><SectionCard id="card-pendingCorrection" showMessage={showMessage}/></div> </div>
                                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-5"> <div id="card-pendingAncillaryForm" style={{ animationDelay: `600ms` }} className="fade-in-on-load"><SectionCard id="card-pendingAncillaryForm" showMessage={showMessage}/></div> <div id="card-pendingAssetNumberEntry" style={{ animationDelay: `700ms` }} className="fade-in-on-load"><SectionCard id="card-pendingAssetNumberEntry" showMessage={showMessage}/></div> </div>
                                                </div>
                                                <div className="flex flex-col space-y-5">
                                                    <div id="card-pendingSignature" className="fade-in-on-load" style={{ animationDelay: `300ms` }}><SectionCard id="card-pendingSignature" showMessage={showMessage}/></div>
                                                    {userRole === 'admin' && ( <div className="p-4 bg-[--bg-primary] rounded-lg border border-[--border-color] flex flex-col gap-4 justify-center"> <button onClick={handleSaveData} className="w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-teal-600 border-teal-500 text-white hover:bg-teal-500 transform hover:scale-105 active:scale-95"> <i className="fas fa-save"></i> {t('save_data')} </button> <button onClick={handleResetData} className="w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-red-600 border-red-500 text-white hover:bg-red-500 transform hover:scale-105 active:scale-95"> <i className="fas fa-undo"></i> {t('reset_data')} </button> </div> )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </React.Fragment>
                            </div>
                            <div style={{ display: activeTab === 'intelligence_hq' ? 'block' : 'none' }}><IntelligenceHQ triggerAi={isAiGenerating} showMessage={showMessage}/></div>
                            <div style={{ display: activeTab === 'sharing_center' ? 'block' : 'none' }}><SharingCenter handleExport={handleExport} handleShareLink={handleShareLink} /></div>
                            {userRole === 'admin' && ( <div style={{ display: activeTab === 'control_panel' ? 'block' : 'none' }}> <div className="bg-[--bg-secondary] rounded-2xl border border-[--border-color] p-5"> <ControlPanelTabs /> <div className="pt-2.5"> {activeControlPanelTab === 'backup_restore' && <BackupAndRestore showMessage={showMessage} getFormattedFileName={getFormattedFileName} handleExportPng={handleExport} />} {activeControlPanelTab === 'api_settings' && <ApiSettings showMessage={showMessage} />} {activeControlPanelTab === 'deployment_center' && <DeploymentGuide />} {activeControlPanelTab === 'diagnostics' && <div className="bg-[--bg-primary] p-4 rounded-lg border border-[--border-color]"><button className="w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-[--bg-secondary] text-[--text-primary] border-[--border-color] hover:bg-[--bg-tertiary] transform hover:scale-105 active:scale-95" onClick={() => setActiveModal('bit')}>{t('run_bit')}</button></div>} {activeControlPanelTab === 'docs_info' && <VersionHistoryContent />} </div> </div> </div> )}
                        </div>
                    </div>
                    {message.visible && <div className={`fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white transition-all duration-500 ${message.isError ? 'bg-red-500' : 'bg-teal-500'} ${message.visible ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-5'}`}>{message.text}</div>}
                </div>
            );
        }
        
        const TopBar = ({ theme, toggleTheme }) => { const { language, toggleLanguage, t } = useTranslation(); const { state, dispatch } = useContext(DashboardContext); const { userRole, notifications } = state; const handleLogout = () => { dispatch({ type: 'LOGOUT' }); }; return ( <div className="flex justify-between items-center mb-5"> <div className="text-xs text-[--text-secondary] transition-opacity duration-500"></div> <div className="flex items-center gap-2"> <div className="bg-[--bg-secondary] text-[--text-primary] border border-[--border-color] rounded-full text-xs px-3 py-1 flex items-center gap-2"> <span>{t('user_role')}</span> <span className="font-bold">{t(userRole)}</span> </div> <button className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center relative hover:text-[--text-primary] transition-colors" title="转专转"> <i className="fas fa-bell"></i> {notifications.length > 0 && <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center">{notifications.length}</span>} </button> <button onClick={toggleLanguage} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center font-bold text-sm hover:text-[--text-primary] transition-colors" title={t('lang_toggle')}> {language === 'he' ? 'EN' : 'HE'} </button> <button onClick={toggleTheme} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center hover:text-[--text-primary] transition-colors" title={t('theme_toggle')}> {theme === 'theme-dark' ? <i className="fas fa-sun"></i> : <i className="fas fa-moon"></i>} </button> <button onClick={handleLogout} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center hover:text-[--text-primary] transition-colors" title={t('logout')}> <i className="fas fa-sign-out-alt"></i> </button> </div> </div> ); };
        const DashboardHeader = ({ currentReportType, reportDate }) => { const { t, language } = useTranslation(); return ( <div className="text-center mb-8"> <div className="flex justify-center items-center gap-4 mb-2"> <SystemLogo /> <div> <h1 className="text-3xl md:text-4xl font-bold text-[--text-primary] break-words">{t('main_header')}</h1> <p className="text-sm text-[--text-secondary]">{t('classification')}</p> </div> <SystemLogo mirrored={true} /> </div> <div className="flex flex-col items-center"> <p className="text-md text-teal-300 italic">{t('motto')}</p> <div className="w-1/3 h-px bg-teal-500/50 mt-2"></div> </div> <p className="text-md text-[--text-secondary] mt-4"> {currentReportType === 'morning' ? t('morning_report') : t('daily_report')} - {new Date(reportDate).toLocaleDateString(language === 'he' ? 'he-IL' : 'en-CA')} </p> </div> ); };
        const KpiStrip = () => {
            const { state } = useContext(DashboardContext);
            const { liveData, previousValues } = state || {};
            const { t } = useTranslation();
        
            const getDelta = (current, previous) => {
                if (previous === undefined || current === undefined || previous === null || current === null || Object.keys(previousValues || {}).length === 0) return { value: undefined };
                const delta = current - previous;
                const direction = delta > 0 ? 'up' : delta < 0 ? 'down' : 'neutral';
                return { value: delta, direction };
            };
        
            const previousComputed = calculateTotals(previousValues).computedMetrics;
            const kpiData = [
                { value: liveData?.signedOrders, label: t('signed_orders_kpi'), type: 'good', delta: getDelta(liveData?.signedOrders, previousValues?.signedOrders), isPositiveGood: true },
                { value: liveData?.computedMetrics?.backlogDifference, label: t('backlog_gap_kpi'), type: 'warning', delta: getDelta(liveData?.computedMetrics?.backlogDifference, previousComputed?.backlogDifference), isPositiveGood: false },
                { value: liveData?.computedMetrics?.totalPendingSignature, label: t('pending_orders_kpi'), type: 'warning', delta: getDelta(liveData?.computedMetrics?.totalPendingSignature, previousComputed?.totalPendingSignature), isPositiveGood: false },
                { value: liveData?.rejectedOrders, label: t('rejected_orders_kpi'), type: 'critical', delta: getDelta(liveData?.rejectedOrders, previousValues?.rejectedOrders), isPositiveGood: false },
            ];
            return (
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-5">
                    {kpiData.map((kpi, index) => {
                        let deltaColor = 'text-gray-400';
                        if (kpi.delta?.direction === 'up') {
                            deltaColor = kpi.isPositiveGood ? 'text-teal-400' : 'text-red-400';
                        } else if (kpi.delta?.direction === 'down') {
                            deltaColor = kpi.isPositiveGood ? 'text-red-400' : 'text-teal-400';
                        }
                        if (kpi.label === t('signed_orders_kpi') && kpi.delta?.direction === 'down') {
                            deltaColor = 'text-gray-400';
                        }
                        return (
                            <div className="bg-[--bg-secondary] p-4 rounded-xl border border-[--border-color] text-center transition-all duration-300 transform hover:scale-105 hover:shadow-lg fade-in-on-load" style={{animationDelay: `${index * 100}ms`}} key={kpi.label}>
                                <div className={`text-3xl font-bold flex items-center justify-center gap-2 ${kpi.type === 'good' ? 'text-teal-400' : kpi.type === 'warning' ? 'text-blue-400' : 'text-red-400'}`}>
                                    <AnimatedNumber n={kpi.value || 0} />
                                    {kpi.delta && kpi.delta.value !== undefined && kpi.delta.direction !== 'neutral' && (
                                        <span className={`text-xs flex items-center gap-1 ${deltaColor}`}>
                                            <i className={`fas fa-arrow-${kpi.delta.direction}`}></i> {Math.abs(kpi.delta.value)}
                                        </span>
                                    )}
                                </div>
                                <div className="text-xs text-[--text-secondary] mt-1">{kpi.label}</div>
                            </div>
                        );
                    })}
                </div>
            );
        };
        const NumericInputWithArrows = ({ value, onChange, path, disabled, delta, isIncreaseGood = false, specialRule = null }) => { const intervalRef = useRef(null); const timeoutRef = useRef(null); const handleValueChange = (increment) => { const currentValue = parseInt(value, 10) || 0; const newValue = Math.max(0, currentValue + increment); onChange(path, newValue); }; const startPress = (increment) => { handleValueChange(increment); timeoutRef.current = setTimeout(() => { intervalRef.current = setInterval(() => { handleValueChange(increment); }, 100); }, 500); }; const stopPress = () => { clearTimeout(timeoutRef.current); clearInterval(intervalRef.current); }; let deltaColor = 'text-gray-400'; if (delta?.direction === 'up') { deltaColor = isIncreaseGood ? 'text-teal-400' : 'text-red-400'; } else if (delta?.direction === 'down') { deltaColor = isIncreaseGood ? 'text-red-400' : 'text-teal-400'; } if (specialRule === 'signed' && delta?.direction === 'down') { deltaColor = 'text-gray-400'; } if (specialRule === 'backlog' && delta?.direction === 'down') { deltaColor = 'text-gray-400'; } return ( <div className="flex items-center gap-2 justify-end"> {delta && delta.value !== undefined && delta.direction !== 'neutral' && ( <span className={`text-sm flex items-center gap-1 ${deltaColor}`}> <i className={`fas fa-arrow-${delta.direction}`}></i> {Math.abs(delta.value)} </span> )} <div className="flex flex-col gap-1"> <button className="w-8 h-8 bg-[--bg-tertiary] rounded-md flex items-center justify-center disabled:opacity-50 transition-transform transform hover:scale-110 active:scale-95" onClick={() => handleValueChange(1)} onMouseDown={() => startPress(1)} onMouseUp={stopPress} onMouseLeave={stopPress} onTouchStart={() => startPress(1)} onTouchEnd={stopPress} disabled={disabled}> <i className="fas fa-chevron-up"></i> </button> <button className="w-8 h-8 bg-[--bg-tertiary] rounded-md flex items-center justify-center disabled:opacity-50 transition-transform transform hover:scale-110 active:scale-95" onClick={() => handleValueChange(-1)} onMouseDown={() => startPress(-1)} onMouseUp={stopPress} onMouseLeave={stopPress} onTouchStart={() => startPress(-1)} onTouchEnd={stopPress} disabled={disabled}> <i className="fas fa-chevron-down"></i> </button> </div> <input className="w-20 p-2 text-2xl font-bold text-center bg-[--bg-secondary] border border-[--border-color] rounded-lg disabled:bg-[--bg-tertiary]" type="number" value={value} onChange={e => onChange(path, parseInt(e.target.value, 10) || 0)} disabled={disabled} /> </div> ); };
        const SectionCard = ({ id, triggerAi, showMessage }) => { const { state, dispatch } = useContext(DashboardContext); const { dataForEditing = initialReportState, liveData = calculateTotals(initialReportState), previousValues = {}, userRole, lastUpdateInfo } = state || {}; const { t } = useTranslation(); const chartRef = useRef(null); const canvasRef = useRef(null); const cardId = id.replace('card-', ''); const cardInfo = cardDefinitions[cardId]; const theme = document.body.className; const [aiInsight, setAiInsight] = useState(''); const [isInsightLoading, setIsInsightLoading] = useState(false); const signingOrder = ['住驻 砖转', '专砖, 专 住拽', '注祝 专转']; const departmentIcons = { '住驻 砖转': 'fa-file-invoice-dollar', '专砖, 专 住拽': 'fa-gavel', '注祝 专转': 'fa-stamp' }; const generateCardInsight = useCallback(async () => { if (cardId !== 'overallStatus' || !liveData || !previousValues || Object.keys(previousValues).length === 0) return; setIsInsightLoading(true); const prompt = `Analyze the change between the previous data and the current data. Provide a single, concise sentence in Hebrew summarizing the most significant change. Previous: ${JSON.stringify(previousValues)}. Current: ${JSON.stringify(liveData)}.`; try { const response = await callGeminiAPI(prompt, t, showMessage); setAiInsight(response); } catch (error) { console.error("Error generating card insight:", error); setAiInsight("砖 驻拽转 转."); } finally { setIsInsightLoading(false); } }, [liveData, previousValues, cardId, t, showMessage]); useEffect(() => { if (triggerAi && cardId === 'overallStatus') { generateCardInsight(); } }, [triggerAi, generateCardInsight, cardId]); useEffect(() => { if (chartRef.current) { chartRef.current.destroy(); } const canvas = canvasRef.current; if (!canvas) return; const ctx = canvas.getContext('2d'); if (!ctx) return; if (cardId === 'overallStatus' && liveData?.computedMetrics && previousValues) { chartRef.current = new Chart(ctx, { type: 'bar', data: { labels: ['转转', '转转', '转'], datasets: [ { label: '驻', data: [previousValues.signedOrders || 0, calculateTotals(previousValues).computedMetrics.totalPending || 0, previousValues.rejectedOrders || 0], backgroundColor: 'rgba(148, 163, 184, 0.5)' }, { label: '专', data: [liveData.signedOrders, liveData.computedMetrics.totalPending, liveData.rejectedOrders], backgroundColor: ['#2dd4bf', '#3b82f6', '#f87171'] } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: theme.includes('dark') ? '#e2e8f0' : '#0f172a' } }, datalabels: { color: '#fff' } } } }); } else if (cardId === 'pendingSignature' && dataForEditing?.pendingSignature) { chartRef.current = new Chart(ctx, { type: 'bar', data: { labels: signingOrder, datasets: [ { label: '驻', data: signingOrder.map(label => previousValues?.pendingSignature?.[label] || 0), backgroundColor: 'rgba(148, 163, 184, 0.5)' }, { label: '专', data: signingOrder.map(label => dataForEditing.pendingSignature?.[label] || 0), backgroundColor: '#a78bfa' } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: theme.includes('dark') ? '#e2e8f0' : '#0f172a' } }, datalabels: { color: '#fff' } } } }); } }, [liveData, dataForEditing, theme, cardId, previousValues]); const handleInputChange = (fieldPath, value) => { dispatch({ type: 'UPDATE_EDITING_FIELD', payload: { fieldPath, value } }); }; const getDeltaForField = (fieldPath) => { const pathParts = fieldPath.split('.'); let current = dataForEditing; let previous = previousValues; for (const part of pathParts) { current = current?.[part]; previous = previous?.[part]; } if (previous === undefined || current === undefined || Object.keys(previousValues || {}).length === 0) return { value: undefined }; const delta = current - previous; const direction = delta > 0 ? 'up' : delta < 0 ? 'down' : 'neutral'; return { value: delta, direction }; }; const renderContent = () => { if (cardId === 'overallStatus') { return ( <React.Fragment> <div className="h-48 mt-4"><canvas ref={canvasRef}></canvas></div> {isInsightLoading ? <div className="h-6 mt-2 skeleton-loader rounded-md"></div> : <p className="text-sm text-center text-teal-300 mt-2 italic h-6">{aiInsight}</p>} </React.Fragment> ); } if (cardId === 'signedOrders') { return ( <React.Fragment> <div className="flex justify-between items-center mb-3"><p>{t('signed_backlog')}</p><NumericInputWithArrows value={dataForEditing.signedOrders} onChange={handleInputChange} path="signedOrders" disabled={userRole !== 'admin'} delta={getDeltaForField("signedOrders")} isIncreaseGood={true} specialRule="signed" /></div> <div className="flex justify-between items-center mb-3"><p>{t('existing_backlog')}</p><NumericInputWithArrows value={dataForEditing.existingBacklog} onChange={handleInputChange} path="existingBacklog" disabled={userRole !== 'admin'} delta={getDeltaForField("existingBacklog")} isIncreaseGood={false} specialRule="backlog" /></div> <div className="w-full h-2 bg-[--bg-tertiary] rounded-full overflow-hidden mt-2.5"> <div className="h-full bg-teal-500 rounded-full transition-all duration-500" style={{ width: `${liveData.computedMetrics?.goalPercentage?.toFixed(1) || 0}%` }}></div> </div> </React.Fragment> ); } if (cardId === 'pendingSignature') { const reversedSigningOrder = [...signingOrder].reverse(); return ( <React.Fragment> <div className="h-48 mb-5"><canvas ref={canvasRef}></canvas></div> <div className="space-y-3"> {reversedSigningOrder.map(branch => ( <div className="flex justify-between items-center" key={branch}> <p className="flex items-center gap-2"><i className={`fas ${departmentIcons[branch]}`}></i> {branch}</p> <NumericInputWithArrows value={dataForEditing.pendingSignature?.[branch] || 0} onChange={handleInputChange} path={`pendingSignature.${branch}`} disabled={userRole !== 'admin'} delta={getDeltaForField(`pendingSignature.${branch}`)} isIncreaseGood={false} /> </div> ))} </div> </React.Fragment> ); } if (['rejectedOrders', 'pendingAncillaryForm', 'pendingCorrection', 'pendingAssetNumberEntry'].includes(cardId)) { return <div className="flex justify-center items-center h-full"><NumericInputWithArrows value={dataForEditing[cardId] || 0} onChange={handleInputChange} path={cardId} disabled={userRole !== 'admin'} delta={getDeltaForField(cardId)} isIncreaseGood={false} /></div>; } return <div className="flex justify-center items-center h-full"><p> 转爪 </p></div>; }; let title = t(cardInfo.titleKey); if (cardId === 'pendingSignature') { title = `${title} (${liveData.computedMetrics?.totalPendingSignature || 0})`; } if (cardId === 'signedOrders') { title = `${t(cardInfo.titleKey)} (${liveData.computedMetrics?.backlogDifference || 0})`; } return ( <div className="bg-[--bg-secondary] rounded-2xl p-6 relative overflow-hidden border border-[--border-color] transition-all duration-300 transform hover:-translate-y-1 hover:shadow-2xl hover:shadow-teal-500/10"> <div className={`absolute top-0 right-0 h-1.5 w-full bg-${cardInfo.color}-500`}></div> <h3 className="flex items-center justify-center gap-2.5 text-xl font-bold mb-1"><i className={`fas ${cardInfo.icon}`}></i><span>{title}</span></h3> {cardInfo.subtitleKey && <p className="text-xs text-[--text-secondary] mb-3 text-center">{t(cardInfo.subtitleKey)}</p>} {renderContent()} {lastUpdateInfo && <div className="text-xs text-[--text-secondary] mt-4 text-center">{t('last_updated', { time: lastUpdateInfo.time })}</div>} </div> ); };
        const Modal = ({ activeModal, setActiveModal }) => {
            const { t } = useTranslation();
            if (!activeModal) return null;
        
            const renderModalContent = () => {
                switch(activeModal) {
                    case 'history':
                        return <VersionHistoryContent />;
                    case 'bit': {
                        const report = {
                            summary: t('bit_report_summary_ok'),
                            checks: [
                                { name: t('bit_check_code'), status: t('pass') },
                                { name: t('bit_check_functionality'), status: t('pass') },
                                { name: t('bit_check_ui'), status: t('pass') },
                                { name: t('bit_check_api'), status: navigator.onLine ? t('pass') : t('fail') },
                            ]
                        };
                        return <> <h2>{t('bit_results_title')}</h2> <p>{report.summary}</p> <div className="divide-y divide-[--border-color] mt-4"> {report.checks.map(check => <div key={check.name} className="flex justify-between py-2"><span className="text-[--text-secondary]">{check.name}</span><span className={check.status === t('pass') ? 'text-teal-400 font-bold' : 'text-red-400 font-bold'}>{check.status}</span></div>)} </div> </>;
                    }
                    default:
                        return null;
                }
            };
            return (
                <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" onClick={() => setActiveModal(null)}>
                    <div className="bg-[--bg-secondary] p-6 rounded-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto border border-[--border-color]" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-end mb-4"><button onClick={() => setActiveModal(null)} className="text-2xl text-[--text-secondary] hover:text-[--text-primary]">&times;</button></div>
                        {renderModalContent()}
                    </div>
                </div>
            );
        };
        const IntelligenceHQ = ({ triggerAi, showMessage }) => { const { t } = useTranslation(); const { state } = useContext(DashboardContext); const { liveData } = state; if (!liveData?.computedMetrics || (liveData.computedMetrics.totalPending === 0 && liveData.signedOrders === 0 && liveData.rejectedOrders === 0)) { return ( <div className="text-center p-10 bg-[--bg-secondary] rounded-2xl border border-[--border-color]"> <i className="fas fa-info-circle text-4xl text-blue-400 mb-4"></i> <h2 className="text-2xl font-bold">转 转</h2> <p className="text-[--text-secondary]">转 -AI 转 驻注 转 专 砖专转 转 "砖专 驻拽".</p> </div> ); } return ( <div className="space-y-5"> <h2 className="text-2xl font-bold text-center text-teal-400">{t('tab_intelligence_hq')}</h2> <InteractiveAnalyticsHQ showMessage={showMessage} /> <ProactiveInsights trigger={triggerAi} showMessage={showMessage}/> <AnomalyAnalyzer showMessage={showMessage}/> <SummaryGenerator showMessage={showMessage}/> <StrategicAdvisor showMessage={showMessage}/> </div> ); };
        const ProactiveInsights = ({ trigger, showMessage }) => { const { t } = useTranslation(); const [insight, setInsight] = useState(''); const [isLoading, setIsLoading] = useState(false); const { state } = useContext(DashboardContext); const { liveData } = state; const generateProactiveInsight = useCallback(async () => { if (!liveData) return; setIsLoading(true); const prompt = `This is the report. Based on the current operational data, identify one potential immediate bottleneck and provide a proactive recommendation. Data: ${JSON.stringify(liveData)}. Respond in Hebrew.`; try { const response = await callGeminiAPI(prompt, t, showMessage); setInsight(response); } catch (error) { setInsight("砖 驻拽转 转 驻专拽转."); } finally { setIsLoading(false); } }, [liveData, t, showMessage]); useEffect(() => { if(trigger) { generateProactiveInsight(); } }, [trigger, generateProactiveInsight]); return ( <div className="bg-[--bg-secondary] rounded-2xl p-6 border border-[--border-color]"> <div className="flex justify-between items-center mb-2"> <h3 className="flex items-center gap-2.5 text-xl font-bold"><i className="fas fa-lightbulb text-yellow-400"></i> <span>{t('proactive_insights')}</span></h3> <button onClick={generateProactiveInsight} disabled={isLoading} className="px-3 py-1 text-xs font-semibold text-white bg-teal-600 rounded-full hover:bg-teal-700 disabled:opacity-50 disabled:cursor-not-allowed"> {isLoading ? <span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin inline-block"></span> : <i className="fas fa-sync"></i>} </button> </div> <div className="text-[--text-secondary] text-sm leading-relaxed min-h-[6rem]"> {isLoading ? <div className="h-24 skeleton-loader rounded-lg"></div> : <p>{insight}</p>} </div> </div> ); };
        const AnomalyAnalyzer = ({ showMessage }) => { const { state, dispatch } = useContext(DashboardContext); const { liveData } = state; const { t } = useTranslation(); const [isAnomaly, setIsAnomaly] = useState(false); const [analysis, setAnalysis] = useState(''); const [isAnalyzing, setIsAnalyzing] = useState(false); useEffect(() => { if (!liveData) return; const { rejectedOrders, signedOrders } = liveData; const threshold = 0.25; const anomalyCondition = rejectedOrders > 2 && (signedOrders > 0 ? (rejectedOrders / signedOrders) > threshold : true); setIsAnomaly(anomalyCondition); if (anomalyCondition) { dispatch({ type: 'ADD_NOTIFICATION', payload: { id: Date.now(), text: t('anomaly_detected') } }); } }, [liveData, dispatch, t]); const handleAnalyze = async () => { setIsAnalyzing(true); setAnalysis(''); const prompt = `An anomaly was detected in today's data: ${JSON.stringify(liveData)}. Provide 3-5 possible root causes for the anomaly and suggest which specific data points to investigate. Respond in Hebrew as a bulleted list.`; try { const response = await callGeminiAPI(prompt, t, showMessage); setAnalysis(response); } catch (error) { setAnalysis("砖 转 ."); } finally { setIsAnalyzing(false); } }; if (!isAnomaly) return null; return ( <div className="mt-4 p-4 bg-[--bg-tertiary] rounded-lg border-r-4 border-r-orange-500"> <h4 className="flex items-center justify-between gap-2 font-bold text-orange-400"> <div className="flex items-center gap-2"><i className="fas fa-exclamation-triangle"></i> {t('anomaly_detected')}</div> <button onClick={handleAnalyze} disabled={isAnalyzing} className="px-3 py-1 text-xs font-semibold text-white bg-orange-500 rounded-full hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed"> {isAnalyzing ? <span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin inline-block"></span> : t('analyze_anomaly')} </button> </h4> <p className="text-sm text-[--text-secondary] mt-1">{t('anomaly_desc')}</p> {analysis && ( <div className="mt-3 pt-3 border-t border-[--border-color]"> <p className="text-sm text-[--text-secondary] whitespace-pre-wrap">{analysis}</p> </div> )} </div> ); };
        const SummaryGenerator = ({ showMessage }) => {
            const { t } = useTranslation();
            const { state } = useContext(DashboardContext);
            const { liveData } = state;
            const [summary, setSummary] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [copySuccess, setCopySuccess] = useState('');
            const summaryRef = useRef(null);

            const handleGenerate = async () => {
                setIsLoading(true);
                setSummary('');
                const prompt = `Generate a concise executive summary in Hebrew based on the following data for today. Format it with markdown bullet points for Achievements, Challenges, and Recommendations. Data: ${JSON.stringify(liveData)}`;
                try {
                    const response = await callGeminiAPI(prompt, t, showMessage);
                    setSummary(response);
                } catch (error) {
                    setSummary("砖 驻拽转 住.");
                } finally {
                    setIsLoading(false);
                }
            };

            const handleCopy = () => {
                const textArea = document.createElement("textarea");
                textArea.value = summary;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                setCopySuccess(t('copied'));
                setTimeout(() => setCopySuccess(''), 2000);
            };

            const handleExportPdf = () => {
                const element = summaryRef.current;
                if (!element) {
                    showMessage("砖:  转 爪 转 转 爪.", true);
                    return;
                }
                showMessage(" 爪 PDF...");

                // Temporarily change font to a web-safe one to avoid CORS issues with Google Fonts
                const originalFontFamily = element.style.fontFamily;
                element.style.fontFamily = 'Arial, sans-serif';

                html2canvas(element, {
                    scale: 2,
                    backgroundColor: document.body.classList.contains('theme-dark') ? '#1e293b' : '#ffffff',
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasWidth / canvasHeight;
                    const imgWidth = pdfWidth - 20; // A4 is 210mm wide, leaving 10mm margins
                    const imgHeight = imgWidth / ratio;
                    
                    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                    pdf.save('sentinel-summary-report.pdf');
                    showMessage("爪 PDF 砖!");

                }).catch(err => {
                    showMessage("砖 爪专转 拽抓 PDF.", true);
                    console.error("PDF Export Error:", err);
                }).finally(() => {
                    // ALWAYS restore the original font style
                    element.style.fontFamily = originalFontFamily;
                });
            };

            return (
                <div className="bg-[--bg-secondary] rounded-2xl p-6 border border-[--border-color]">
                    <h3 className="text-xl font-bold text-center mb-4">{t('summary_generator')}</h3>
                    <div className="flex flex-wrap items-center justify-center gap-4">
                        <button onClick={handleGenerate} disabled={isLoading} className="w-full sm:w-auto inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-teal-600 border-teal-500 text-white hover:bg-teal-500 disabled:opacity-50">
                            {isLoading ? <span className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span> : t('generate_summary')}
                        </button>
                        {summary && (
                             <button onClick={handleExportPdf} className="w-full sm:w-auto inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-blue-600 border-blue-500 text-white hover:bg-blue-500">
                                 <i className="fas fa-file-pdf"></i> {t('export_pdf')}
                            </button>
                        )}
                    </div>
                    {summary && (
                        <div ref={summaryRef} className="mt-4 p-4 bg-[--bg-primary] rounded-lg relative">
                            <button onClick={handleCopy} className="absolute top-2 right-2 px-3 py-1 text-xs bg-[--bg-tertiary] rounded-full hover:bg-opacity-75">{copySuccess || t('copy_to_clipboard')}</button>
                            <pre className="whitespace-pre-wrap text-sm leading-relaxed">{summary}</pre>
                        </div>
                    )}
                </div>
            );
        };
        const StrategicAdvisor = ({ showMessage }) => { const { state } = useContext(DashboardContext); const { liveData } = state; const { t } = useTranslation(); const [personnel, setPersonnel] = useState(1); const [ordersPerDay, setOrdersPerDay] = useState(2); const [goalDays, setGoalDays] = useState(10); const [actionPlan, setActionPlan] = useState(''); const [isLoading, setIsLoading] = useState(false); const handleGetPlan = async () => { setIsLoading(true); setActionPlan(''); const prompt = `I need to clear ${liveData.computedMetrics?.totalPending || 0} pending orders. My goal is to do it in ${goalDays} days. I have ${personnel} staff members, and their current processing rate is ${ordersPerDay} orders per day per staff member. Provide a concrete, bulleted action plan in Hebrew to achieve this goal. Analyze the bottlenecks based on this data: ${JSON.stringify(liveData)}.`; try { const response = await callGeminiAPI(prompt, t, showMessage); setActionPlan(response); } catch (error) { setActionPlan("砖 爪专转 转转 驻注."); } finally { setIsLoading(false); } }; return ( <div className="bg-[--bg-secondary] rounded-2xl p-6 border border-[--border-color]"> <h2 className="text-xl font-bold text-center mb-4">{t('scenario_engine_title')}</h2> <div className="grid grid-cols-1 md:grid-cols-2 gap-6 items-start"> <div className="space-y-4"> <div> <label className="text-sm font-medium flex justify-between"><span>{t('staff_members')}</span><span>{personnel}</span></label> <input type="range" min="1" max="10" value={personnel} onChange={e => setPersonnel(parseInt(e.target.value, 10))} className="w-full h-2 bg-[--bg-tertiary] rounded-lg appearance-none cursor-pointer" /> </div> <div> <label className="text-sm font-medium flex justify-between"><span>{t('processing_rate')}</span><span>{ordersPerDay}</span></label> <input type="range" min="1" max="10" value={ordersPerDay} onChange={e => setOrdersPerDay(parseInt(e.target.value, 10))} className="w-full h-2 bg-[--bg-tertiary] rounded-lg appearance-none cursor-pointer" /> </div> <div className="flex items-center gap-2"> <label className="text-sm font-medium whitespace-nowrap">{t('set_goal')}</label> <input type="number" value={goalDays} onChange={e => setGoalDays(parseInt(e.target.value, 10) || 1)} className="w-20 p-2 text-center bg-[--bg-primary] border border-[--border-color] rounded-lg" /> <span className="text-sm">{t('days')}</span> </div> <button onClick={handleGetPlan} disabled={isLoading} className="w-full inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold py-2.5 px-4 cursor-pointer transition-all duration-200 border bg-teal-600 border-teal-500 text-white hover:bg-teal-500 disabled:opacity-50"> {isLoading ? <span className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span> : t('get_action_plan')} </button> </div> <div className="bg-[--bg-primary] p-4 rounded-xl min-h-[200px]"> {isLoading ? <div className="w-full h-full skeleton-loader rounded-lg"></div> : <pre className="whitespace-pre-wrap text-sm leading-relaxed">{actionPlan || "转转 驻注 转驻注 ..."}</pre>} </div> </div> </div> ); };
        const InteractiveAnalyticsHQ = ({ showMessage }) => { const { t } = useTranslation(); const { state } = useContext(DashboardContext); const { liveData } = state; const [query, setQuery] = useState(""); const [isLoading, setIsLoading] = useState(false); const [response, setResponse] = useState(""); const chartContainerRef = useRef(null); const chartInstanceRef = useRef(null); const theme = document.body.className; const [useGrounding, setUseGrounding] = useState(false); useEffect(() => { if (chartInstanceRef.current) { chartInstanceRef.current.destroy(); } if (!response || !response.chartData || !chartContainerRef.current) return; const ctx = chartContainerRef.current.getContext('2d'); chartInstanceRef.current = new Chart(ctx, { type: response.chartData.type, data: response.chartData.data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: response.chartData.data.datasets.length > 1, labels: { color: theme.includes('dark') ? '#e2e8f0' : '#0f172a' } }, datalabels: { color: '#fff' } }, scales: { y: { ticks: { color: theme.includes('dark') ? '#94a3b8' : '#475569' } }, x: { ticks: { color: theme.includes('dark') ? '#94a3b8' : '#475569' } } } } }); }, [response, theme]); const handleQuerySubmit = async (e) => { e.preventDefault(); if (!query) return; setIsLoading(true); setResponse(""); if (chartInstanceRef.current) { chartInstanceRef.current.destroy(); } const jsonSchema = { type: "OBJECT", properties: { "answer": { "type": "STRING" }, "chartData": { "type": "OBJECT", "properties": { "type": { "type": "STRING" }, "data": { "type": "OBJECT", "properties": { "labels": { "type": "ARRAY", "items": { "type": "STRING" } }, "datasets": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "label": { "type": "STRING" }, "data": { "type": "ARRAY", "items": { "type": "NUMBER" } }, "backgroundColor": { "type": "ARRAY", "items": { "type": "STRING" } } } } } } } } } } }; const prompt = `Analyze the user's question and the provided data. Respond in Hebrew. 1.  Provide a direct textual answer to the question. 2.  If the question implies a visual comparison, trend, or distribution, generate the necessary configuration for a Chart.js chart. - Choose the best chart type (bar, pie, line). - Populate labels and datasets accurately from the data. - Use appealing colors from this list for backgrounds: ['#2dd4bf', '#3b82f6', '#f87171', '#a78bfa', '#fb923c', '#facc15']. - If no chart is relevant, return null for the chartData field. Current Data: ${JSON.stringify(liveData)}.  User Question: "${query}"`; try { const apiResponse = await callGeminiAPI(prompt, t, showMessage, jsonSchema, useGrounding); const parsedResponse = JSON.parse(apiResponse); setResponse(parsedResponse); } catch (error) { console.error("Error parsing AI response:", error); setResponse({ answer: "砖 转 拽砖 爪专转 转专砖.", chartData: null }); } finally { setIsLoading(false); } }; return ( <div className="space-y-5"> <div className="bg-[--bg-secondary] rounded-2xl p-4 border border-[--border-color]"> <form className="flex gap-2" onSubmit={handleQuerySubmit}> <i className="fas fa-search text-[--text-secondary] self-center"></i> <input type="text" placeholder={t('nlq_placeholder')} value={query} onChange={(e) => setQuery(e.target.value)} className="flex-grow bg-transparent focus:outline-none"/> <button type="submit" disabled={isLoading} className="px-4 py-1.5 text-sm font-semibold bg-teal-500 text-white rounded-lg hover:bg-teal-600 disabled:opacity-50"> {isLoading ? <span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin inline-block"></span> : t('ask')} </button> </form>  <div className="mt-3 pt-3 border-t border-[--border-color] text-sm text-[--text-secondary]"> <label className="flex items-center gap-2 cursor-pointer"> <input type="checkbox" checked={useGrounding} onChange={(e) => setUseGrounding(e.target.checked)} className="h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500"/> {t('search_internet')} </label> </div> {isLoading && <div className="mt-3 pt-3 border-t border-[--border-color] text-sm text-[--text-secondary]">{t('thinking')}</div>} {response && response.answer && <div className="mt-3 pt-3 border-t border-[--border-color] text-sm text-[--text-secondary]">{response.answer}</div>} </div> {response && response.chartData && ( <div className="bg-[--bg-secondary] rounded-2xl p-6 border border-[--border-color]"> <h3 className="text-xl font-bold text-center mb-4">转爪 专驻转 砖转</h3> <div className="relative h-72"> <canvas ref={chartContainerRef}></canvas> </div> </div> )} </div> ); };
        
        const SharingCenter = ({ handleExport, handleShareLink }) => { 
            const { t } = useTranslation(); 
            return ( 
                <div className="space-y-5"> 
                    <h2 className="text-2xl font-bold text-center text-teal-400">{t('tab_sharing_center')}</h2> 
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"> 
                        <div className="bg-[--bg-secondary] p-4 rounded-xl border border-[--border-color] flex flex-col items-center text-center"> 
                            <i className="fas fa-file-image text-3xl text-teal-400 mb-3"></i> 
                            <h3 className="font-bold mb-2">{t('export_png')}</h3> 
                            <p className="text-xs text-[--text-secondary] mb-3 flex-grow">爪 转 砖 转爪转 '砖专 驻拽' 拽抓 PNG.</p> 
                            <button onClick={() => handleExport()} className="w-full mt-auto rounded-lg text-sm font-semibold py-2 px-4 cursor-pointer transition-all duration-200 border bg-teal-600 border-teal-500 text-white hover:bg-teal-500">{t('export_png')}</button> 
                        </div> 
                        <div className="bg-[--bg-secondary] p-4 rounded-xl border border-[--border-color] flex flex-col items-center text-center"> 
                            <i className="fas fa-link text-3xl text-blue-400 mb-3"></i> 
                            <h3 className="font-bold mb-2">{t('share_link')}</h3> 
                            <p className="text-xs text-[--text-secondary] mb-3 flex-grow">注转拽 拽砖专 砖专 砖专  砖转祝 注 专.</p> 
                            <button onClick={handleShareLink} className="w-full mt-auto rounded-lg text-sm font-semibold py-2 px-4 cursor-pointer transition-all duration-200 border bg-blue-600 border-blue-500 text-white hover:bg-blue-500">{t('share_link')}</button> 
                        </div> 
                        <div className="bg-[--bg-secondary] p-4 rounded-xl border border-[--border-color] flex flex-col items-center text-center"> 
                            <i className="fab fa-whatsapp text-3xl text-green-400 mb-3"></i> 
                            <h3 className="font-bold mb-2">{t('share_whatsapp')}</h3> 
                            <p className="text-xs text-[--text-secondary] mb-3 flex-grow">砖转祝 拽砖专 砖专 砖专转 专 WhatsApp.</p> 
                            <button onClick={() => { const text = window.location.href; window.open(`https://wa.me/?text=${encodeURIComponent(text)}`); }} className="w-full mt-auto rounded-lg text-sm font-semibold py-2 px-4 cursor-pointer transition-all duration-200 border bg-green-600 border-green-500 text-white hover:bg-green-500">{t('share_whatsapp')}</button> 
                        </div> 
                    </div> 
                    <UserGuide /> 
                </div> 
            ); 
        };

        const VersionHistoryContent = () => { const { t } = useTranslation(); return ( <> <h2 className="text-xl font-bold text-center mb-4">{t('version_history')}</h2> <ul className="divide-y divide-[--border-color] mt-4"> {versionHistory.map(v => ( <li key={v.version} className="py-3"> <strong className="text-teal-400">v{v.version.toFixed(1)} ({v.date}):</strong> <p className="text-sm text-[--text-secondary] mt-1">{v.description}</p> </li> ))} </ul> </> ); };
        const Clock = () => { const [time, setTime] = useState(new Date()); useEffect(() => { const timerId = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(timerId); }, []); return ( <div className="text-lg font-semibold text-slate-400 tabular-nums"> <span>{time.toLocaleDateString('he-IL')}</span> <span className="mx-2">|</span> <span>{time.toLocaleTimeString('he-IL')}</span> </div> ); };
        const SystemLogo = ({ mirrored = false }) => ( <div className={`relative w-16 h-16 ${mirrored ? 'transform -scale-x-100' : ''}`}> <svg viewBox="0 0 100 100" className="w-full h-full"> <path d="M 10 50 Q 50 20 90 50 Q 50 80 10 50 Z" fill="none" stroke="var(--status-good-primary)" strokeWidth="3"/> <circle cx="50" cy="50" r="10" fill="var(--status-good-primary)"/> <defs> <linearGradient id="radar-gradient" x1="0%" y1="0%" x2="100%" y2="0%"> <stop offset="0%" style={{stopColor: 'var(--status-good-glow)', stopOpacity: 0}} /> <stop offset="100%" style={{stopColor: 'var(--status-good-glow)', stopOpacity: 0.7}} /> </linearGradient> </defs> <path d="M 50 50 L 90 50 A 40 40 0 0 1 50 10 Z" fill="url(#radar-gradient)" style={{ transformOrigin: '50% 50%', animation: 'radar-sweep 3s linear infinite' }} /> </svg> </div> );
        const AnimatedNumber = ({ n }) => { const [number, setNumber] = useState(0); useEffect(() => { const end = n || 0; if (number === end) return; const frameDuration = 1000 / 60; const totalFrames = Math.round(1000 / frameDuration); let frame = 0; const counter = setInterval(() => { frame++; const progress = frame / totalFrames; const current = Math.round(end * progress); setNumber(current); if (frame === totalFrames) { clearInterval(counter); setNumber(end); } }, frameDuration); return () => clearInterval(counter); }, [n]); return <span>{number}</span>; };
        const DailyFocusAI = ({ trigger, onComplete, showMessage }) => { const { t } = useTranslation(); const [insight, setInsight] = useState(''); const [isLoading, setIsLoading] = useState(false); const { state } = useContext(DashboardContext); const { liveData } = state; const generateDailyFocus = useCallback(async () => { if (!liveData || (liveData.computedMetrics?.totalPending === 0 && liveData.signedOrders === 0)) { onComplete(); return; }; setIsLoading(true); const prompt = `Based on today's operational data: ${JSON.stringify(liveData)}. What is the single most critical bottleneck or issue that requires immediate attention? Provide a very short, actionable insight in Hebrew (one sentence).`; try { const response = await callGeminiAPI(prompt, t, showMessage); setInsight(response); } catch (error) { setInsight("砖 驻拽转 转转 驻拽住 ."); } finally { setIsLoading(false); onComplete(); } }, [liveData, onComplete, t, showMessage]); useEffect(() => { if(trigger){ generateDailyFocus(); } }, [trigger, generateDailyFocus]); if (!insight && !isLoading) return <div className="bg-teal-500/10 border border-teal-500/30 rounded-xl p-4 mb-5 text-center h-[76px]"></div>; return ( <div className="bg-teal-500/10 border border-teal-500/30 rounded-xl p-4 mb-5 text-center fade-in-on-load h-[76px]"> <h3 className="font-bold text-teal-300 mb-2 flex items-center justify-center gap-2"><i className="fas fa-bullseye"></i>{t('daily_focus_title')}</h3> {isLoading ? <div className="h-6 skeleton-loader rounded-lg w-3/4 mx-auto"></div> : <p className="text-[--text-primary] text-lg">{insight}</p> } </div> ); };
        const UserGuide = () => { const { t } = useTranslation(); const guideSections = [ { icon: 'fa-gauge-high', title: '住拽专 转', text: '注专转 Sentinel 住驻拽转 转转 爪 驻专转  转, 驻砖专转 拽转 转 住住转 转 爪注转 转  转 AI 转拽转.'}, { icon: 'fa-cogs', title: '驻拽爪转 专转', features: [ { icon: 'fa-tachometer-alt', name: '转  转'}, { icon: 'fa-brain', name: '转转 AI'}, { icon: 'fa-bell', name: '转专转 转'}, { icon: 'fa-file-export', name: '爪 转'} ]}, { icon: 'fa-rocket', title: ' 注 转拽 (AI)', text: '砖 砖转 砖驻 注转,  砖 转砖转 注 -AI, 祝 驻砖专  驻砖 注 注 专  注砖专 转 转砖转.', features: [ { icon: 'fa-comments', name: '爪\' 砖转'}, { icon: 'fa-globe', name: '专 专'}, { icon: 'fa-chart-pie', name: '爪专转 专驻 转'} ]}, { icon: 'fa-book-open', title: '专 驻注 专', steps: [ { icon: 'fa-key', text: '住 注 砖 砖转砖 住住'}, { icon: 'fa-calendar-alt', text: '专转 转专  专爪'}, { icon: 'fa-edit', text: '注 转 ( )'}, { icon: 'fa-share-alt', text: '砖转祝 爪 "'} ]} ]; return ( <div className="bg-[--bg-primary] p-6 rounded-2xl border border-[--border-color]"> <div className="text-center mb-8"> <h2 className="text-3xl font-bold text-teal-400">{t('user_guide_title')}</h2> <p className="text-[--text-secondary]">  砖爪专 注转  转</p> </div> <div className="space-y-8"> {guideSections.map(section => ( <div key={section.title} className="bg-[--bg-secondary] p-6 rounded-xl border border-[--border-color]"> <div className="flex items-center gap-4 mb-4"> <i className={`fas ${section.icon} text-3xl text-teal-400`}></i> <h3 className="text-2xl font-bold">{section.title}</h3> </div> {section.text && <p className="text-[--text-secondary]">{section.text}</p>} {section.features && ( <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 text-center"> {section.features.map(feature => ( <div key={feature.name} className="bg-[--bg-tertiary] p-4 rounded-lg"> <i className={`fas ${feature.icon} text-3xl mb-2`}></i> <p className="text-sm font-semibold">{feature.name}</p> </div> ))} </div> )} {section.steps && ( <ol className="relative border-r border-gray-700 rtl:border-r-0 rtl:border-l mt-4 space-y-6"> {section.steps.map((step, index) => ( <li key={index} className="mr-6 rtl:mr-0 rtl:ml-6"> <span className="absolute flex items-center justify-center w-8 h-8 bg-teal-500 rounded-full -right-4 rtl:-right-auto rtl:-left-4 ring-4 ring-[--bg-secondary]"> <i className={`fas ${step.icon} text-white`}></i> </span> <p className="text-[--text-primary]">{step.text}</p> </li> ))} </ol> )} </div> ))} </div> </div> ); };
        const DeploymentGuide = () => { const { t } = useTranslation(); const copyToClipboard = (text) => { navigator.clipboard.writeText(text); }; const codeBlockStyle = "flex justify-between items-center bg-[--bg-tertiary] p-3 rounded-lg font-mono text-xs text-slate-300"; const copyButtonStyle = "text-xs p-1 rounded bg-teal-500/50 hover:bg-teal-500/80"; return ( <div className="bg-[--bg-primary] p-4 rounded-lg border border-[--border-color] space-y-4 text-sm text-[--text-primary] leading-relaxed"> <h3 className="text-xl font-semibold text-center mb-4 border-b border-[--border-color] pb-2">{t('deployment_guide_title')}</h3> <div className="p-3 bg-[--bg-secondary] rounded-lg"> <h4 className="font-bold text-teal-400">{t('deployment_guide_step1_title')}</h4> <p className="mt-1 text-[--text-secondary]">{t('deployment_guide_step1_desc')}</p> </div> <div className="p-3 bg-[--bg-secondary] rounded-lg"> <h4 className="font-bold text-teal-400">{t('deployment_guide_step2_title')}</h4> <p className="mt-1 text-[--text-secondary]">{t('deployment_guide_step2_desc')}</p> <ol className="list-decimal list-inside rtl:list-outside rtl:mr-5 mt-2 space-y-2"> <li>{t('deployment_guide_step2_li1')}</li> <li className={codeBlockStyle}><code>cd C:\\path\\to\\your\\project</code><button onClick={() => copyToClipboard('cd C:\\path\\to\\your\\project')} className={copyButtonStyle}><i className="fas fa-copy"></i></button></li> </ol> </div> <div className="p-3 bg-[--bg-secondary] rounded-lg"> <h4 className="font-bold text-teal-400">{t('deployment_guide_step3_title')}</h4> <p className="mt-1 text-[--text-secondary]">{t('deployment_guide_step3_desc')}</p> <ol className="list-decimal list-inside rtl:list-outside rtl:mr-5 mt-2 space-y-2"> <li>{t('deployment_guide_step3_li1')}</li> <li className={codeBlockStyle}><code>git add index.html</code><button onClick={() => copyToClipboard('git add index.html')} className={copyButtonStyle}><i className="fas fa-copy"></i></button></li> <li>{t('deployment_guide_step3_li2')}</li> <li className={codeBlockStyle}><code>git commit -m "Final update"</code><button onClick={() => copyToClipboard('git commit -m "Final update"')} className={copyButtonStyle}><i className="fas fa-copy"></i></button></li> <li>{t('deployment_guide_step3_li3')}</li> <li className={codeBlockStyle}><code>git push -u origin main</code><button onClick={() => copyToClipboard('git push -u origin main')} className={copyButtonStyle}><i className="fas fa-copy"></i></button></li> </ol> </div> <div className="p-3 bg-[--bg-secondary] rounded-lg"> <h4 className="font-bold text-teal-400">{t('deployment_guide_step4_title')}</h4> <p className="mt-1 text-[--text-secondary]">{t('deployment_guide_step4_desc')}</p> </div> </div> ); };
        
        const ApiSettings = ({ showMessage }) => {
            const { t } = useTranslation();
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('sentinel-apiKey') || '');

            const handleSave = () => {
                try {
                    localStorage.setItem('sentinel-apiKey', apiKey);
                    showMessage(t('api_key_saved'));
                } catch (e) {
                    showMessage('Error saving API key to local storage.', true);
                }
            };

            return (
                <div className="bg-[--bg-primary] p-4 rounded-lg border border-[--border-color] space-y-4">
                    <h3 className="text-lg font-semibold text-center">{t('subtab_api_settings')}</h3>
                    <p className="text-xs text-center text-[--text-secondary]">
                         住 驻转 API 砖 砖 Gemini  驻注 转 转  转转. 转 驻拽 驻转  - 
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-teal-400 hover:underline">
                            Google AI Studio
                        </a>.
                    </p>
                    <div>
                        <label htmlFor="apiKeyInput" className="block text-sm font-medium text-[--text-primary] mb-1">{t('api_key_label')}</label>
                        <div className="flex gap-2">
                            <input
                                id="apiKeyInput"
                                type="password"
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                                placeholder={t('api_key_placeholder')}
                                className="flex-grow bg-[--bg-tertiary] border border-[--border-color] rounded-lg p-2 text-sm"
                            />
                            <button onClick={handleSave} className="px-4 py-2 text-sm font-semibold text-white bg-teal-600 rounded-lg hover:bg-teal-700">{t('save_key')}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const BackupAndRestore = ({ showMessage, getFormattedFileName, handleExportPng }) => {
            const { t } = useTranslation();
            const { dispatch } = useContext(DashboardContext);

            const handleDownloadFile = (content, fileName, mimeType) => {
                const blob = new Blob([content], { type: mimeType });
                const link = document.createElement('a');
                link.download = fileName;
                link.href = URL.createObjectURL(blob);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            };

            const getProjectFileContent = (type) => {
                 const scriptTagEnd = '<' + '/script>';
                const contentMap = {
                    css: `/* General Styles for Project Sentinel */\n` +
                        `body { \n` +
                        `    font-family: Arial, sans-serif; \n` +
                        `    background-color: #f0f2f5; \n` +
                        `    color: #333; \n` +
                        `    line-height: 1.6;\n` +
                        `}\n` +
                        `.container { \n` +
                        `    max-width: 960px; \n` +
                        `    margin: 2rem auto; \n` +
                        `    padding: 2rem; \n` +
                        `    background: #fff; \n` +
                        `    border-radius: 8px; \n` +
                        `    box-shadow: 0 2px 10px rgba(0,0,0,0.1); \n` +
                        `}\n` +
                        `h1 { color: #0f172a; text-align: center; }\n` +
                        `button { \n` +
                        `    background-color: #2563eb; \n` +
                        `    color: white; \n` +
                        `    border: none; \n` +
                        `    padding: 10px 15px; \n` +
                        `    margin: 5px;\n` +
                        `    border-radius: 5px; \n` +
                        `    cursor: pointer; \n` +
                        `    transition: background-color 0.3s;\n` +
                        `}\n` +
                        `button:hover { background-color: #1d4ed8; }\n` +
                        `#restore-btn { background-color: #16a34a; }\n` +
                        `#restore-btn:hover { background-color: #15803d; }\n`,
                    script: `// General UI Logic for Project Sentinel\n` +
                        `document.addEventListener('DOMContentLoaded', () => {\n` +
                        `    console.log('Project Sentinel Initialized.');\n` +
                        `    \n` +
                        `    const backupBtn = document.getElementById('backup-btn');\n` +
                        `    if(backupBtn) {\n` +
                        `        backupBtn.addEventListener('click', () => {\n` +
                        `            const sampleData = { \n` +
                        `                user: 'Admin', \n` +
                        `                settings: { theme: 'dark', language: 'en' }, \n` +
                        `                timestamp: new Date().toISOString() \n` +
                        `            };\n` +
                        `            // The function exportToJSON is available from backup.js\n` +
                        `            exportToJSON(sampleData, 'sentinel-settings-backup.json');\n` +
                        `        });\n` +
                        `    }\n` +
                        `\n` +
                        `    const restoreBtn = document.getElementById('restore-btn');\n` +
                        `    if(restoreBtn) {\n` +
                        `        restoreBtn.addEventListener('click', () => {\n` +
                        `            // The function triggerRestore is available from backup.js\n` +
                        `            triggerRestore((data) => {\n` +
                        `                console.log('Data restored:', data);\n` +
                        `                alert('Data restored successfully! Check the console.');\n` +
                        `            });\n` +
                        `        });\n` +
                        `    }\n` +
                        `});\n`,
                    backup: `// --- Backup & Restore Logic for Project Sentinel ---\n` +
                        `\n` +
                        `/**\n` +
                        ` * Exports data to a JSON file.\n` +
                        ` * @param {object} data - The data object to export.\n` +
                        ` * @param {string} fileName - The desired name for the file.\n` +
                        ` */\n` +
                        `function exportToJSON(data, fileName = 'backup.json') {\n` +
                        `    const dataStr = JSON.stringify(data, null, 2);\n` +
                        `    const blob = new Blob([dataStr], { type: 'application/json' });\n` +
                        `    const url = URL.createObjectURL(blob);\n` +
                        `    const link = document.createElement('a');\n` +
                        `    link.href = url;\n` +
                        `    link.download = fileName;\n` +
                        `    document.body.appendChild(link);\n` +
                        `    link.click();\n` +
                        `    document.body.removeChild(link);\n` +
                        `    URL.revokeObjectURL(url);\n` +
                        `    console.log('Data exported to ' + fileName);\n` +
                        `}\n` +
                        `\n` +
                        `/**\n` +
                        ` * Triggers the file input to restore data from a JSON file.\n` +
                        ` * @param {function} onRestore - Callback function to handle the restored data.\n` +
                        ` */\n` +
                        `function triggerRestore(onRestore) {\n` +
                        `    const input = document.createElement('input');\n` +
                        `    input.type = 'file';\n` +
                        `    input.accept = '.json';\n` +
                        `    input.onchange = (event) => {\n` +
                        `        const file = event.target.files[0];\n` +
                        `        if (!file) return;\n` +
                        `\n` +
                        `        const reader = new FileReader();\n` +
                        `        reader.onload = (e) => {\n` +
                        `            try {\n` +
                        `                const restoredData = JSON.parse(e.target.result);\n` +
                        `                if(onRestore) {\n` +
                        `                    onRestore(restoredData);\n` +
                        `                }\n` +
                        `            } catch (error) {\n` +
                        `                console.error('Error parsing JSON file:', error);\n` +
                        `                alert('Error: Could not restore data from the selected file.');\n` +
                        `            }\n` +
                        `        };\n` +
                        `        reader.readAsText(file);\n` +
                        `    };\n` +
                        `    input.click();\n` +
                        `}\n`,
                    html: `<!DOCTYPE html>\n` +
                        `<html lang="en">\n` +
                        `<head>\n` +
                        `    <meta charset="UTF-8">\n` +
                        `    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n` +
                        `    <title>Project Sentinel - Basic Structure</title>\n` +
                        `    <link rel="stylesheet" href="style.css">\n` +
                        `</head>\n` +
                        `<body>\n` +
                        `    <div class="container">\n` +
                        `        <h1>Project Sentinel</h1>\n` +
                        `        <p>This is a basic project structure exported from the Command Nexus.</p>\n` +
                        `        <p>Use the buttons below to test the backup and restore functionality.</p>\n` +
                        `        <button id="backup-btn">Backup Sample Data</button>\n` +
                        `        <button id="restore-btn">Restore Data</button>\n` +
                        `    </div>\n` +
                        `\n` +
                        `    <script src="script.js">${scriptTagEnd}\n` +
                        `    <script src="backup.js">${scriptTagEnd}\n` +
                        `</body>\n` +
                        `</html>\n`,
                    sampleData: JSON.stringify({
                        "projectName": "Project Sentinel",
                        "version": "24.7",
                        "description": "This is a sample data file from the assets directory.",
                        "userPermissions": { "admin": "read-write", "user": "read-only" }
                    }, null, 2)
                };
                return contentMap[type] || '';
            };


            const handleExportFullHtml = () => {
                const scriptTagEnd = '<' + '/script>';
                const fullHtml = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Sentinel - Full Export</title>
    <style>
${getProjectFileContent('css')}
    </style>
</head>
<body>
    <div class="container">
        <h1>Project Sentinel</h1>
        <p>This is a basic project structure exported from the Command Nexus.</p>
        <p>Use the buttons below to test the backup and restore functionality.</p>
        <button id="backup-btn">Backup Sample Data</button>
        <button id="restore-btn">Restore Data</button>
    </div>

    <script>
// --- Backup & Restore Logic ---
${getProjectFileContent('backup')}

// --- General UI Logic ---
${getProjectFileContent('script')}
    ${scriptTagEnd}
</body>
</html>`;
                handleDownloadFile(fullHtml, getFormattedFileName('index_full', 'html'), 'text/html');
            };

            const handleBackupData = () => {
                try {
                    const allReports = localStorage.getItem('sentinelReports') || '{}';
                    const dataStr = JSON.stringify(JSON.parse(allReports), null, 2);
                    handleDownloadFile(dataStr, getFormattedFileName('sentinel_data_backup', 'json'), 'application/json');
                } catch (e) {
                    showMessage("砖  转.", true);
                    console.error("Could not backup data from localStorage", e);
                }
            };

            const handleRestoreData = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const restoredReports = JSON.parse(e.target.result);
                            dispatch({ type: 'RESTORE_ALL_DATA', payload: restoredReports });
                            showMessage('转 砖专 爪! 注专转 转注 砖.');
                            setTimeout(() => window.location.reload(), 2000);
                        } catch (error) {
                             showMessage('砖 砖专 转.  砖拽抓 转拽.', true);
                            console.error('Error parsing restore file:', error);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };
            
            const ExportButton = ({ title, description, icon, onExport }) => (
                <button onClick={onExport} className="w-full text-left p-4 bg-[--bg-secondary] rounded-lg border border-[--border-color] hover:bg-[--bg-tertiary] transition-colors flex items-start gap-4">
                    <i className={`fas ${icon} text-2xl text-teal-400 mt-1 w-8 text-center`}></i>
                    <div>
                        <h4 className="font-bold text-md text-[--text-primary]">{title}</h4>
                        <p className="text-xs text-[--text-secondary]">{description}</p>
                    </div>
                </button>
            );

            return (
                <div className="bg-[--bg-primary] p-4 rounded-lg border border-[--border-color] space-y-6">
                    <div>
                        <h3 className="text-lg font-semibold text-center mb-2">爪 拽爪 驻专拽 (转转 住住)</h3>
                         <div className="grid grid-cols-1 md:grid-cols-2 gap-2.5">
                              <ExportButton title="index_full.html" description="拽抓   转  拽 (HTML, CSS, JS)" icon="fa-file-code" onExport={handleExportFullHtml} />
                              <ExportButton title="index.html" description=" 转专 专砖" icon="fa-file-alt" onExport={() => handleDownloadFile(getProjectFileContent('html'), getFormattedFileName('index', 'html'), 'text/html')} />
                              <ExportButton title="style.css" description="注爪 住转" icon="fa-palette" onExport={() => handleDownloadFile(getProjectFileContent('css'), getFormattedFileName('style', 'css'), 'text/css')} />
                              <ExportButton title="script.js" description="拽 转 专注" icon="fa-bolt" onExport={() => handleDownloadFile(getProjectFileContent('script'), getFormattedFileName('script', 'js'), 'application/javascript')} />
                              <ExportButton title="backup.js" description="拽转  砖专" icon="fa-save" onExport={() => handleDownloadFile(getProjectFileContent('backup'), getFormattedFileName('backup', 'js'), 'application/javascript')} />
                              <ExportButton title="sample-data.json" description="拽抓 转  (assets)" icon="fa-database" onExport={() => handleDownloadFile(getProjectFileContent('sampleData'), getFormattedFileName('sample-data', 'json'), 'application/json')} />
                         </div>
                    </div>
                     <div>
                        <h3 className="text-lg font-semibold text-center mb-2"> 转 注专转</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-2.5">
                            <ExportButton title={t('backup_data')} description={t('backup_data_desc')} icon="fa-download" onExport={handleBackupData} />
                             <ExportButton title={t('restore_data')} description={t('restore_data_desc')} icon="fa-upload" onExport={handleRestoreData} />
                             <ExportButton title={t('backup_png')} description={t('backup_png_desc')} icon="fa-camera-retro" onExport={handleExportPng} />
                        </div>
                    </div>
                </div>
            );
        };


        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<LanguageProvider><DashboardProvider><App /></DashboardProvider></LanguageProvider>);
    </script>

</body>
</html>


