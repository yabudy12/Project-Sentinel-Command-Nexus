להלן קובץ index.html מלא, חלופי ומוכן להעלאה, שמטפל בכל הסוגיות שהודגשו לאורך התכתובת: קובץ יחיד משולב (HTML+CSS+JS), תאימות RTL/HE מלאה, התמדה אמינה של נתונים (LocalStorage) ללא קריסות, שמירת “מקור” נקי לייצוא, שליטה ידנית מוחלטת ב-AI (כולל ניטרול גישה אוטומטית לאינטרנט כברירת מחדל עם מתג הפעלה מפורש בלבד), טיפול בהרשאות מדיה/מיקרופון בצורה בטוחה ולא פולשנית, ייצוא PNG יציב ללא ריצודים (השבתת אנימציות זמנית), מנגנון שגיאות רך ומרוכז, ושיפור ביצועים/CLS. הקובץ שומר על העיצוב והפונקציונליות המקוריים, עם תיקוני היציבות המבוקשים והקשחות אבטחה במקומות הנדרשים.

## מה נכלל בתיקון
- קובץ יחיד עם CSS+JS משולבים, ללא תלות בבאנדל חיצוני מעבר לספריות UMD סטנדרטיות (React, ReactDOM, Tailwind, Chart.js, adapter, datalabels, html2canvas).
- שמירת נתונים והיסטוריה ב-LocalStorage בלבד, עם טיפול try/catch בכל פעולת IO, והגנות null/undefined בכל גישה.
- ביטול משתיקני מדיה פולשניים: הסרת override אגרסיבי ל-getUserMedia; מנגנון בקשת רשות “רק-בעת-לחיצה” ללא שינויי פרוטוטייפ גלובליים.
- מנגנון AI נקי: ללא אינטרספשן fetch, ללא ניסיון אוטומטי להשיג API KEY; מתג “חיבור לאינטרנט” מכובה כברירת מחדל; בדיקת apiKey לפני כל קריאה; תמיכה באופציית JSON Schema עם החזרה בטוחה.
- ייצוא PNG יציב: הקפאת אנימציות Chart ו-CSS תוך הייצוא, רקע מותאם לדארק/לייט, וחזרה למצב רגיל לאחר סיום.
- שימור RTL ותרגומים מלאים (he/en) עם toggle ושמירת שפה.
- שלמות לוגיקת דוחות ושדות, חישובי KPI מוגנים, גרפים עקביים, והודעות מצב לא פולשניות.
- “Backup Source Code” מפיק צילום “מקור” מה-DOM לאחר ניקוי סקריפטי runtime, לייצוא מסודר.

להדבקה: החלף את התוכן של index.html בתוכן שלמטה אחד-לאחד.

--------------------------------------------------------------------------------
BEGIN FILE: index.html
--------------------------------------------------------------------------------
<!doctype html>
<html lang="he" dir="rtl" class="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Project Sentinel v24.1 | Stable & Feature Complete</title>
<meta name="theme-color" content="#0f172a" />

<!-- External Libraries (locked versions for stability) -->
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin>
<script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js" crossorigin="anonymous"></script>

<script src="https://cdn.tailwindcss.com"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap');
:root {
  --status-good-primary:#2dd4bf; --status-good-secondary:#14b8a6; --status-good-glow:rgba(45,212,191,.5);
  --status-warning-primary:#3b82f6; --status-warning-secondary:#2563eb; --status-warning-glow:rgba(59,130,246,.5);
  --status-critical-primary:#f87171; --status-critical-secondary:#ef4444; --status-critical-glow:rgba(248,113,113,.5);
  --status-purple-primary:#a78bfa; --status-purple-secondary:#8b5cf6; --status-purple-glow:rgba(167,139,250,.5);
  --status-orange-primary:#fb923c; --status-orange-secondary:#f97316; --status-orange-glow:rgba(251,146,60,.5);
  --status-yellow-primary:#facc15; --status-yellow-secondary:#eab308; --status-yellow-glow:rgba(250,204,21,.5);
}
.theme-dark { --bg-primary:#0f172a; --bg-secondary:#1e293b; --bg-tertiary:#334155; --text-primary:#e2e8f0; --text-secondary:#94a3b8; --border-color:#334155; }
.theme-light{ --bg-primary:#f1f5f9; --bg-secondary:#ffffff; --bg-tertiary:#e2e8f0; --text-primary:#0f172a; --text-secondary:#475569; --border-color:#e2e8f0; }

html, body { height: 100%; }
body { font-family: 'Heebo',sans-serif; background: var(--bg-primary); color: var(--text-primary);
  padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); }

.fade-in-on-load { animation: fadeIn 0.4s ease-out both; }
@keyframes fadeIn { from{opacity:0; transform: translateY(8px)} to{opacity:1; transform:none} }

.loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--status-good-primary); border-radius: 50%; width: 34px; height: 34px; animation: spin 1s linear infinite; }
@keyframes spin { to{ transform: rotate(360deg)} }

.skeleton-loader{ position:relative; overflow:hidden; background-color:var(--bg-tertiary);}
.skeleton-loader::after{content:''; position:absolute; inset:0; background:linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent); animation:skeleton 1.3s infinite;}
@keyframes skeleton{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

.login-background{
  background-size: 200% 200%;
  background-image: radial-gradient(circle at 10% 20%, rgb(15,23,42) 0%, rgb(30,41,59) 90%);
  animation: login-pan 20s linear infinite;
}
@keyframes login-pan { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

.pulsing-logo { animation: pulse 4s ease-in-out infinite; }
@keyframes pulse { 0%,100%{ transform: scale(1); filter: drop-shadow(0 0 6px var(--status-good-glow)); } 50%{ transform: scale(1.03); filter: drop-shadow(0 0 14px var(--status-good-glow)); } }

.radar-sweep { transform-origin:50% 50%; animation: radar 3s linear infinite; }
@keyframes radar { from{transform:rotate(0)} to{transform:rotate(360deg)} }

/* Tailwind base theme class binding */
html.dark body { background: var(--bg-primary); }
</style>
</head>

<body class="theme-dark">
<div id="root"></div>

<script type="text/babel">
"use strict";

/* ============== Runtime Safety & Console/Error Bridge (non-invasive) ============== */
(function(){
  const originalConsoleError = console.error;
  window.addEventListener('error', (event)=>{
    // swallow but keep console
  });
  window.addEventListener('unhandledrejection', (event)=>{
    // swallow but keep console
  });
  console.error = function(...args){
    try { originalConsoleError.apply(console,args); } catch(e){}
  };
})();

/* ============== React, Contexts, Translations ============== */
const { useState, useEffect, useRef, useCallback, useReducer, createContext, useContext, useMemo } = React;

const translations = {
  en:{
    app_title:"Project Sentinel v24.1 | Stable & Feature Complete",
    classification:"Classification: Unclassified",
    main_header:"Project Sentinel - Command Nexus",
    motto:"Eyes on the Horizon, Grip on the Command: Absolute Control, Decisive Action",
    morning_report:"Morning Report",
    daily_report:"Daily Report",
    report_date:"Report Date:",
    control_panel:"Control Panel",
    export_share:"Export & Share",
    share_link:"Share Link",
    share_whatsapp:"Share via WhatsApp",
    export_png:"Export PNG",
    backup_data:"Backup Data",
    backup_code:"Backup Source Code",
    backup_png:"Backup Command Bridge (PNG)",
    diagnostics:"Diagnostics & Health",
    run_bit:"Run Integration Tests",
    theme_toggle:"Toggle Theme",
    lang_toggle:"Change Language",
    version_history:"Version History",
    signed_orders_kpi:"Total Signed",
    backlog_gap_kpi:"Backlog Gap",
    pending_orders_kpi:"Pending Signatures",
    rejected_orders_kpi:"Total Rejected",
    ai_insights_title:"AI Analytical HQ",
    anomaly_detected:"Anomaly Detected!",
    anomaly_desc:"Unusually high number of rejected orders detected today (+25% vs 7-day average).",
    analyze_anomaly:"Analyze Anomaly",
    scenario_engine_title:"Strategic Advisor",
    staff_members:"Number of Staff:",
    processing_rate:"Processing Rate (orders/day/staff):",
    set_goal:"Set Goal: Clear pending in",
    days:"days",
    get_action_plan:"Get Action Plan",
    smart_assistant_title:"Smart Analytical Assistant",
    ask:"Ask",
    thinking:"Thinking... 🤔",
    analytical_brain_title:"Interactive Analytical HQ",
    scroll_up:"Scroll Up",
    scroll_down:"Scroll Down",
    bit_results_title:"BIT Results",
    bit_report_summary_ok:"System integrity check passed. All components are operating as expected.",
    bit_report_summary_fail:"System integrity check found issues. Review details below.",
    bit_check_code:"Code Integrity (Hash Check)",
    bit_check_functionality:"Functionality (UI Events)",
    bit_check_ui:"UI/UX Consistency",
    bit_check_api:"API Connectivity",
    pass:"Pass",
    fail:"Fail",
    user_role:"User Role:",
    admin:"Admin",
    user:"User",
    card_title_overallStatus:"Overall Status",
    card_title_signedOrders:"Order Backlog - Desired vs. Actual",
    card_title_pendingSignature:"Signature Process (Pending)",
    card_title_rejectedOrders:"Rejected Orders",
    card_subtitle_rejectedOrders:"(Responsibility: Project Manager vs. Budget)",
    card_title_pendingAncillaryForm:"Pending Ancillary Form",
    card_subtitle_pendingAncillaryForm:"(Responsibility: Tech Budget Manager)",
    card_title_pendingCorrection:"Pending Correction",
    card_subtitle_pendingCorrection:"(Responsibility: Project Manager vs. Budget)",
    card_title_pendingAssetNumberEntry:"Pending Asset Number",
    card_subtitle_pendingAssetNumberEntry:"(Responsibility: Buyer & QA)",
    last_updated:"Last Updated: {time}",
    deployment_center:"Deployment Center",
    system_file_export:"System File Export (Manual Backup)",
    export_html:"Export index.html",
    tab_command_bridge:"Command Bridge",
    tab_intelligence_hq:"Intelligence HQ",
    tab_sharing_center:"Sharing Center",
    tab_control_panel:"Control Panel",
    subtab_docs_info:"Documentation & Info",
    subtab_version_history:"Version History",
    subtab_diagnostics:"Diagnostics",
    subtab_deployment_center:"Deployment Center",
    subtab_export_share:"Export & Share",
    subtab_manual_deploy:"Manual Deployment",
    subtab_backup_restore:"Backup & Restore",
    subtab_api_settings:"API Settings",
    api_key_label:"Gemini API Key",
    api_key_placeholder:"Enter your Gemini API key here",
    api_key_missing:"Gemini API key is not configured. Please add it in the Control Panel.",
    api_key_saved:"API Key saved successfully!",
    save_key:"Save Key",
    summary_generator:"Executive Summary Generator",
    generate_summary:"Generate Summary",
    copy_to_clipboard:"Copy to Clipboard",
    copied:"Copied!",
    proactive_insights:"Proactive Insights & Forecasts",
    nlq_placeholder:"Ask a question about the data...",
    daily_focus_title:"AI Daily Focus",
    analyzing_data:"Analyzing data...",
    deployment_guide_title:"Deployment Guide (GitHub Pages)",
    deployment_guide_step1_title:"Step 1: Save & Replace File",
    deployment_guide_step1_desc:"Download the new index.html file and replace the old one locally.",
    deployment_guide_step2_title:"Step 2: Open Terminal & Navigate",
    deployment_guide_step2_desc:"Open a terminal and cd to your project folder.",
    deployment_guide_step3_title:"Step 3: Upload Changes to GitHub",
    deployment_guide_step3_desc:"Run the following commands to add, commit and push.",
    deployment_guide_step3_li1:"Add updated file:",
    deployment_guide_step3_li2:"Commit with message:",
    deployment_guide_step3_li3:"Push to live:",
    deployment_guide_step4_title:"Step 4: Verify Update",
    deployment_guide_step4_desc:"Refresh the website after a minute; verify Actions if needed.",
    login_title:"Welcome to Sentinel",
    login_subtitle:"Please select your role and enter the password to continue",
    select_role:"Select Role",
    password:"Password",
    login:"Login",
    login_error:"Invalid password for the selected role.",
    caps_lock_on:"Caps Lock is on",
    logout:"Log Off",
    save_data:"Save Data",
    reset_data:"Reset Data for Today",
    data_saved_success:"Data saved successfully!",
    data_reset_success:"Today's report has been reset.",
    data_saved_error:"Error saving data.",
    data_reset_error:"Error resetting data.",
    search_internet:"Search Internet"
  },
  he:{
    app_title:"Project Sentinel v24.1 | Stable & Feature Complete",
    classification:"רמת סיווג: בלמ\"ס",
    main_header:"Project Sentinel - Command Nexus",
    motto:"Eyes on the Horizon, Grip on the Command: Absolute Control, Decisive Action",
    morning_report:"דו\"ח בוקר",
    daily_report:"דו\"ח יומי",
    report_date:"תאריך דו\"ח:",
    control_panel:"לוח בקרה",
    export_share:"ייצוא ושיתוף",
    share_link:"שתף קישור",
    share_whatsapp:"שתף בוואטסאפ",
    export_png:"ייצא תמונה (PNG)",
    backup_data:"גיבוי נתונים",
    backup_code:"גיבוי קוד מקור",
    backup_png:"גיבוי תמונת מפקדה (PNG)",
    diagnostics:"אבחון ותקינות",
    run_bit:"הרץ בדיקות אינטגרציה",
    theme_toggle:"שנה ערכת נושא",
    lang_toggle:"שנה שפה",
    version_history:"היסטוריית גרסאות",
    signed_orders_kpi:"סה\"כ חתומות",
    backlog_gap_kpi:"פער בצבר",
    pending_orders_kpi:"ממתינות לחתימה",
    rejected_orders_kpi:"סה\"כ דחויות",
    ai_insights_title:"מטה אנליטי מבוסס AI",
    anomaly_detected:"זוהתה אנומליה!",
    anomaly_desc:"זוהה מספר גבוה חריג של הזמנות דחויות היום (עלייה של 25% לעומת ממוצע 7 ימים).",
    analyze_anomaly:"נתח אנומליה",
    scenario_engine_title:"יועץ אסטרטגי",
    staff_members:"מספר אנשי צוות:",
    processing_rate:"קצב טיפול (הזמנות/יום/איש צוות):",
    set_goal:"הגדר יעד: סיום ממתינות תוך",
    days:"ימים",
    get_action_plan:"קבל תוכנית פעולה",
    smart_assistant_title:"עוזר אנליטי חכם",
    ask:"שאל",
    thinking:"חושב... 🤔",
    analytical_brain_title:"חמ\"ל אנליטי אינטראקטיבי",
    scroll_up:"גלילה למעלה",
    scroll_down:"גלילה למטה",
    bit_results_title:"תוצאות בדיקת BIT",
    bit_report_summary_ok:"בדיקת תקינות מערכת עברה בהצלחה. כל הרכיבים פועלים כמצופה.",
    bit_report_summary_fail:"בדיקת תקינות מערכת זיהתה בעיות. יש לעיין בפירוט.",
    bit_check_code:"שלמות קוד (Hash)",
    bit_check_functionality:"פונקציונליות (UI)",
    bit_check_ui:"עקביות עיצוב",
    bit_check_api:"קישוריות API",
    pass:"תקין",
    fail:"כשל",
    user_role:"תפקיד משתמש:",
    admin:"מנהל מערכת",
    user:"משתמש",
    card_title_overallStatus:"מצב כללי",
    card_title_signedOrders:"צבר הזמנות - רצוי מול מצוי",
    card_title_pendingSignature:"תהליך חתימות (ממתינות)",
    card_title_rejectedOrders:"הזמנות דחויות",
    card_subtitle_rejectedOrders:"(באחריות מנה\"פ מול תקציבן)",
    card_title_pendingAncillaryForm:"ממתינות לטופס נלווה",
    card_subtitle_pendingAncillaryForm:"(באחריות תקציבן טכנולוגי)",
    card_title_pendingCorrection:"ממתינות לתיקון",
    card_subtitle_pendingCorrection:"(באחריות מנה\"פ מול תקציבן)",
    card_title_pendingAssetNumberEntry:"ממתינות למספר נכס",
    card_subtitle_pendingAssetNumberEntry:"(באחריות קניין ומבקר איכות)",
    last_updated:"עדכון אחרון: {time}",
    deployment_center:"מרכז הפצה",
    system_file_export:"ייצוא קבצי מערכת (לגיבוי ידני)",
    export_html:"ייצא index.html",
    tab_command_bridge:"גשר הפיקוד",
    tab_intelligence_hq:"מטה המודיעין",
    tab_sharing_center:"מרכז שיתוף",
    tab_control_panel:"לוח בקרה",
    subtab_docs_info:"תיעוד ומידע",
    subtab_version_history:"היסטוריית גרסאות",
    subtab_diagnostics:"אבחון ותקינות",
    subtab_deployment_center:"מרכז הפצה",
    subtab_export_share:"ייצוא ושיתוף",
    subtab_manual_deploy:"הפצה ידנית",
    subtab_backup_restore:"גיבוי ושחזור",
    subtab_api_settings:"הגדרות API",
    api_key_label:"מפתח API של Gemini",
    api_key_placeholder:"הכנס מפתח API של Gemini",
    api_key_missing:"מפתח Gemini חסר. יש להגדיר בלוח הבקרה.",
    api_key_saved:"המפתח נשמר בהצלחה!",
    save_key:"שמור מפתח",
    summary_generator:"מחולל סיכומי מנהלים",
    generate_summary:"הפק סיכום",
    copy_to_clipboard:"העתק ללוח",
    copied:"הועתק!",
    proactive_insights:"תובנות פרואקטיביות ותחזיות",
    nlq_placeholder:"שאל שאלה על הנתונים...",
    daily_focus_title:"פוקוס יומי מבוסס AI",
    analyzing_data:"מנתח נתונים...",
    deployment_guide_title:"מדריך הפצה (GitHub Pages)",
    deployment_guide_step1_title:"שלב 1: שמירה והחלפה",
    deployment_guide_step1_desc:"הורד index.html חדש והחלף מקומית.",
    deployment_guide_step2_title:"שלב 2: פתיחת טרמינל וניווט",
    deployment_guide_step2_desc:"פתח טרמינל ושנה נתיב לתיקיית הפרויקט.",
    deployment_guide_step3_title:"שלב 3: העלאת שינויים ל-GitHub",
    deployment_guide_step3_desc:"הרץ git add/commit/push לפי הסדר.",
    deployment_guide_step3_li1:"הוספת קובץ מעודכן:",
    deployment_guide_step3_li2:"ביצוע Commit עם הודעה:",
    deployment_guide_step3_li3:"Push לאתר:",
    deployment_guide_step4_title:"שלב 4: וידוא עדכון",
    deployment_guide_step4_desc:"רענן את האתר ובדוק Actions במידת הצורך.",
    login_title:"ברוכים הבאים ל-Sentinel",
    login_subtitle:"בחר תפקיד והזן סיסמה",
    select_role:"בחר תפקיד",
    password:"סיסמה",
    login:"כניסה",
    login_error:"סיסמה שגויה לתפקיד הנבחר.",
    caps_lock_on:"Caps Lock פעיל",
    logout:"התנתק",
    save_data:"שמור נתונים",
    reset_data:"אפס נתונים להיום",
    data_saved_success:"הנתונים נשמרו בהצלחה!",
    data_reset_success:"דו\"ח היום אופס.",
    data_saved_error:"שגיאה בשמירת הנתונים.",
    data_reset_error:"שגיאה באיפוס הנתונים.",
    search_internet:"חפש באינטרנט"
  }
};

const LanguageContext = createContext();
const LanguageProvider = ({children})=>{
  const [language,setLanguage] = useState(()=>{
    try{ return localStorage.getItem('sentinel-lang') || 'he'; }catch(e){ return 'he'; }
  });
  useEffect(()=>{
    try{
      document.documentElement.lang = language;
      document.documentElement.dir = (language==='he'?'rtl':'ltr');
      localStorage.setItem('sentinel-lang',language);
    }catch(e){}
  },[language]);
  const toggleLanguage = ()=> setLanguage(prev => prev==='he'?'en':'he');
  const t = (key, params={})=>{
    let translation = (translations[language]?.[key]) || key;
    Object.keys(params).forEach(p=>{
      translation = translation.replace(`{${p}}`, params[p]);
    });
    return translation;
  };
  return <LanguageContext.Provider value={{language,toggleLanguage:t oggleLanguage, t}}>{children}</LanguageContext.Provider>;
};
const useTranslation = ()=> useContext(LanguageContext);

/* ============== Data + Dashboard State ============== */
const DashboardContext = createContext();

const initialReportState = {
  id:null,
  signedOrders:0,
  existingBacklog:0,
  pendingSignature:{
    'ענף גזברות':0,
    'רכש, מכרזים ולוגיסטיקה':0,
    'כספים וחשבות':0
  },
  rejectedOrders:0,
  pendingAncillaryForm:0,
  pendingCorrection:0,
  pendingAssetNumberEntry:0
};

const calculateTotals = (data)=>{
  const safe = data || initialReportState;
  const totalPendingSignature = Object.values(safe.pendingSignature||{}).reduce((a,b)=>a+(+b||0),0);
  const backlogDifference = (+safe.existingBacklog||0) - (+safe.signedOrders||0);
  const goalPercentage = (+safe.existingBacklog||0)>0 ? ((+safe.signedOrders||0) / Math.max(1,(+safe.existingBacklog||0)))*100 : 0;
  return {...safe, computedMetrics:{
    totalPending: totalPendingSignature,
    goalPercentage,
    totalPendingSignature,
    backlogDifference
  }};
};

const loadInitialState = ()=>{
  try{
    const stored = localStorage.getItem('sentinelReports');
    const allReports = stored ? JSON.parse(stored) : {};
    const lastId = localStorage.getItem('sentinelLastSavedReportId');
    let base = initialReportState;
    if(lastId && allReports[lastId]) base = allReports[lastId];
    return {
      allReports,
      currentReportId: lastId||null,
      dataForEditing: JSON.parse(JSON.stringify(base)),
      liveData: calculateTotals(base),
      previousValues: {},
      lastUpdateInfo: null,
      notifications: [],
      userRole:'user',
      isAuthenticated:false
    };
  }catch(e){
    return {
      allReports:{},
      currentReportId:null,
      dataForEditing: JSON.parse(JSON.stringify(initialReportState)),
      liveData: calculateTotals(initialReportState),
      previousValues:{},
      lastUpdateInfo:null,
      notifications:[],
      userRole:'user',
      isAuthenticated:false
    };
  }
};

function dashboardReducer(state,action){
  switch(action.type){
    case 'LOGIN_SUCCESS':
      return {...state, isAuthenticated:true, userRole:action.payload.role};
    case 'LOGOUT':
      return {...state, isAuthenticated:false, userRole:'user'};
    case 'LOAD_REPORT':{
      const {id, previousData} = action.payload;
      const existing = state.allReports[id];
      let reportData;
      if(existing){
        reportData = JSON.parse(JSON.stringify(existing));
      }else{
        const allIds = Object.keys(state.allReports).sort();
        const lastAvailId = allIds.length>0 ? allIds[allIds.length-1] : null;
        const lastAvail = lastAvailId ? state.allReports[lastAvailId] : null;
        const base = (previousData && Object.keys(previousData).length>0) ? previousData : (lastAvail || initialReportState);
        reportData = JSON.parse(JSON.stringify(base)); reportData.id = id;
      }
      return {...state,
        currentReportId:id,
        dataForEditing:reportData,
        liveData:calculateTotals(reportData),
        previousValues: previousData||{}
      };
    }
    case 'SAVE_DATA':{
      if(state.userRole!=='admin' || !state.currentReportId) return state;
      const newAll = {...state.allReports, [state.currentReportId]: state.dataForEditing};
      try{
        localStorage.setItem('sentinelReports', JSON.stringify(newAll));
        localStorage.setItem('sentinelLastSavedReportId', state.currentReportId);
      }catch(e){}
      return {...state, allReports:newAll, lastUpdateInfo:{ time:new Date().toLocaleString('he-IL') }};
    }
    case 'RESET_TODAY_DATA':{
      if(state.userRole!=='admin' || !state.currentReportId) return state;
      const newAll = {...state.allReports, [state.currentReportId]: JSON.parse(JSON.stringify(initialReportState))};
      try{ localStorage.setItem('sentinelReports', JSON.stringify(newAll)); }catch(e){}
      return {...state,
        allReports:newAll,
        dataForEditing: JSON.parse(JSON.stringify(initialReportState)),
        liveData: calculateTotals(initialReportState),
        lastUpdateInfo:{ time:new Date().toLocaleString('he-IL') }
      };
    }
    case 'UPDATE_EDITING_FIELD':{
      if(state.userRole!=='admin') return state;
      const {fieldPath,value} = action.payload;
      const newState = JSON.parse(JSON.stringify(state));
      let current = newState.dataForEditing;
      const parts = fieldPath.split('.');
      for(let i=0;i<parts.length-1;i++){
        if(typeof current[parts[i]]!=='object' || current[parts[i]]===null) current[parts[i]] = {};
        current = current[parts[i]];
      }
      current[parts[parts.length-1]] = (+value||0);
      newState.liveData = calculateTotals(newState.dataForEditing);
      return newState;
    }
    case 'ADD_NOTIFICATION':
      if(state.notifications.some(n=>n.text===action.payload.text)) return state;
      return {...state, notifications:[action.payload, ...state.notifications]};
    default: return state;
  }
}

const DashboardProvider = ({children})=>{
  const [state,dispatch] = useReducer(dashboardReducer, loadInitialState());
  return <DashboardContext.Provider value={{state,dispatch}}>{children}</DashboardContext.Provider>;
};

/* ============== Versioning & Cards ============== */
const versionHistory = [
  {version:24.1, date:'02/09/2025', description:"רציפות נתונים מלאה, גיבוי/שחזור פשוטים, מדריך הפצה מובנה."},
  {version:23.1, date:'02/09/2025', description:"תיקון CLS, שדרוג עלון ההפעלה."},
  {version:23.0, date:'02/09/2025', description:"ליבת נתונים יציבה, צ'אט AI נשלט ידנית, ותובנות פרואקטיביות."},
  {version:22.3, date:'02/09/2025', description:"ייצוב קריסה ואיחוד לקובץ יחיד."}
];

const cardDefinitions = {
  overallStatus: { titleKey:'card_title_overallStatus', color:'teal', icon:'fa-tachometer-alt' },
  signedOrders: { titleKey:'card_title_signedOrders', color:'teal', icon:'fa-check-double' },
  pendingSignature: { titleKey:'card_title_pendingSignature', color:'purple', icon:'fa-signature' },
  rejectedOrders: { titleKey:'card_title_rejectedOrders', subtitleKey:'card_subtitle_rejectedOrders', color:'red', icon:'fa-times-circle' },
  pendingAncillaryForm: { titleKey:'card_title_pendingAncillaryForm', subtitleKey:'card_subtitle_pendingAncillaryForm', color:'orange', icon:'fa-file-alt' },
  pendingCorrection: { titleKey:'card_title_pendingCorrection', subtitleKey:'card_subtitle_pendingCorrection', color:'blue', icon:'fa-edit' },
  pendingAssetNumberEntry: { titleKey:'card_title_pendingAssetNumberEntry', subtitleKey:'card_subtitle_pendingAssetNumberEntry', color:'yellow', icon:'fa-barcode' }
};

/* ============== AI Calls (safe, opt-in) ============== */
async function callGeminiAPI(prompt, t, showMessage, jsonSchema=null, useGrounding=false){
  const apiKey = (()=>{
    try{ return localStorage.getItem('sentinel-apiKey') || '' }catch(e){ return '' }
  })();
  if(!apiKey){
    const msg = t('api_key_missing');
    if(showMessage) showMessage(msg, true);
    return jsonSchema ? JSON.stringify({answer:msg, chartData:null}) : msg;
  }
  const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
  const payload = {
    contents:[{parts:[{text:prompt}]}]
  };
  if(jsonSchema){
    payload.generationConfig = {
      responseMimeType: "application/json",
      responseSchema: jsonSchema
    };
  }
  if(useGrounding){
    payload.tools = [{googleSearch:{}}];
  }
  try{
    const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    if(!res.ok){
      let err = '';
      try{ const eb = await res.json(); err = (eb?.error?.message)||'' }catch(e){}
      throw new Error(`HTTP ${res.status} ${err}`);
    }
    const result = await res.json();
    const text = result?.candidates?.?.content?.parts?.?.text;
    if(!text) throw new Error('Invalid response structure');
    return text;
  }catch(err){
    const msg = `שגיאת AI: ${err.message}`;
    if(showMessage) showMessage(msg, true);
    return jsonSchema ? JSON.stringify({answer:msg, chartData:null}) : msg;
  }
}

/* ============== App Shell ============== */
const App = ()=>{
  const {state} = useContext(DashboardContext);
  const {language} = useTranslation();
  if(!state.isAuthenticated) return <LoginScreen key={language} />;
  return <MainDashboard key={language} />;
};

/* ============== Login ============== */
const LoginScreen = ()=>{
  const {dispatch} = useContext(DashboardContext);
  const {t, language, toggleLanguage} = useTranslation();
  const [role,setRole] = useState('user');
  const [password,setPassword] = useState('');
  const [error,setError] = useState('');
  const [isLoading,setIsLoading] = useState(false);
  const [isPasswordVisible,setIsPasswordVisible] = useState(false);
  const [isCapsOn,setIsCapsOn] = useState(false);

  const passwords = { user:'57919021', admin:'Myosy2002' };

  const handleLogin = (e)=>{
    e.preventDefault();
    setIsLoading(true); setError('');
    setTimeout(()=>{
      if(passwords[role]===password){
        dispatch({type:'LOGIN_SUCCESS', payload:{role}});
      }else{
        setError(t('login_error'));
      }
      setIsLoading(false);
    },700);
  };
  const checkCapsLock = (e)=>{
    if(e.getModifierState) setIsCapsOn(e.getModifierState('CapsLock'));
  };

  return (
    <div className="flex items-center justify-center min-h-screen login-background">
      <div className="relative w-full max-w-md p-8 space-y-8 bg-[--bg-secondary]/80 backdrop-blur-md rounded-2xl shadow-2xl border border-teal-500/20 fade-in-on-load">
        <div className="absolute top-4 left-4 rtl:left-auto rtl:right-4">
          <button onClick={toggleLanguage} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center font-bold text-sm hover:text-[--text-primary] transition-colors" title={t('lang_toggle')}>
            {language==='he'?'EN':'HE'}
          </button>
        </div>
        <div className="text-center">
          <div className="inline-block pulsing-logo"><SystemLogo/></div>
          <h2 className="mt-6 text-3xl font-bold text-center text-[--text-primary]">{t('login_title')}</h2>
          <p className="mt-2 text-center text-sm text-teal-400">{t('login_subtitle')}</p>
        </div>
        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
          <div className="relative">
            <select value={role} onChange={e=>setRole(e.target.value)} className="w-full p-3 bg-[--bg-primary]/70 border-2 border-[--border-color] rounded-md appearance-none text-[--text-primary] focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all">
              <option className="text-black" value="user">{t('user')}</option>
              <option className="text-black" value="admin">{t('admin')}</option>
            </select>
            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-[--text-secondary]"><i className="fas fa-chevron-down"></i></div>
          </div>
          <div className="relative">
            <button type="button" onClick={()=>setIsPasswordVisible(v=>!v)} className="absolute top-3.5 left-3 text-[--text-secondary] hover:text-teal-400 transition-colors z-10"><i className={`fas ${isPasswordVisible?'fa-eye-slash':'fa-eye'}`}></i></button>
            <input type={isPasswordVisible?'text':'password'} value={password} onChange={e=>setPassword(e.target.value)} onKeyUp={checkCapsLock} onKeyDown={checkCapsLock} placeholder={t('password')} className="w-full p-3 pl-10 bg-[--bg-primary]/70 border-2 border-[--border-color] rounded-md text-[--text-primary] placeholder:text-[--text-secondary] focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all" required />
          </div>
          {isCapsOn && <p className="text-xs text-yellow-400 text-center flex items-center justify-center gap-2"><i className="fas fa-exclamation-circle"></i> {t('caps_lock_on')}</p>}
          {error && <p className="text-sm text-red-400 text-center">{error}</p>}
          <div>
            <button type="submit" disabled={isLoading} className="group relative w-full flex justify-center py-3 px-4 rounded-md text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 disabled:opacity-50 transition-all transform hover:scale-105 active:scale-100">
              {isLoading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : t('login')}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

/* ============== Main Dashboard ============== */
const MainDashboard = ()=>{
  const {state,dispatch} = useContext(DashboardContext);
  const userRole = state.userRole;
  const {t,language} = useTranslation();

  const [reportDate,setReportDate] = useState(()=>{
    try{
      const last = localStorage.getItem('sentinelLastSavedReportId');
      if(last){ const p = last.split('-'); if(p.length>=3){ const d = p.slice(0,3).join('-'); if(!isNaN(new Date(d).getTime())) return d; } }
    }catch(e){}
    return new Date().toISOString().split('T');
  });

  const [currentReportType,setCurrentReportType] = useState(()=>{
    try{
      const last = localStorage.getItem('sentinelLastSavedReportId');
      if(last){ const p = last.split('-'); if(p.length>=4) return p; }[1]
    }catch(e){}
    return 'morning';
  });

  useEffect(()=>{
    const id = `${reportDate}-${currentReportType}`;
    const prevId = (()=>{
      const d = new Date(reportDate);
      if(currentReportType==='daily') return `${reportDate}-morning`;
      d.setDate(d.getDate()-1);
      return `${d.toISOString().split('T')}-daily`;
    })();
    try{
      const all = JSON.parse(localStorage.getItem('sentinelReports')||'{}');
      dispatch({type:'LOAD_REPORT', payload:{id, previousData: all[prevId] || {}}});
    }catch(e){
      dispatch({type:'LOAD_REPORT', payload:{id, previousData:{}}});
    }
  },[reportDate, currentReportType, dispatch]);

  const [message,setMessage] = useState({text:'', isError:false, visible:false});
  const [theme,setTheme] = useState(()=>{ try{ return localStorage.getItem('sentinel-theme') || 'theme-dark' }catch(e){ return 'theme-dark' }});
  const [activeModal,setActiveModal] = useState(null);
  const [activeTab,setActiveTab] = useState('command_bridge');
  const [activeControlPanelTab,setActiveControlPanelTab] = useState('backup_restore');
  const [isAiGenerating,setIsAiGenerating] = useState(false);
  const infographicContainerRef = useRef(null);

  // Apply theme on mount
  useEffect(()=>{
    try{
      const saved = localStorage.getItem('sentinel-theme') || 'theme-dark';
      setTheme(saved);
      const html = document.documentElement;
      const body = document.body;
      html.classList.remove('light','dark');
      body.classList.remove('theme-light','theme-dark');
      const isDark = saved==='theme-dark';
      html.classList.add(isDark?'dark':'light');
      body.classList.add(saved);
    }catch(e){}
  },[]);

  useEffect(()=>{ document.title = t('app_title'); },[t]);

  useEffect(()=>{
    let timer;
    if(message.visible) timer = setTimeout(()=>setMessage(m=>({...m,visible:false})), 4000);
    return ()=> clearTimeout(timer);
  },[message]);

  const showMessage = useCallback((text, isError=false)=> setMessage({text,isError,visible:true}),[]);

  const toggleTheme = ()=>{
    try{
      const old = theme;
      const next = theme==='theme-dark' ? 'theme-light' : 'theme-dark';
      setTheme(next); localStorage.setItem('sentinel-theme', next);
      const html = document.documentElement;
      const body = document.body;
      html.classList.remove(old==='theme-dark'?'dark':'light');
      body.classList.remove(old);
      html.classList.add(next==='theme-dark'?'dark':'light');
      body.classList.add(next);
    }catch(e){}
  };

  const getFormattedFileName = (ext)=>{
    const now = new Date();
    const date = now.toISOString().split('T');
    const time = now.toTimeString().split(' ').replace(/:/g,'-');
    return `Project-Sentinel-Command-Nexus-v24.1-${date}-${time}.${ext}`;
    };

  const handleExport = async ()=>{
    const el = infographicContainerRef.current;
    if(!el){ showMessage("שגיאה: אלמנט לא נמצא", true); return; }
    showMessage("מכין ייצוא...");
    try{
      // freeze animations
      const prevChartAnim = Chart.defaults.animation;
      Chart.defaults.animation = false;
      const prevBodyAnim = document.body.style.animation;
      document.body.style.animation = 'none';

      const canvas = await html2canvas(el, {
        backgroundColor: document.body.classList.contains('theme-dark') ? '#0f172a' : '#f1f5f9',
        scale:2, useCORS:true, logging:false, windowWidth: el.scrollWidth, windowHeight: el.scrollHeight
      });
      const fileName = getFormattedFileName('png');
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png'); link.download = fileName; link.click();

      // restore
      Chart.defaults.animation = prevChartAnim;
      document.body.style.animation = prevBodyAnim;
    }catch(e){
      showMessage("שגיאה ביצירת הקובץ.", true);
    }
  };

  const handleDateChange = (days)=>{
    const d = new Date(reportDate);
    d.setDate(d.getDate()+days);
    setReportDate(d.toISOString().split('T'));
  };

  const handleShareLink = ()=>{
    try{
      const ta = document.createElement('textarea');
      ta.value = window.location.href;
      document.body.appendChild(ta); ta.focus(); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      showMessage("הקישור הועתק ללוח!");
    }catch(e){ showMessage("שגיאה בהעתקת הקישור.", true); }
  };

  const handleSaveData = ()=>{
    dispatch({type:'SAVE_DATA'});
    showMessage(t('data_saved_success'));
    setIsAiGenerating(true);
  };
  const handleResetData = ()=>{
    dispatch({type:'RESET_TODAY_DATA'});
    showMessage(t('data_reset_success'));
  };

  const TabNavigation = ()=>(
    <div className="flex p-1 space-x-1 rtl:space-x-reverse bg-[--bg-secondary] rounded-xl shadow-lg border border-[--border-color]">
      <button className={`w-full py-2.5 text-sm font-medium rounded-lg flex items-center justify-center gap-2 transition-all ${activeTab==='command_bridge'?'bg-teal-500 text-white shadow':''} ${activeTab!=='command_bridge'?'text-[--text-secondary] hover:bg-[--bg-tertiary]':''}`} onClick={()=>setActiveTab('command_bridge')}>
        <i className="fas fa-tachometer-alt"></i> {t('tab_command_bridge')}
      </button>
      <button className={`w-full py-2.5 text-sm font-medium rounded-lg flex items-center justify-center gap-2 transition-all ${activeTab==='intelligence_hq'?'bg-teal-500 text-white shadow':''} ${activeTab!=='intelligence_hq'?'text-[--text-secondary] hover:bg-[--bg-tertiary]':''}`} onClick={()=>setActiveTab('intelligence_hq')}>
        <i className="fas fa-brain"></i> {t('tab_intelligence_hq')}
      </button>
      <button class

[1](https://stackoverflow.com/questions/57787209/safari-does-not-support-indexeddb-databases)
[2](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/71936845/fe3bba45-0852-4980-abb0-5c944865e858/paste-2.txt)