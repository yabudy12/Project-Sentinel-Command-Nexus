<!DOCTYPE html>
<html lang="he" dir="rtl" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Project Sentinel v24.1 | Stable & Feature Complete</title>
  <meta name="theme-color" content="#0f172a" />

  <!-- External Libraries -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" as="style">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap');

    :root {
      --status-good-primary: #2dd4bf; --status-good-secondary: #14b8a6; --status-good-glow: rgba(45, 212, 191, 0.5);
      --status-warning-primary: #3b82f6; --status-warning-secondary: #2563eb; --status-warning-glow: rgba(59, 130, 246, 0.5);
      --status-critical-primary: #f87171; --status-critical-secondary: #ef4444; --status-critical-glow: rgba(248, 113, 113, 0.5);
      --status-purple-primary: #a78bfa; --status-purple-secondary: #8b5cf6; --status-purple-glow: rgba(167, 139, 250, 0.5);
      --status-orange-primary: #fb923c; --status-orange-secondary: #f97316; --status-orange-glow: rgba(251, 146, 60, 0.5);
      --status-yellow-primary: #facc15; --status-yellow-secondary: #eab308; --status-yellow-glow: rgba(250, 204, 21, 0.5);
    }

    body {
      font-family: 'Heebo', sans-serif;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    .theme-dark {
      --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-tertiary: #334155;
      --text-primary: #e2e8f0; --text-secondary: #94a3b8; --border-color: #334155;
    }
    .theme-light {
      --bg-primary: #f1f5f9; --bg-secondary: #ffffff; --bg-tertiary: #e2e8f0;
      --text-primary: #0f172a; --text-secondary: #475569; --border-color: #e2e8f0;
    }

    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--status-good-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .skeleton-loader { position: relative; overflow: hidden; background-color: var(--bg-tertiary); }
    .skeleton-loader::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); animation: skeleton-loading 1.5s infinite; }
    @keyframes skeleton-loading { 0% { transform: translateX(-100%);} 100% { transform: translateX(100%);} }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
    .fade-in-on-load { animation: fadeIn 0.5s ease-out forwards; }

    @keyframes radar-sweep { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg);} }

    .login-background {
      background-size: 200% 200%;
      background-image: radial-gradient(circle at 10% 20%, rgb(15, 23, 42) 0%, rgb(30, 41, 59) 90%);
      animation: background-pan 20s linear infinite;
    }
    @keyframes background-pan {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .pulsing-logo { animation: pulse 4s ease-in-out infinite; }
    @keyframes pulse { 0%,100% { transform: scale(1); filter: drop-shadow(0 0 5px var(--status-good-glow)); } 50% { transform: scale(1.05); filter: drop-shadow(0 0 15px var(--status-good-glow)); } }
  </style>
</head>
<body class="theme-dark">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useReducer, createContext, useContext, useMemo } = React;

    // Translations (HE/EN)
    const translations = {
      en: {
        app_title: "Project Sentinel v24.1 | Stable & Feature Complete",
        classification: "Classification: Unclassified",
        main_header: "Project Sentinel - Command Nexus",
        motto: "Eyes on the Horizon, Grip on the Command: Absolute Control, Decisive Action",
        morning_report: "Morning Report",
        daily_report: "Daily Report",
        report_date: "Report Date:",
        control_panel: "Control Panel",
        export_share: "Export & Share",
        share_link: "Share Link",
        share_whatsapp: "Share via WhatsApp",
        export_png: "Export PNG",
        backup_data: "Backup Data",
        backup_code: "Backup Source Code",
        backup_png: "Backup Command Bridge (PNG)",
        diagnostics: "Diagnostics & Health",
        run_bit: "Run Integration Tests",
        theme_toggle: "Toggle Theme",
        lang_toggle: "Change Language",
        version_history: "Version History",
        signed_orders_kpi: "Total Signed",
        backlog_gap_kpi: "Backlog Gap",
        pending_orders_kpi: "Pending Signatures",
        rejected_orders_kpi: "Total Rejected",
        ai_insights_title: "AI Analytical HQ",
        anomaly_detected: "Anomaly Detected!",
        anomaly_desc: "Unusually high number of rejected orders detected today (+25% vs 7-day average).",
        analyze_anomaly: "Analyze Anomaly",
        scenario_engine_title: "Strategic Advisor",
        staff_members: "Number of Staff:",
        processing_rate: "Processing Rate (orders/day/staff):",
        set_goal: "Set Goal: Clear pending in",
        days: "days",
        get_action_plan: "Get Action Plan",
        smart_assistant_title: "Smart Analytical Assistant",
        ask: "Ask",
        thinking: "Thinking... ",
        analytical_brain_title: "Interactive Analytical HQ",
        scroll_up: "Scroll Up",
        scroll_down: "Scroll Down",
        bit_results_title: "BIT Results",
        bit_report_summary_ok: "System integrity check passed. All components are operating as expected.",
        bit_report_summary_fail: "System integrity check found issues. Review details below.",
        bit_check_code: "Code Integrity (Hash Check)",
        bit_check_functionality: "Functionality (UI Events)",
        bit_check_ui: "UI/UX Consistency",
        bit_check_api: "API Connectivity",
        pass: "Pass",
        fail: "Fail",
        user_role: "User Role:",
        admin: "Admin",
        user: "User",
        card_title_overallStatus: "Overall Status",
        card_title_signedOrders: "Order Backlog - Desired vs. Actual",
        card_title_pendingSignature: "Signature Process (Pending)",
        card_title_rejectedOrders: "Rejected Orders",
        card_subtitle_rejectedOrders: "(Responsibility: Project Manager vs. Budget)",
        card_title_pendingAncillaryForm: "Pending Ancillary Form",
        card_subtitle_pendingAncillaryForm: "(Responsibility: Tech Budget Manager)",
        card_title_pendingCorrection: "Pending Correction",
        card_subtitle_pendingCorrection: "(Responsibility: Project Manager vs. Budget)",
        card_title_pendingAssetNumberEntry: "Pending Asset Number",
        card_subtitle_pendingAssetNumberEntry: "(Responsibility: Buyer & QA)",
        last_updated: "Last Updated: {time}",
        deployment_center: "Deployment Center",
        system_file_export: "System File Export (Manual Backup)",
        export_html: "Export index.html",
        tab_command_bridge: "Command Bridge",
        tab_intelligence_hq: "Intelligence HQ",
        tab_sharing_center: "Sharing Center",
        tab_control_panel: "Control Panel",
        subtab_docs_info: "Documentation & Info",
        subtab_version_history: "Version History",
        subtab_diagnostics: "Diagnostics",
        subtab_deployment_center: "Deployment Center",
        subtab_export_share: "Export & Share",
        subtab_manual_deploy: "Manual Deployment",
        subtab_backup_restore: "Backup & Restore",
        subtab_api_settings: "API Settings",
        api_key_label: "Gemini API Key",
        api_key_placeholder: "Enter your Gemini API key here",
        api_key_missing: "Gemini API key is not configured. Please add it in the Control Panel.",
        api_key_saved: "API Key saved successfully!",
        save_key: "Save Key",
        summary_generator: "Executive Summary Generator",
        generate_summary: "Generate Summary",
        copy_to_clipboard: "Copy to Clipboard",
        copied: "Copied!",
        proactive_insights: "Proactive Insights & Forecasts",
        nlq_placeholder: "Ask a question about the data...",
        daily_focus_title: "AI Daily Focus",
        analyzing_data: "Analyzing data...",
        login_title: "Welcome to Sentinel",
        login_subtitle: "Please select your role and enter the password to continue",
        select_role: "Select Role",
        password: "Password",
        login: "Login",
        login_error: "Invalid password for the selected role.",
        caps_lock_on: "Caps Lock is on",
        logout: "Log Off",
        save_data: "Save Data",
        reset_data: "Reset Data for Today",
        data_saved_success: "Data saved successfully!",
        data_reset_success: "Today's report has been reset.",
        data_saved_error: "Error saving data.",
        data_reset_error: "Error resetting data.",
        search_internet: "Search Internet"
      },
      he: {
        app_title: "Project Sentinel v24.1 | Stable & Feature Complete",
        classification: "专转 住: \"住",
        main_header: "Project Sentinel - Command Nexus",
        motto: "Eyes on the Horizon, Grip on the Command: Absolute Control, Decisive Action",
        morning_report: "\" 拽专",
        daily_report: "\" ",
        report_date: "转专 \":",
        control_panel: " 拽专",
        export_share: "爪 砖转祝",
        share_link: "砖转祝 拽砖专",
        share_whatsapp: "砖转祝 住驻",
        export_png: "爪 转 (PNG)",
        backup_data: " 转",
        backup_code: " 拽 拽专",
        backup_png: " 转转 驻拽 (PNG)",
        diagnostics: " 转拽转",
        run_bit: "专抓 拽转 专爪",
        theme_toggle: "砖 注专转 砖",
        lang_toggle: "砖 砖驻",
        version_history: "住专转 专住转",
        signed_orders_kpi: "住\" 转转",
        backlog_gap_kpi: "驻注专 爪专",
        pending_orders_kpi: "转转 转",
        rejected_orders_kpi: "住\" 转",
        ai_insights_title: "  住住 AI",
        anomaly_detected: "转 !",
        anomaly_desc: " 住驻专  专 砖 转 转  (注 砖 25% 注转 爪注 7 ).",
        analyze_anomaly: "转 ",
        scenario_engine_title: "注抓 住专",
        staff_members: "住驻专 砖 爪转:",
        processing_rate: "拽爪 驻 (转 /爪转):",
        set_goal: "专 注: 住 转转 转",
        days: "",
        get_action_plan: "拽 转转 驻注",
        smart_assistant_title: "注专  ",
        ask: "砖",
        thinking: "砖... ",
        analytical_brain_title: "\"  专拽",
        scroll_up: " 注",
        scroll_down: " ",
        bit_results_title: "转爪转 拽转 BIT",
        bit_report_summary_ok: "拽转 转拽转 注专转 注专 爪.  专 驻注 爪驻.",
        bit_report_summary_fail: "拽转 转拽转 注专转 转 注转. 砖 注 驻专.",
        bit_check_code: "砖转 拽 (拽转 Hash)",
        bit_check_functionality: "驻拽爪转 (专注 UI)",
        bit_check_ui: "UI/UX 注拽",
        bit_check_api: "拽砖专转 API",
        pass: "转拽",
        fail: "砖",
        user_role: "转驻拽 砖转砖:",
        admin: " 注专转",
        user: "砖转砖",
        card_title_overallStatus: "爪 ",
        card_title_signedOrders: "爪专 转 - 专爪  爪",
        card_title_pendingSignature: "转 转转 (转转)",
        card_title_rejectedOrders: "转 转",
        card_subtitle_rejectedOrders: "(专转 \"驻  转拽爪)",
        card_title_pendingAncillaryForm: "转转 驻住 ",
        card_subtitle_pendingAncillaryForm: "(专转 转拽爪 )",
        card_title_pendingCorrection: "转转 转拽",
        card_subtitle_pendingCorrection: "(专转 \"驻  转拽爪)",
        card_title_pendingAssetNumberEntry: "转转 住驻专 住",
        card_subtitle_pendingAssetNumberEntry: "(专转 拽 拽专 转)",
        last_updated: "注 专: {time}",
        deployment_center: "专 驻爪",
        system_file_export: "爪 拽爪 注专转 ( )",
        export_html: "爪 index.html",
        tab_command_bridge: "砖专 驻拽",
        tab_intelligence_hq: " 注",
        tab_sharing_center: "专 砖转祝",
        tab_control_panel: " 拽专",
        subtab_docs_info: "转注 注",
        subtab_version_history: "住专转 专住转",
        subtab_diagnostics: " 转拽转",
        subtab_deployment_center: "专 驻爪",
        subtab_export_share: "爪 砖转祝",
        subtab_manual_deploy: "驻爪 转",
        subtab_backup_restore: " 砖专",
        subtab_api_settings: "专转 API",
        api_key_label: "驻转 API 砖 Gemini",
        api_key_placeholder: "  转 驻转 -API 砖",
        api_key_missing: "驻转 API 砖 Gemini  专. 砖 住祝 转  拽专.",
        api_key_saved: "驻转 API 砖专 爪!",
        save_key: "砖专 驻转",
        summary_generator: " 住 ",
        generate_summary: "驻拽 住",
        copy_to_clipboard: "注转拽 ",
        copied: "注转拽!",
        proactive_insights: "转转 驻专拽转 转转",
        nlq_placeholder: "砖 砖 注 转...",
        daily_focus_title: "驻拽住  住住 AI",
        analyzing_data: "转 转...",
        login_title: "专  Sentinel",
        login_subtitle: " 专 转驻拽  住住  砖",
        select_role: "专 转驻拽",
        password: "住住",
        login: "住",
        login_error: "住住 砖 注专 转驻拽 砖专.",
        caps_lock_on: "Caps Lock 驻注",
        logout: "转转拽",
        save_data: "砖专 转",
        reset_data: "驻住 转 ",
        data_saved_success: "转 砖专 爪!",
        data_reset_success: "\"  驻住.",
        data_saved_error: "砖 砖专转 转.",
        data_reset_error: "砖 驻住 转.",
        search_internet: "驻砖 专"
      }
    };

    // Language context
    const LanguageContext = createContext();
    const LanguageProvider = ({ children }) => {
      const [language, setLanguage] = useState(() => {
        try { return localStorage.getItem('sentinel-lang') || 'he'; }
        catch { return 'he'; }
      });
      useEffect(() => {
        try {
          document.documentElement.lang = language;
          document.documentElement.dir = language === 'he' ? 'rtl' : 'ltr';
          localStorage.setItem('sentinel-lang', language);
        } catch {}
      }, [language]);
      const toggleLanguage = () => setLanguage(prev => prev === 'he' ? 'en' : 'he');
      const t = (key, params = {}) => {
        let s = (translations[language]?.[key]) || key;
        Object.keys(params).forEach(p => { s = s.replace(`{${p}}`, params[p]); });
        return s;
      };
      return (
        <LanguageContext.Provider value={{language,toggleLanguage:tog toggleLanguage,t:t}}>
          {children}
        </LanguageContext.Provider>
      );
    };
    const useTranslation = () => useContext(LanguageContext);

    // Data + Dashboard State
    const DashboardContext = createContext();
    const initialReportState = {
      id: null,
      signedOrders: 0,
      existingBacklog: 0,
      pendingSignature: { '注祝 专转': 0, '专砖, 专 住拽': 0, '住驻 砖转': 0 },
      rejectedOrders: 0,
      pendingAncillaryForm: 0,
      pendingCorrection: 0,
      pendingAssetNumberEntry: 0
    };
    const calculateTotals = (data) => {
      if (!data) return {...initialReportState, computedMetrics:{ totalPending:0, goalPercentage:0, totalPendingSignature:0, backlogDifference:0 }};
      const totalPendingSignature = Object.values(data.pendingSignature||{}).reduce((a,b)=>a+b,0);
      const totalPending = totalPendingSignature;
      const backlogDifference = (data.existingBacklog||0) - (data.signedOrders||0);
      const goalPercentage = (data.existingBacklog||0) > 0 ? (data.signedOrders||0)/(data.existingBacklog||1)*100 : 0;
      return {...data, computedMetrics:{ totalPending, goalPercentage, totalPendingSignature, backlogDifference }};
    };
    const loadInitialState = () => {
      try {
        const storedReports = localStorage.getItem('sentinelReports');
        const allReports = storedReports ? JSON.parse(storedReports) : {};
        const lastReportId = localStorage.getItem('sentinelLastSavedReportId');
        let initialData = initialReportState;
        if (lastReportId && allReports[lastReportId]) initialData = allReports[lastReportId];
        return {
          allReports,
          currentReportId: lastReportId || null,
          dataForEditing: JSON.parse(JSON.stringify(initialData)),
          liveData: calculateTotals(initialData),
          previousValues: {},
          lastUpdateInfo: null,
          notifications: [],
          userRole: 'user',
          isAuthenticated: false
        };
      } catch {
        return {
          allReports:{},
          currentReportId:null,
          dataForEditing: JSON.parse(JSON.stringify(initialReportState)),
          liveData: calculateTotals(initialReportState),
          previousValues:{},
          lastUpdateInfo:null,
          notifications:[],
          userRole:'user',
          isAuthenticated:false
        };
      }
    };

    function dashboardReducer(state, action){
      switch(action.type){
        case 'LOGIN_SUCCESS':
          return {...state, isAuthenticated:true, userRole: action.payload.role };
        case 'LOGOUT':
          return {...state, isAuthenticated:false, userRole:'user' };
        case 'LOAD_REPORT':{
          const {id, previousData} = action.payload;
          const existingReportData = state.allReports[id];
          let reportData;
          if (existingReportData){
            reportData = JSON.parse(JSON.stringify(existingReportData));
          } else {
            const allIds = Object.keys(state.allReports).sort();
            const lastId = allIds.length ? allIds[allIds.length-1] : null;
            const lastDoc = lastId ? state.allReports[lastId] : null;
            const base = (previousData && Object.keys(previousData).length>0) ? previousData : (lastDoc || initialReportState);
            reportData = JSON.parse(JSON.stringify(base));
            reportData.id = id;
          }
          return {...state, currentReportId:id, dataForEditing:reportData, liveData:calculateTotals(reportData), previousValues: previousData || {} };
        }
        case 'SAVE_DATA':{
          if (state.userRole!=='admin' || !state.currentReportId) return state;
          const newAllReports = {...state.allReports, [state.currentReportId]: state.dataForEditing};
          try{
            localStorage.setItem('sentinelReports', JSON.stringify(newAllReports));
            localStorage.setItem('sentinelLastSavedReportId', state.currentReportId);
          }catch{}
          return {...state, allReports:newAllReports, lastUpdateInfo:{ time: new Date().toLocaleString('he-IL') }};
        }
        case 'RESET_TODAY_DATA':{
          if (state.userRole!=='admin' || !state.currentReportId) return state;
          const newAllReports = {...state.allReports, [state.currentReportId]: JSON.parse(JSON.stringify(initialReportState))};
          try{ localStorage.setItem('sentinelReports', JSON.stringify(newAllReports)); }catch{}
          return {...state, allReports:newAllReports, dataForEditing: JSON.parse(JSON.stringify(initialReportState)), liveData:calculateTotals(initialReportState), lastUpdateInfo:{time:new Date().toLocaleString('he-IL')}};
        }
        case 'UPDATE_EDITING_FIELD':{
          if (state.userRole!=='admin') return state;
          const {fieldPath,value} = action.payload;
          const newState = JSON.parse(JSON.stringify(state));
          let current = newState.dataForEditing;
          const parts = fieldPath.split('.');
          for (let i=0;i<parts.length-1;i++){
            if (!current[parts[i]]) current[parts[i]] = {};
            current = current[parts[i]];
          }
          current[parts[parts.length-1]] = value;
          newState.liveData = calculateTotals(newState.dataForEditing);
          return newState;
        }
        case 'ADD_NOTIFICATION':
          if (state.notifications.some(n=>n.text===action.payload.text)) return state;
          return {...state, notifications:[action.payload, ...state.notifications]};
        default:
          return state;
      }
    }

    const DashboardProvider = ({children})=>{
      const [state, dispatch] = useReducer(dashboardReducer, loadInitialState());
      return <DashboardContext.Provider value={{state,dispatch}}>{children}</DashboardContext.Provider>;
    };

    // UI Blocks
    const SystemLogo = ({ mirrored=false }) => (
      <div className={`relative w-16 h-16 ${mirrored? 'transform -scale-x-100':''}`}>
        <svg viewBox="0 0 100 100" className="w-full h-full">
          <path d="M 10 50 Q 50 20 90 50 Q 50 80 10 50 Z" fill="none" stroke="var(--status-good-primary)" strokeWidth="3"/>
          <circle cx="50" cy="50" r="10" fill="var(--status-good-primary)"/>
          <defs>
            <linearGradient id="radar-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color: var(--status-good-glow); stop-opacity: 0"/>
              <stop offset="100%" style="stop-color: var(--status-good-glow); stop-opacity: 0.7"/>
            </linearGradient>
          </defs>
          <path d="M 50 50 L 90 50 A 40 40 0 0 1 50 10 Z" fill="url(#radar-gradient)" style="transform-origin: 50% 50%; animation: radar-sweep 3s linear infinite"/>
        </svg>
      </div>
    );

    const Clock = ()=>{
      const [time,setTime]=useState(new Date());
      useEffect(()=>{
        const id=setInterval(()=>setTime(new Date()),1000);
        return ()=>clearInterval(id);
      },[]);
      return (
        <div className="text-lg font-semibold text-slate-400 tabular-nums">
          <span>{time.toLocaleDateString('he-IL')}</span>
          <span className="mx-2">|</span>
          <span>{time.toLocaleTimeString('he-IL')}</span>
        </div>
      );
    };

    const AnimatedNumber = ({n})=>{
      const [num,setNum]=useState(0);
      useEffect(()=>{
        const end = n||0;
        if (num===end) return;
        const frameDuration = 1000/60;
        const totalFrames = Math.round(1000/frameDuration);
        let frame=0;
        const counter=setInterval(()=>{
          frame++;
          const progress = frame/totalFrames;
          setNum(Math.round(end*progress));
          if (frame===totalFrames){ clearInterval(counter); setNum(end); }
        },frameDuration);
        return ()=>clearInterval(counter);
      },[n]);
      return <span>{num}</span>;
    };

    // API call: Gemini (optional with local key)
    async function callGeminiAPI(prompt, t, showMessage, jsonSchema=null, useGrounding=false){
      const apiKey = localStorage.getItem('sentinel-apiKey');
      if (!apiKey){
        const msg = t('api_key_missing');
        if (showMessage) showMessage(msg,true);
        return jsonSchema ? JSON.stringify({answer:msg,chartData:null}) : msg;
      }
      const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
      const payload = { contents:[{parts:[{text:prompt}]}] };
      if (jsonSchema){
        payload.generationConfig = { responseMimeType:"application/json", responseSchema: jsonSchema };
      }
      if (useGrounding){
        payload.tools = [{googleSearch:{}}];
      }
      try{
        const res = await fetch(API_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok){
          const body = await res.json().catch(()=>({}));
          throw new Error(`HTTP ${res.status}: ${body?.error?.message || 'Unknown error'}`);
        }
        const body = await res.json();
        const part = body?.candidates?.?.content?.parts?.;
        if (!part?.text) throw new Error('Invalid response shape');
        return part.text;
      }catch(err){
        const msg = `砖 转拽砖专转 注 砖专转 -AI: ${err.message}`;
        if (showMessage) showMessage(msg,true);
        return jsonSchema ? JSON.stringify({answer:msg,chartData:null}) : msg;
      }
    }

    // Components
    const TopBar = ({theme,toggleTheme})=>{
      const {language,toggleLanguage,t} = useTranslation();
      const {state,dispatch} = useContext(DashboardContext);
      const userRole = state.userRole;
      const notifications = state.notifications;
      const handleLogout = ()=>dispatch({type:'LOGOUT'});
      return (
        <div className="flex justify-between items-center mb-5">
          <div></div>
          <div className="flex items-center gap-2">
            <div className="bg-[--bg-secondary] text-[--text-primary] border border-[--border-color] rounded-full text-xs px-3 py-1 flex items-center gap-2">
              <span>{t('user_role')}</span><span className="font-bold">{t(userRole)}</span>
            </div>
            <button className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center relative hover:text-[--text-primary] transition-colors" title="转专转">
              <i className="fas fa-bell"></i>
              {notifications.length>0 && <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center">{notifications.length}</span>}
            </button>
            <button onClick={toggleLanguage} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center font-bold text-sm hover:text-[--text-primary] transition-colors" title={t('lang_toggle')}>
              {language==='he'?'EN':'HE'}
            </button>
            <button onClick={toggleTheme} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center hover:text-[--text-primary] transition-colors" title={t('theme_toggle')}>
              {theme==='theme-dark'? <i className="fas fa-sun"></i>:<i className="fas fa-moon"></i>}
            </button>
            <button onClick={handleLogout} className="w-10 h-10 rounded-full bg-[--bg-secondary] text-[--text-secondary] border border-[--border-color] flex items-center justify-center hover:text-[--text-primary] transition-colors" title={t('logout')}>
              <i className="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </div>
      );
    };

    const DashboardHeader = ({currentReportType,reportDate})=>{
      const {t,language} = useTranslation();
      return (
        <div className="text-center mb-8">
          <div className="flex justify-center items-center gap-4 mb-2">
            <SystemLogo/>
            <div>
              <h1 className="text-3xl md:text-4xl font-bold text-[--text-primary] break-words">{t('main_header')}</h1>
              <p className="text-sm text-[--text-secondary]">{t('classification')}</p>
            </div>
            <SystemLogo mirrored/>
          </div>
          <div className="flex flex-col items-center">
            <p className="text-md text-teal-300 italic">{t('motto')}</p>
            <div className="w-1/3 h-px bg-teal-500/50 mt-2"></div>
          </div>
          <p className="text-md text-[--text-secondary] mt-4">
            {currentReportType==='morning'?t('morning_report'):t('daily_report')} - {new Date(reportDate).toLocaleDateString(language==='he'?'he-IL':'en-CA')}
          </p>
        </div>
      );
    };

    const AnimatedDelta = ({value,direction,color})=>{
      if (value===undefined || direction==='neutral') return null;
      return (
        <span className={`text-xs flex items-center gap-1 ${color}`}>
          <i className={`fas fa-arrow-${direction}`}></i>{Math.abs(value)}
        </span>
      );
    };

    const KpiStrip = ()=>{
      const {state}=useContext(DashboardContext);
      const {t}=useTranslation();
      const liveData = state.liveData;
      const previous = calculateTotals(state.previousValues || {}).computedMetrics;

      const getDelta=(current,prev,allowGray=false)=>{
        if (prev===undefined || current===undefined || !state.previousValues || Object.keys(state.previousValues).length===0) return {value:undefined};
        const d = current-prev;
        const direction = d>0?'up':d<0?'down':'neutral';
        return {value:d,direction,allowGray};
      };

      const kpis = [
        {
          label: t('signed_orders_kpi'),
          value: liveData?.signedOrders||0,
          type:'good',
          delta:getDelta(liveData?.signedOrders, state.previousValues?.signedOrders,true),
          posGood:true
        },
        {
          label: t('backlog_gap_kpi'),
          value: liveData?.computedMetrics?.backlogDifference||0,
          type:'warning',
          delta:getDelta(liveData?.computedMetrics?.backlogDifference, previous?.backlogDifference),
          posGood:false
        },
        {
          label: t('pending_orders_kpi'),
          value: liveData?.computedMetrics?.totalPendingSignature||0,
          type:'warning',
          delta:getDelta(liveData?.computedMetrics?.totalPendingSignature, previous?.totalPendingSignature),
          posGood:false
        },
        {
          label: t('rejected_orders_kpi'),
          value: liveData?.rejectedOrders||0,
          type:'critical',
          delta:getDelta(liveData?.rejectedOrders, state.previousValues?.rejectedOrders),
          posGood:false
        }
      ];

      return (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-5">
          {kpis.map((k,i)=>{
            let color = 'text-gray-400';
            if (k.delta?.direction==='up') color = k.posGood?'text-teal-400':'text-red-400';
            else if (k.delta?.direction==='down') color = k.posGood?'text-red-400':'text-teal-400';
            if (k.delta?.allowGray && k.delta?.direction==='down') color='text-gray-400';
            return (
              <div key={k.label} className="bg-[--bg-secondary] p-4 rounded-xl border border-[--border-color] text-center transition-all duration-300 transform hover:scale-105 hover:shadow-lg fade-in-on-load" style={{animationDelay:`${i*100}ms`}}>
                <div className={`text-3xl font-bold flex items-center justify-center gap-2 ${k.type==='good'?'text-teal-400':k.type==='warning'?'text-blue-400':'text-red-400'}`}>
                  <AnimatedNumber n={k.value}/>
                  <AnimatedDelta value={k.delta?.value} direction={k.delta?.direction} color={color}/>
                </div>
                <div className="text-xs text-[--text-secondary] mt-1">{k.label}</div>
              </div>
            );
          })}
        </div>
      );
    };

    const NumericInputWithArrows = ({value,onChange,path,disabled,delta,isIncreaseGood=false,specialRule=null})=>{
      const intervalRef = useRef(null);
      const timeoutRef = useRef(null);
      const handleValueChange = (inc)=>{
        const current = parseInt(value,10)||0;
        const next = Math.max(0,current+inc);
        onChange(path,next);
      };
      const startPress=(inc)=>{
        handleValueChange(inc);
        timeoutRef.current=setTimeout(()=>{
          intervalRef.current=setInterval(()=>handleValueChange(inc),100);
        },500);
      };
      const stopPress=()=>{
        clearTimeout(timeoutRef.current);
        clearInterval(intervalRef.current);
      };
      let color='text-gray-400';
      if (delta?.direction==='up') color = isIncreaseGood?'text-teal-400':'text-red-400';
      else if (delta?.direction==='down') color = isIncreaseGood?'text-red-400':'text-teal-400';
      if (specialRule==='signed' && delta?.direction==='down') color='text-gray-400';
      if (specialRule==='backlog' && delta?.direction==='down') color='text-gray-400';

      return (
        <div className="flex items-center gap-2 justify-end">
          {delta && delta.value!==undefined && delta.direction!=='neutral' && (
            <span className={`text-sm flex items-center gap-1 ${color}`}>
              <i className={`fas fa-arrow-${delta.direction}`}></i>{Math.abs(delta.value)}
            </span>
          )}
          <div className="flex flex-col gap-1">
            <button className="w-8 h-8 bg-[--bg-tertiary] rounded-md flex items-center justify-center disabled:opacity-50 transition-transform transform hover:scale-110 active:scale-95"
              onClick={()=>handleValueChange(1)}
              onMouseDown={()=>startPress(1)} onMouseUp={stopPress} onMouseLeave={stopPress}
              onTouchStart={()=>startPress(1)} onTouchEnd={stopPress}
              disabled={disabled}><i className="fas fa-chevron-up"></i></button>
            <button className="w-8 h-8 bg-[--bg-tertiary] rounded-md flex items-center justify-center disabled:opacity-50 transition-transform transform hover:scale-110 active:scale-95"
              onClick={()=>handleValueChange(-1)}
              onMouseDown={()=>startPress(-1)} onMouseUp={stopPress} onMouseLeave={stopPress}
              onTouchStart={()=>startPress(-1)} onTouchEnd={stopPress}
              disabled={disabled}><i className="fas fa-chevron-down"></i></button>
          </div>
          <input className="w-20 p-2 text-2xl font-bold text-center bg-[--bg-secondary] border border-[--border-color] rounded-lg disabled:bg-[--bg-tertiary]"
            type="number" value={value}
            onChange={e=>onChange(path, parseInt(e.target.value,10)||0)}
            disabled={disabled}/>
        </div>
      );
    };

    const cardDefinitions = {
      overallStatus: { titleKey:'card_title_overallStatus', color:'teal', icon:'fa-tachometer-alt' },
      signedOrders: { titleKey:'card_title_signedOrders', color:'teal', icon:'fa-check-double' },
      pendingSignature: { titleKey:'card_title_pendingSignature', color:'purple', icon:'fa-signature' },
      rejectedOrders: { titleKey:'card_title_rejectedOrders', subtitleKey:'card_subtitle_rejectedOrders', color:'red', icon:'fa-times-circle' },
      pendingAncillaryForm: { titleKey:'card_title_pendingAncillaryForm', subtitleKey:'card_subtitle_pendingAncillaryForm', color:'orange', icon:'fa-file-alt' },
      pendingCorrection: { titleKey:'card_title_pendingCorrection', subtitleKey:'card_subtitle_pendingCorrection', color:'blue', icon:'fa-edit' },
      pendingAssetNumberEntry: { titleKey:'card_title_pendingAssetNumberEntry', subtitleKey:'card_subtitle_pendingAssetNumberEntry', color:'yellow', icon:'fa-barcode' }
    };

    const SectionCard = ({id, triggerAi, showMessage})=>{
      const {state,dispatch} = useContext(DashboardContext);
      const {t} = useTranslation();
      const dataForEditing = state.dataForEditing || initialReportState;
      const liveData = state.liveData || calculateTotals(initialReportState);
      const previousValues = state.previousValues || {};
      const userRole = state.userRole;
      const lastUpdateInfo = state.lastUpdateInfo;
      const cardId = id.replace('card-','');
      const cardInfo = cardDefinitions[cardId];

      const chartRef = useRef(null);
      const canvasRef = useRef(null);
      const theme = document.body.className;

      const [aiInsight,setAiInsight] = useState('');
      const [isInsightLoading,setIsInsightLoading] = useState(false);

      const signingOrder = ['住驻 砖转','专砖, 专 住拽','注祝 专转'];
      const departmentIcons = {
        '住驻 砖转': 'fa-file-invoice-dollar',
        '专砖, 专 住拽': 'fa-gavel',
        '注祝 专转': 'fa-stamp'
      };

      const generateCardInsight = useCallback(async ()=>{
        if (cardId!=='overallStatus' || !liveData || !previousValues || Object.keys(previousValues).length===0) return;
        setIsInsightLoading(true);
        const prompt = `转 拽爪专 转 砖 砖注转 转专  转 拽  砖驻  注专转. 拽: ${JSON.stringify(previousValues)}. : ${JSON.stringify(liveData)}.`;
        try{
          const resp = await callGeminiAPI(prompt,t,showMessage);
          setAiInsight(resp);
        }catch{
          setAiInsight('砖 驻拽转 转.');
        }finally{
          setIsInsightLoading(false);
        }
      },[cardId,liveData,previousValues,t,showMessage]);

      useEffect(()=>{
        if (triggerAi && cardId==='overallStatus') generateCardInsight();
      },[triggerAi,cardId,generateCardInsight]);

      useEffect(()=>{
        if (chartRef.current) chartRef.current.destroy();
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;

        if (cardId==='overallStatus' && liveData?.computedMetrics){
          chartRef.current = new Chart(ctx,{
            type:'bar',
            data:{
              labels:['转转','转转','转'],
              datasets:[
                {
                  label:'驻',
                  data:[previousValues.signedOrders||0, calculateTotals(previousValues).computedMetrics.totalPending||0, previousValues.rejectedOrders||0],
                  backgroundColor:'rgba(148,163,184,0.5)'
                },
                {
                  label:'专',
                  data:[liveData.signedOrders, liveData.computedMetrics.totalPending, liveData.rejectedOrders],
                  backgroundColor:['#2dd4bf','#3b82f6','#f87171']
                }
              ]
            },
            options:{
              responsive:true, maintainAspectRatio:false,
              plugins:{
                legend:{ labels:{ color: theme.includes('dark') ? '#e2e8f0' : '#0f172a' } },
                datalabels:{ color:'#fff' }
              }
            }
          });
        } else if (cardId==='pendingSignature' && dataForEditing?.pendingSignature){
          chartRef.current = new Chart(ctx,{
            type:'bar',
            data:{
              labels: signingOrder,
              datasets:[
                {
                  label:'驻',
                  data: signingOrder.map(l => previousValues?.pendingSignature?.[l]||0),
                  backgroundColor:'rgba(148,163,184,0.5)'
                },
                {
                  label:'专',
                  data: signingOrder.map(l => dataForEditing?.pendingSignature?.[l]||0),
                  backgroundColor:'#a78bfa'
                }
              ]
            },
            options:{
              responsive:true, maintainAspectRatio:false,
              plugins:{
                legend:{ labels:{ color: theme.includes('dark') ? '#e2e8f0' : '#0f172a' } },
                datalabels:{ color:'#fff' }
              }
            }
          });
        }
      },[liveData,dataForEditing,theme,cardId,previousValues]);

      const handleInputChange = (fieldPath,value)=>{
        dispatch({type:'UPDATE_EDITING_FIELD', payload:{fieldPath,value}});
      };
      const getDeltaForField = (fieldPath)=>{
        const parts = fieldPath.split('.');
        let current = dataForEditing;
        let previous = previousValues;
        for (const p of parts){
          current = current?.[p];
          previous = previous?.[p];
        }
        if (previous===undefined || current===undefined || !previousValues || Object.keys(previousValues).length===0) return {value:undefined};
        const delta = current - previous;
        const direction = delta>0?'up':delta<0?'down':'neutral';
        return {value:delta, direction};
      };

      let title = t(cardInfo.titleKey);
      if (cardId==='pendingSignature'){
        title = `${title} (${liveData?.computedMetrics?.totalPendingSignature || 0})`;
      }
      if (cardId==='signedOrders'){
        title = `${t(cardInfo.titleKey)} (${liveData?.computedMetrics?.backlogDifference || 0})`;
      }

      const renderContent = ()=>{
        if (cardId==='overallStatus'){
          return (
            <>
              <div className="h-48 mt-4"><canvas ref={canvasRef}/></div>
              {isInsightLoading ? <div className="h-6 mt-2 skeleton-loader rounded-md"></div> :
                <p className="text-sm text-center text-teal-300 mt-2 italic h-6">{aiInsight}</p>}
            </>
          );
        }
        if (cardId==='signedOrders'){
          return (
            <>
              <div className="flex justify-between items-center mb-3">
                <p>{t('signed_orders_kpi')}</p>
                <NumericInputWithArrows
                  value={dataForEditing.signedOrders}
                  onChange={handleInputChange}
                  path="signedOrders"
                  disabled={userRole!=='admin'}
                  delta={getDeltaForField("signedOrders")}
                  isIncreaseGood={true}
                  specialRule="signed"
                />
              </div>
              <div className="flex justify-between items-center mb-3">
                <p>{t('backlog_gap_kpi')}</p>
                <NumericInputWithArrows
                  value={dataForEditing.existingBacklog}
                  onChange={handleInputChange}
                  path="existingBacklog"
                  disabled={userRole!=='admin'}
                  delta={getDeltaForField("existingBacklog")}
                  isIncreaseGood={false}
                  specialRule="backlog"
                />
              </div>
              <div className="w-full h-2 bg-[--bg-tertiary] rounded-full overflow-hidden mt-2.5">
                <div className="h-full bg-teal-500 rounded-full transition-all duration-500"
                     style={{width:`${(liveData?.computedMetrics?.goalPercentage||0).toFixed(1)}%`}}></div>
              </div>
            </>
          );
        }
        if (cardId==='pendingSignature'){
          const reversed = [...signingOrder].reverse();
          return (
            <>
              <div className="h-48 mb-5"><canvas ref={canvasRef}/></div>
              <div className="space-y-3">
                {reversed.map(branch=>(
                  <div className="flex justify-between items-center" key={branch}>
                    <p className="flex items-center gap-2">
                      <i className={`fas ${departmentIcons[branch]}`}></i>{branch}
                    </p>
                    <NumericInputWithArrows
                      value={dataForEditing.pendingSignature?.[branch] || 0}
                      onChange={handleInputChange}
                      path={`pendingSignature.${branch}`}
                      disabled={userRole!=='admin'}
                      delta={getDeltaForField(`pendingSignature.${branch}`)}
                      isIncreaseGood={false}
                    />
                  </div>
                ))}
              </div>
            </>
          );
        }
        if (['rejectedOrders','pendingAncillaryForm','pendingCorrection','pendingAssetNumberEntry'].includes(cardId)){
          return (
            <div className="flex justify-center items-center h-full">
              <NumericInputWithArrows
                value={dataForEditing[cardId]||0}
                onChange={handleInputChange}
                path={cardId}
                disabled={userRole!=='admin'}
                delta={getDeltaForField(cardId)}
                isIncreaseGood={false}
              />
            </div>
          );
        }
        return <div className="text-center"> 转爪 </div

[1](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/71936845/9113c8e2-9884-4756-95df-0540b46016f4/paste.txt)